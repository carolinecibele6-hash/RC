<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&C AUTOMATIC V25</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- VISUAL OTIMIZADO PARA TV --- */
        :root { 
            --bg: #000; 
            --gold: #FFD700; 
            --panel: #111;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: #fff;
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
        }

        .hide { display: none !important; }
        
        /* HEADER */
        .header {
            height: 12vh; display: flex; align-items: center; justify-content: space-between;
            padding: 0 4vw; background: #0a0a0a; border-bottom: 2px solid #222;
        }
        .logo { font-size: 3vh; font-weight: 800; color: #fff; }
        .logo span { color: var(--gold); }

        /* --- LOGIN --- */
        #screen-login {
            height: 88vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-card {
            width: 40%; background: #151515; padding: 40px; border-radius: 10px; border: 1px solid #333;
        }
        .input-row { margin-bottom: 20px; }
        .input-row label { display: block; color: #888; margin-bottom: 5px; font-size: 14px; }
        .stb-input {
            width: 100%; height: 50px; background: #000; border: 2px solid #333; color: white;
            font-size: 20px; padding-left: 10px;
        }
        .btn-connect {
            width: 100%; height: 50px; background: var(--gold); color: black; font-weight: bold; border: none; margin-top: 10px;
        }

        /* --- DASHBOARD --- */
        #screen-dash {
            height: 88vh; display: flex; align-items: center; justify-content: center; gap: 30px;
        }
        .menu-tile {
            width: 200px; height: 200px; background: #151515; border: 2px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-tile i { font-size: 60px; margin-bottom: 10px; color: #555; }

        /* --- LISTAS --- */
        #screen-list { height: 88vh; display: flex; }
        
        .sidebar { width: 30%; height: 100%; background: #080808; overflow-y: auto; border-right: 1px solid #222; }
        .main-content { width: 70%; height: 100%; background: #000; overflow-y: auto; padding: 20px; }

        .list-item {
            padding: 15px; border-bottom: 1px solid #1a1a1a; color: #aaa; font-size: 18px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* --- PLAYER --- */
        #screen-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        #auto-play-msg {
            position: absolute; top: 20px; right: 20px; background: var(--gold); color: black;
            padding: 10px 20px; font-weight: bold; z-index: 1000; display: none;
        }

        /* --- FOCO REAL --- */
        .focused {
            border-color: var(--gold) !important;
            background: var(--gold) !important;
            color: #000 !important;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            font-weight: bold;
        }
        .focused i { color: #000 !important; }
        
        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction: column; color: var(--gold);}
    </style>
</head>
<body>

    <div id="loading" class="hide">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 50px;"></i>
        <h3 style="margin-top: 20px;">CARREGANDO...</h3>
    </div>

    <div id="auto-play-msg">PRÓXIMO EPISÓDIO EM 3s...</div>

    <div class="header">
        <div class="logo">R&C <span>AUTO</span></div>
        <div id="clock">00:00</div>
    </div>

    <div id="screen-login">
        <div class="login-card">
            <div class="input-row">
                <label>DNS (http://...)</label>
                <input type="text" id="host" class="stb-input focusable" placeholder="http://url:porta">
            </div>
            <div class="input-row">
                <label>USUÁRIO</label>
                <input type="text" id="user" class="stb-input focusable">
            </div>
            <div class="input-row">
                <label>SENHA</label>
                <input type="password" id="pass" class="stb-input focusable" onkeydown="App.checkEnterLogin(event)">
            </div>
            <button class="btn-connect focusable" onclick="App.login()">CONECTAR</button>
        </div>
    </div>

    <div id="screen-dash" class="hide">
        <div class="menu-tile focusable" onclick="App.loadCats('live')"><i class="fas fa-tv"></i>TV AO VIVO</div>
        <div class="menu-tile focusable" onclick="App.loadCats('movie')"><i class="fas fa-film"></i>FILMES</div>
        <div class="menu-tile focusable" onclick="App.loadCats('series')"><i class="fas fa-video"></i>SÉRIES</div>
    </div>

    <div id="screen-list" class="hide">
        <div class="sidebar" id="container-cats"></div>
        <div class="main-content" id="container-items">
            <h2 style="color:#444; text-align:center; margin-top:20%">SELECIONE UMA CATEGORIA</h2>
        </div>
    </div>

    <div id="screen-player" class="hide">
        <video id="player"></video>
    </div>

    <script>
        const App = {
            scr: 'login', // login, dash, cats, items, player
            items: [],
            idx: 0,
            
            creds: {},
            playlist: [], // Lista atual para o Auto-Play
            playIndex: -1, // Índice do vídeo tocando
            
            init: function() {
                // Relógio
                setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
                
                // Configura Player para Auto-Play
                const vid = document.getElementById('player');
                vid.addEventListener('ended', () => {
                    this.notify("PRÓXIMO EPISÓDIO...");
                    setTimeout(() => { this.nextEpisode(); }, 3000);
                });

                // Auto Login
                const s = localStorage.getItem('rc_auto_login');
                if(s) {
                    this.creds = JSON.parse(s);
                    document.getElementById('host').value = this.creds.host;
                    document.getElementById('user').value = this.creds.user;
                    document.getElementById('pass').value = this.creds.pass;
                    // Foca botão conectar
                    setTimeout(() => { this.scan(); this.idx = 3; this.update(); }, 500);
                } else {
                    this.scan();
                }

                // CONTROLE REMOTO GLOBAL
                document.addEventListener('keydown', (e) => this.remote(e));
            },

            // --- NAVEGAÇÃO "INFALÍVEL" ---
            scan: function() {
                let s = '';
                if(this.scr === 'login') s = '#screen-login .focusable';
                if(this.scr === 'dash') s = '#screen-dash .focusable';
                if(this.scr === 'cats') s = '#container-cats .list-item';
                if(this.scr === 'items') s = '#container-items .list-item';
                
                this.items = document.querySelectorAll(s);
                // Se perder referência, reseta índice
                if(this.idx >= this.items.length) this.idx = 0;
                this.update();
            },

            update: function() {
                document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused'));
                if(this.items[this.idx]) {
                    const el = this.items[this.idx];
                    el.classList.add('focused');
                    el.scrollIntoView({block:'center', behavior:'auto'}); // 'auto' é mais rápido que 'smooth' para TV
                    
                    // Hack para abrir teclado só se for input
                    if(el.tagName === 'INPUT') el.focus();
                    else document.activeElement.blur(); // Tira foco do input anterior
                }
            },

            remote: function(e) {
                const k = e.keyCode;
                
                // PLAYER (Prioridade)
                if(this.scr === 'player') {
                    e.preventDefault();
                    const v = document.getElementById('player');
                    if(k===8 || k===461 || k===10009 || k===403) this.stop(); // Voltar
                    if(k===13 || k===19) v.paused ? v.play() : v.pause(); // OK
                    if(k===39) v.currentTime += 15; // Direita
                    if(k===37) v.currentTime -= 15; // Esquerda
                    return;
                }

                // GERAL
                if(k===8 || k===461 || k===10009) { // Back
                    this.back(); return;
                }

                if(k===38) { // Cima
                    this.idx--; if(this.idx < 0) this.idx = 0;
                    this.update();
                }
                else if(k===40) { // Baixo
                    this.idx++; if(this.idx >= this.items.length) this.idx = this.items.length-1;
                    this.update();
                }
                else if(k===39) { // Direita
                    if(this.scr === 'cats') { this.scr = 'items'; this.scan(); this.idx=0; this.update(); }
                    else if(this.scr === 'dash') { this.idx++; if(this.idx >= this.items.length) this.idx=this.items.length-1; this.update(); }
                }
                else if(k===37) { // Esquerda
                    if(this.scr === 'items') { this.scr = 'cats'; this.scan(); this.idx=0; this.update(); }
                    else if(this.scr === 'dash') { this.idx--; if(this.idx < 0) this.idx=0; this.update(); }
                }
                else if(k===13) { // Enter
                     if(this.items[this.idx]) this.items[this.idx].click();
                }
            },

            // --- LOGIN AUTOMÁTICO (ENTER) ---
            checkEnterLogin: function(e) {
                if(e.keyCode === 13) {
                    e.preventDefault();
                    document.getElementById('pass').blur(); // Fecha teclado
                    this.login(); // Loga direto
                }
            },

            login: function() {
                const h = document.getElementById('host').value.trim();
                const u = document.getElementById('user').value.trim();
                const p = document.getElementById('pass').value.trim();
                
                if(!h || !u || !p) return;
                
                this.load(true);
                fetch(`${h}/player_api.php?username=${u}&password=${p}&action=get_live_categories`)
                .then(r => r.json())
                .then(d => {
                    localStorage.setItem('rc_auto_login', JSON.stringify({host:h, user:u, pass:p}));
                    this.creds = {host:h, user:u, pass:p};
                    this.screen('dash');
                    this.load(false);
                })
                .catch(e => {
                    this.load(false);
                    alert("Erro. Verifique dados e Internet.");
                });
            },

            // --- CONTEÚDO ---
            loadCats: function(type) {
                this.type = type;
                this.load(true);
                let action = type === 'live' ? 'get_live_categories' : (type === 'movie' ? 'get_vod_categories' : 'get_series_categories');
                
                fetch(`${this.creds.host}/player_api.php?username=${this.creds.user}&password=${this.creds.pass}&action=${action}`)
                .then(r => r.json())
                .then(d => {
                    const c = document.getElementById('container-cats');
                    c.innerHTML = '';
                    d.forEach(item => {
                        const el = document.createElement('div');
                        el.className = 'list-item focusable';
                        el.innerText = item.category_name;
                        el.onclick = () => {
                             // Efeito visual de seleção
                             Array.from(c.children).forEach(k=>k.style.color='#aaa');
                             el.style.color='var(--gold)';
                             this.loadItems(item.category_id);
                        };
                        c.appendChild(el);
                    });
                    this.screen('list');
                    this.scr = 'cats'; 
                    this.scan();
                    this.load(false);
                });
            },

            loadItems: function(catId) {
                this.load(true);
                let action = '';
                if(this.type === 'live') action = `get_live_streams&category_id=${catId}`;
                if(this.type === 'movie') action = `get_vod_streams&category_id=${catId}`;
                if(this.type === 'series') action = `get_series&category_id=${catId}`;

                fetch(`${this.creds.host}/player_api.php?username=${this.creds.user}&password=${this.creds.pass}&action=${action}`)
                .then(r => r.json())
                .then(d => {
                    const c = document.getElementById('container-items');
                    c.innerHTML = '';
                    
                    // SALVA A LISTA PARA O AUTO-PLAY
                    this.playlist = d; 

                    d.forEach((item, index) => {
                        const el = document.createElement('div');
                        el.className = 'list-item focusable';
                        el.innerText = item.name;
                        el.onclick = () => {
                            this.playIndex = index; // Marca onde começou
                            this.play(item);
                        };
                        c.appendChild(el);
                    });
                    this.load(false);
                    // Pula automaticamente para a direita
                    this.scr = 'items';
                    this.scan();
                });
            },

            // --- PLAYER + AUTO PLAY ---
            play: function(item) {
                const vid = document.getElementById('player');
                let url = '';
                
                if(this.type === 'live') {
                     url = `${this.creds.host}/live/${this.creds.user}/${this.creds.pass}/${item.stream_id}.m3u8`;
                } else {
                     let ext = item.container_extension || 'mp4';
                     url = `${this.creds.host}/movie/${this.creds.user}/${this.creds.pass}/${item.stream_id}.${ext}`;
                }

                document.getElementById('screen-player').classList.remove('hide');
                this.scr = 'player';
                this.notify(`TOCANDO: ${item.name}`);

                if(Hls.isSupported() && url.includes('.m3u8')) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(vid);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
                } else {
                    vid.src = url;
                    vid.play();
                }
            },

            nextEpisode: function() {
                // Lógica de Auto-Play
                if(this.type === 'live') return; // Live não tem próximo

                const nextIdx = this.playIndex + 1;
                if(nextIdx < this.playlist.length) {
                    this.playIndex = nextIdx;
                    this.play(this.playlist[nextIdx]);
                } else {
                    this.stop(); // Acabou a lista
                }
            },

            stop: function() {
                const v = document.getElementById('player');
                v.pause(); v.src = "";
                document.getElementById('screen-player').classList.add('hide');
                this.scr = 'items';
                this.scan();
            },

            // --- UTIL ---
            screen: function(id) {
                ['screen-login','screen-dash','screen-list'].forEach(x => document.getElementById(x).classList.add('hide'));
                document.getElementById('screen-'+id).classList.remove('hide');
                this.idx = 0;
            },
            
            back: function() {
                if(this.scr === 'items') { this.scr = 'cats'; this.scan(); }
                else if(this.scr === 'cats') { this.screen('dash'); this.scr='dash'; this.scan(); }
                else if(this.scr === 'dash') { 
                    if(confirm("Sair?")) location.reload(); 
                }
            },

            load: function(s) { document.getElementById('loading').classList.toggle('hide', !s); },
            
            notify: function(msg) {
                const n = document.getElementById('auto-play-msg');
                n.innerText = msg; n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 3000);
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
