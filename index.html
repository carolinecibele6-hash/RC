<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKY GOLD V85 - SEARCH EDITION</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; user-select: none; }
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* LOGIN */
        #loginScreen { position: absolute; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: #0a0a0a; border-top: 4px solid #d4af37; width: 450px; padding: 40px; text-align: center; }
        .login-input { width: 100%; height: 50px; margin-bottom: 15px; background: #1a1a1a; border: 1px solid #333; color: #fff; text-align: center; font-size: 18px; }
        .login-input:focus { background: #fff; color: #000; border-color: #d4af37; }
        .login-btn { width: 100%; height: 55px; background: #d4af37; color: #000; font-weight: bold; font-size: 18px; border: none; cursor: pointer; }

        /* INTERFACE */
        #mainInterface { display: none; width: 100%; height: 100%; }
        .sidebar { width: 80px; background: #080808; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-right: 1px solid #222; }
        .menu-icon { font-size: 22px; color: #333; margin-bottom: 20px; padding: 10px; border: 3px solid transparent; }
        .menu-icon.active { color: #d4af37; }
        .menu-icon.focused { background: #d4af37; color: #000; border-radius: 5px; border: 3px solid #fff; }

        .main-content { flex: 1; display: flex; flex-direction: column; }
        
        /* TOPO */
        .top-bar { 
            height: 60px; background: #080808; display: flex; align-items: center; 
            justify-content: space-between; padding: 0 30px; border-bottom: 1px solid #d4af37; 
        }
        .header-info { display: flex; gap: 20px; font-size: 12px; color: #666; font-family: monospace; flex: 1; justify-content: center; }
        .header-info b { color: #d4af37; margin-left: 5px; }
        #clock { font-size: 24px; font-weight: bold; color: #d4af37; font-family: monospace; min-width: 80px; text-align: right; }

        .columns { flex: 1; display: flex; overflow: hidden; }
        
        /* COLUNA DA ESQUERDA (LISTAS) */
        .col-list { width: 35%; background: #050505; border-right: 1px solid #222; display: flex; flex-direction: column; }
        
        /* BARRA DE PESQUISA (NOVO) */
        .search-container { padding: 10px; background: #000; border-bottom: 1px solid #222; }
        .search-input { 
            width: 100%; padding: 10px; background: #111; border: 1px solid #333; 
            color: #fff; text-transform: uppercase; font-weight: bold;
        }
        .search-input.focused { background: #fff; color: #000; border-color: #d4af37; }
        .search-input::placeholder { color: #555; font-weight: normal; text-transform: none; }

        .list-header { padding: 10px 15px; background: #0a0a0a; color: #d4af37; font-weight: bold; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #222; }
        .scroll-area { flex: 1; overflow-y: auto; }
        
        .list-item { padding: 15px 20px; border-bottom: 1px solid #111; color: #777; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 4px solid transparent; }
        .list-item.active { color: #d4af37; font-weight: bold; }
        .list-item.focused { background: #fff !important; color: #000 !important; font-weight: 900 !important; border: 4px solid #d4af37 !important; transform: scale(1.02); z-index: 10; }
        
        /* COLUNA DA DIREITA (PLAYER + INFO) */
        .col-view { width: 65%; background: #080808; display: flex; flex-direction: column; padding: 30px; }
        
        .video-box {
            width: 100%; aspect-ratio: 16/9; background: #000; 
            border: 2px solid #333; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .video-box.highlight { border-color: #d4af37; box-shadow: 0 0 30px rgba(212, 175, 55, 0.15); }

        video { width: 100%; height: 100%; object-fit: contain; }
        video::-webkit-media-controls { display: none !important; }

        .info-box { flex: 1; padding-top: 25px; display: flex; flex-direction: column; }
        .info-title { font-size: 28px; color: #d4af37; font-weight: bold; margin-bottom: 10px; }
        .info-desc { font-size: 16px; color: #888; line-height: 1.5; }
        .info-meta { font-size: 13px; color: #555; margin-top: auto; }

        /* FULLSCREEN */
        .fs { 
            position: fixed !important; top:0; left:0; width:100vw !important; height:100vh !important; 
            z-index:9999; border:none; border-radius: 0; background: #000;
        }
        ::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body onload="init()">

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:#d4af37; margin-bottom:20px;">SKY GOLD</h2>
            <input type="text" id="host" class="login-input" placeholder="DNS (http://url...)">
            <input type="text" id="user" class="login-input" placeholder="Usuário">
            <input type="password" id="pass" class="login-input" placeholder="Senha">
            <button class="login-btn" id="btnLogin" onclick="startApp()">ENTRAR</button>
        </div>
    </div>

    <div id="mainInterface">
        <div class="sidebar">
            <div class="menu-icon active" id="menu_0"><i class="fas fa-tv"></i></div>
            <div class="menu-icon" id="menu_1" style="margin-top:auto" onclick="reset()"><i class="fas fa-sign-out-alt"></i></div>
        </div>
        <div class="main-content">
            <div class="top-bar">
                <div style="font-weight:bold; color:#fff; font-size:18px">SKY <span style="color:#d4af37">GOLD</span></div>
                <div class="header-info">
                    <div>CRIADO: <b id="infoCre">--/--/--</b></div>
                    <div>VENCE: <b id="infoExp">--/--/--</b></div>
                </div>
                <div id="clock">00:00</div>
            </div>

            <div class="columns">
                <div class="col-list">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="PESQUISAR..." onkeyup="filterList()">
                    </div>

                    <div class="list-header" id="listTitle">CATEGORIAS</div>
                    
                    <div class="scroll-area" id="listContainer"></div>
                </div>
                
                <div class="col-view">
                    <div class="video-box" id="vidFrame">
                        <video id="player" playsinline></video>
                    </div>
                    <div class="info-box">
                        <div class="info-title" id="lblTitle">Bem Vindo</div>
                        <div class="info-desc" id="lblDesc">
                            1. Use as setas para navegar.<br>
                            2. <b>OK (1x)</b>: Inicia o vídeo no preview.<br>
                            3. <b>OK (2x)</b>: Abre em Tela Cheia.
                        </div>
                        <div class="info-meta">SKY GOLD V85</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let CONFIG = { host: '', user: '', pass: '' };
        let DATA = { cats: [], chns: [] };
        let hls = null;
        
        // ZONES: 0=Sidebar, 1=Lista, 2=Pesquisa
        let state = { screen: 'login', zone: 2, sIdx: 0, lIdx: 0, catSavedIdx: 0, mode: 'cat', fs: false };
        let currentChId = null;
        
        // Dados filtrados (para busca)
        let filteredList = [];

        function runClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        }
        setInterval(runClock, 1000); runClock();

        function init() {
            if(localStorage.getItem('sg85_h')) {
                document.getElementById('host').value = localStorage.getItem('sg85_h');
                document.getElementById('user').value = localStorage.getItem('sg85_u');
                document.getElementById('pass').value = localStorage.getItem('sg85_p');
            }
            document.getElementById('host').focus();
        }

        async function startApp() {
            let h = document.getElementById('host').value.trim();
            let u = document.getElementById('user').value.trim();
            let p = document.getElementById('pass').value.trim();
            if(!h.startsWith('http')) h = 'http://' + h;
            
            document.getElementById('btnLogin').innerText = "ENTRANDO...";

            try {
                let res = await fetch(`${h}/player_api.php?username=${u}&password=${p}`);
                let data = await res.json();
                
                if(data.user_info.status === 'Active') {
                    localStorage.setItem('sg85_h', h); localStorage.setItem('sg85_u', u); localStorage.setItem('sg85_p', p);
                    CONFIG = { host: h, user: u, pass: p };
                    
                    try {
                        document.getElementById('infoCre').innerText = new Date(parseInt(data.user_info.created_at)*1000).toLocaleDateString('pt-BR');
                        document.getElementById('infoExp').innerText = new Date(parseInt(data.user_info.exp_date)*1000).toLocaleDateString('pt-BR');
                    } catch(e){}

                    state.screen = 'app';
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainInterface').style.display = 'flex';
                    loadCats();
                } else {
                    alert("Conta Inativa");
                    document.getElementById('btnLogin').innerText = "ENTRAR";
                }
            } catch(e) {
                alert("Erro de Conexão");
                document.getElementById('btnLogin').innerText = "ENTRAR";
            }
        }

        async function loadCats() {
            let res = await fetch(`${CONFIG.host}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_live_categories`);
            let raw = await res.json();
            DATA.cats = raw.filter(c => !c.category_name.toLowerCase().match(/xxx|porn/));
            state.mode = 'cat'; 
            state.lIdx = 0; // Reset lista index
            state.zone = 2; // Foco na Busca (Segurança)
            document.getElementById('searchInput').value = '';
            filterList(); // Renderiza
        }

        async function loadChns(cid) {
            document.getElementById('listContainer').innerHTML = '<div style="padding:20px;color:#666">Carregando...</div>';
            let res = await fetch(`${CONFIG.host}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_live_streams&category_id=${cid}`);
            DATA.chns = await res.json();
            state.mode = 'chn'; 
            state.lIdx = 0;
            state.zone = 2; // Foco na Busca ao entrar na categoria
            document.getElementById('searchInput').value = '';
            filterList();
        }

        // Função de Filtragem e Renderização
        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const source = state.mode === 'cat' ? DATA.cats : DATA.chns;
            
            if(!term) filteredList = source;
            else {
                filteredList = source.filter(item => {
                    const name = state.mode === 'cat' ? item.category_name : item.name;
                    return name.toLowerCase().includes(term);
                });
            }
            renderListUI();
        }

        function renderListUI() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            document.getElementById('listTitle').innerText = state.mode === 'cat' ? 'CATEGORIAS' : 'CANAIS';
            
            if(filteredList.length === 0) {
                container.innerHTML = '<div style="padding:20px;">Sem resultados</div>';
                return;
            }

            filteredList.forEach((item, i) => {
                let div = document.createElement('div');
                div.className = 'list-item';
                
                // Destaque de Foco
                if(i === state.lIdx && state.zone === 1) div.classList.add('focused');
                
                // Destaque de Ativo (Tocando)
                if(state.mode === 'chn' && currentChId === item.stream_id) div.classList.add('active');
                
                div.innerText = state.mode === 'cat' ? item.category_name : item.name;
                
                // Mouse click handler
                div.onclick = () => {
                    state.zone = 1; state.lIdx = i; renderListUI(); renderFocus();
                    if(state.mode === 'cat') {
                        state.catSavedIdx = i; loadChns(item.category_id);
                    } else play(item);
                };

                container.appendChild(div);
                if(i === state.lIdx && state.zone === 1) div.scrollIntoView({block: 'center'});
            });
            renderFocus(); // Atualiza foco visual da busca vs lista
        }

        function play(ch) {
            const video = document.getElementById('player');
            const url = `${CONFIG.host}/live/${CONFIG.user}/${CONFIG.pass}/${ch.stream_id}.ts`;
            
            currentChId = ch.stream_id;
            
            document.getElementById('lblTitle').innerText = ch.name;
            document.getElementById('lblDesc').innerText = "Reproduzindo...";
            document.getElementById('vidFrame').classList.add('highlight');

            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
            }
            else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            }
            // Re-render para atualizar o ícone active na lista
            renderListUI();
        }

        // CONTROLES DE TECLADO
        document.addEventListener('keydown', (e) => {
            const k = e.keyCode;

            // Fullscreen Exit
            if(state.fs) { 
                if([8, 461, 13, 27, 10009].includes(k)) { 
                    document.getElementById('vidFrame').classList.remove('fs'); 
                    state.fs=false; e.preventDefault();
                } return; 
            }
            
            // Login
            if(state.screen === 'login') {
                const active = document.activeElement;
                if(k === 40) { 
                    if(active.id === 'host') document.getElementById('user').focus(); 
                    else if(active.id === 'user') document.getElementById('pass').focus(); 
                    else if(active.id === 'pass') document.getElementById('btnLogin').focus(); 
                }
                if(k === 38) { 
                    if(active.id === 'user') document.getElementById('host').focus(); 
                    else if(active.id === 'pass') document.getElementById('user').focus(); 
                    else if(active.id === 'btnLogin') document.getElementById('pass').focus(); 
                }
                if(k === 13 && active.id === 'btnLogin') startApp(); return;
            }

            // Permite digitação na busca (Zone 2)
            if(state.zone === 2 && ((k >= 48 && k <= 90) || k === 8 || k === 32)) {
                // Deixa o evento nativo rodar para o input preencher
                return;
            }

            // Bloqueia scroll nativo para setas
            if([37,38,39,40].includes(k)) e.preventDefault();

            // Lógica de Navegação
            if(state.zone === 0) { // SIDEBAR
                if(k===38 && state.sIdx>0) state.sIdx--; 
                if(k===40 && state.sIdx<1) state.sIdx++; 
                if(k===39) state.zone = 2; // Vai para Busca primeiro
                if(k===13 && state.sIdx===1) reset();
            }
            else if(state.zone === 2) { // BUSCA
                if(k===40 && filteredList.length > 0) {
                    state.zone = 1; // Desce para Lista
                    state.lIdx = 0;
                    document.getElementById('searchInput').blur();
                }
                if(k===37) state.zone = 0;
            }
            else if(state.zone === 1) { // LISTA
                if(k===38) {
                    if(state.lIdx > 0) state.lIdx--; 
                    else {
                        state.zone = 2; // Sobe para Busca
                        document.getElementById('searchInput').focus();
                    }
                }
                else if(k===40 && state.lIdx < filteredList.length-1) state.lIdx++;
                
                // Voltar
                if(k===37 || k===8 || k===461 || k===27 || k===10009) { 
                    if(state.mode==='chn') { 
                        state.mode='cat'; 
                        state.lIdx = 0;
                        state.zone = 2; // Volta focado na busca
                        document.getElementById('searchInput').value = '';
                        filterList();
                    } else state.zone=0; 
                }
                
                // ENTER (Lógica Duplo OK)
                if(k===13) {
                    let item = filteredList[state.lIdx];
                    if(state.mode === 'cat') {
                        loadChns(item.category_id);
                    } else {
                        // 1º OK: Tocar / 2º OK: Fullscreen
                        if(currentChId === item.stream_id) { 
                            // Já está tocando -> Fullscreen
                            document.getElementById('vidFrame').classList.add('fs'); 
                            state.fs=true; 
                        } else {
                            // Tocar novo canal
                            play(item);
                        }
                    }
                }
            }
            renderListUI();
        });

        function renderFocus() {
            // Sidebar
            document.querySelectorAll('.menu-icon').forEach(el => el.classList.remove('focused'));
            if(state.zone === 0) document.getElementById('menu_'+state.sIdx).classList.add('focused');

            // Busca
            const sInput = document.getElementById('searchInput');
            if(state.zone === 2) sInput.classList.add('focused');
            else sInput.classList.remove('focused');
        }

        function reset() { 
            if(confirm("Deseja sair?")) { localStorage.clear(); location.reload(); } 
        }
    </script>
</body>
</html>
