<script>
        const App = {
            auth: {}, modeVal: 'live', nav: { cats: [], items: [], queue: [] },
            playIdx: 0, hls: null, skipT: null, cacheGlob: null, activeState: 'login',

            init: function() {
                // Recupera dados salvos
                if(localStorage.getItem('gh')) {
                    document.getElementById('h').value = localStorage.getItem('gh');
                    document.getElementById('u').value = localStorage.getItem('gu');
                    document.getElementById('p').value = localStorage.getItem('gp');
                }
                
                document.addEventListener('keydown', (e) => this.key(e));
                
                const s = document.getElementById('search');
                s.addEventListener('input', (e) => this.filterLocal(e.target.value));
                s.addEventListener('keydown', (e) => { 
                    if(e.key === 'Enter') this.searchGlobal(s.value); 
                    e.stopPropagation(); 
                });

                // Tenta focar no primeiro campo após carregar
                setTimeout(() => {
                    const firstInput = document.getElementById('h');
                    if(firstInput) firstInput.focus();
                }, 500);
            },

            // --- FUNÇÃO DE REQUISIÇÃO (SIMPLIFICADA PARA TVS ANTIGAS) ---
            req: async function(a, p='') {
                const {h,u,pass} = this.auth;
                const url = `${h}/player_api.php?username=${u}&password=${pass}&action=${a}${p}`;
                
                try {
                    // Removi AbortController pois trava TVs antigas (Philco/Samsung antigas)
                    const r = await fetch(url);
                    if(!r.ok) throw new Error("Erro HTTP: " + r.status);
                    return await r.json();
                } catch(e) { 
                    console.error("Erro Req:", e);
                    // Mostra o erro na tela para você saber o que houve
                    document.getElementById('log-msg').innerText = "Erro: " + e.message;
                    return null; 
                }
            },

            login: async function() {
                const msg = document.getElementById('log-msg');
                msg.innerText = "Preparando...";

                // 1. Limpeza agressiva de espaços (Trim)
                let h = document.getElementById('h').value.trim();
                let u = document.getElementById('u').value.trim();
                let pass = document.getElementById('p').value.trim();

                if(!h || !u || !pass) {
                    msg.innerText = "Preencha todos os campos!";
                    return;
                }

                // 2. Correção de URL
                if(h.endsWith('/')) h = h.slice(0, -1);
                if(!h.startsWith('http')) h = 'http://' + h; // Força HTTP para evitar bloqueio Misto

                this.auth = { h, u, pass };
                
                msg.innerText = "Conectando... (Aguarde)";
                
                // Faz o teste
                const d = await this.req('user_info');
                
                if(d && d.user_info && d.user_info.auth == 1) {
                    // Sucesso: Salva e entra
                    localStorage.setItem('gh', h); 
                    localStorage.setItem('gu', u); 
                    localStorage.setItem('gp', pass);
                    
                    document.getElementById('login-screen').classList.add('hide');
                    document.getElementById('dash-screen').classList.remove('hide');
                    this.activeState = 'dash';
                    this.mode('live');
                } else if (d && d.user_info && d.user_info.auth == 0) {
                    msg.innerText = "Login Inválido (Verifique Usuário/Senha)";
                } else {
                    // Se caiu aqui, é erro de conexão (CORS ou DNS)
                    msg.innerText = "Falha de Conexão. Verifique a URL.";
                }
            },

            mode: async function(m) {
                this.modeVal = m; this.cacheGlob = null;
                document.querySelectorAll('.icon-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('btn-'+m).classList.add('active');
                document.getElementById('crumb').style.display='none';
                document.getElementById('search').value = '';
                
                document.getElementById('cats').innerHTML = '...';
                document.getElementById('grid').innerHTML = '';

                let act = (m=='live')?'get_live_categories':(m=='movie'?'get_vod_categories':'get_series_categories');
                const cats = await this.req(act);
                
                if(cats && Array.isArray(cats)) {
                    this.nav.cats = cats;
                    let h = '';
                    cats.forEach((c, i) => h += `<div class="cat-item focusable" tabindex="${100+i}" onclick="App.loadCat('${c.category_id}')">${c.category_name}</div>`);
                    document.getElementById('cats').innerHTML = h;
                    if(cats.length>0) this.loadCat(cats[0].category_id);
                } else {
                    document.getElementById('cats').innerHTML = 'Erro ao carregar categorias.';
                }
            },

            loadCat: async function(cid) {
                document.querySelectorAll('.cat-item').forEach(c=>c.classList.remove('active'));
                
                // Marca visualmente
                const items = document.querySelectorAll('.cat-item');
                for(let i=0; i<items.length; i++) {
                     if(items[i].getAttribute('onclick').includes(`'${cid}'`)) items[i].classList.add('active');
                }

                document.getElementById('grid').className = 'grid';
                document.getElementById('grid').innerHTML = '<div style="padding:20px">Carregando canais...</div>';
                
                let act = this.modeVal=='live'?'get_live_streams':(this.modeVal=='movie'?'get_vod_streams':'get_series');
                const list = await this.req(act, `&category_id=${cid}`);
                
                this.nav.items = list || [];
                this.render(this.nav.items);
            },

            render: function(list) {
                const g = document.getElementById('grid');
                g.innerHTML = '';
                if(!list || list.length===0) { g.innerHTML='<div style="padding:20px">Nenhum conteúdo encontrado.</div>'; return; }
                
                // Limite de 100 itens para não travar a TV
                list.slice(0, 100).forEach((i, idx) => {
                    const n = i.name || i.title;
                    const img = i.stream_icon || i.cover || '';
                    const d = document.createElement('div');
                    d.className = 'card focusable';
                    d.setAttribute('tabindex', 200 + idx);
                    d.onclick = () => this.click(i);
                    d.innerHTML = `<img src="${img}" class="card-img" onerror="this.style.opacity=0"><div class="card-ovl">${n}</div>`;
                    g.appendChild(d);
                });
            },

            // --- BUSCA ---
            filterLocal: function(t) {
                if(!t) { this.render(this.nav.items); return; }
                const c = t.toLowerCase();
                this.render(this.nav.items.filter(i => (i.name||i.title||"").toLowerCase().includes(c)));
            },

            searchGlobal: async function(t) {
                if(!t || t.length < 3) return;
                const stat = document.getElementById('status');
                stat.innerText = "Buscando Global...";
                document.getElementById('grid').innerHTML = '<div style="padding:20px">Baixando dados do servidor...</div>';

                if(!this.cacheGlob) {
                    let act = this.modeVal=='live'?'get_live_streams':(this.modeVal=='movie'?'get_vod_streams':'get_series');
                    const all = await this.req(act);
                    this.cacheGlob = all || [];
                }

                if(this.cacheGlob) {
                    const c = t.toLowerCase();
                    const res = this.cacheGlob.filter(i => (i.name||i.title||"").toLowerCase().includes(c));
                    stat.innerText = `${res.length} resultados.`;
                    this.render(res);
                } else {
                    stat.innerText = "Falha na busca.";
                    this.render([]);
                }
            },

            // --- PLAYER ---
            click: async function(it) {
                if(this.modeVal !== 'series') {
                    this.nav.queue = [it]; this.playIdx = 0; this.play(it);
                } else {
                    const g = document.getElementById('grid');
                    g.innerHTML = 'Carregando eps...';
                    document.getElementById('crumb').style.display = 'block';
                    document.getElementById('crumb').innerHTML = `SÉRIES > <span>${it.name}</span>`;
                    
                    const info = await this.req('get_series_info', `&series_id=${it.series_id}`);
                    g.innerHTML = '';
                    
                    if(info.episodes) {
                        g.className = 'ep-list';
                        let count = 0;
                        Object.keys(info.episodes).forEach(s => {
                            info.episodes[s].forEach(ep => {
                                const d = document.createElement('div');
                                d.className = 'ep-row focusable';
                                d.setAttribute('tabindex', 300 + count++);
                                d.onclick = () => {
                                    this.nav.queue = info.episodes[s];
                                    this.playIdx = this.nav.queue.findIndex(x => x.id === ep.id);
                                    this.play(ep);
                                };
                                d.innerHTML = `<div class="ep-idx">T${s} E${ep.episode_num}</div><div>${ep.title}</div>`;
                                g.appendChild(d);
                            });
                        });
                        setTimeout(()=> {
                            const first = g.querySelector('.focusable');
                            if(first) first.focus();
                        }, 100);
                    }
                }
            },

            play: function(it) {
                this.stopEngine();

                const vid = document.getElementById('vid');
                const spin = document.getElementById('spin');
                
                document.getElementById('dash-screen').classList.add('hide');
                document.getElementById('player-screen').classList.remove('hide');
                this.activeState = 'player';
                spin.style.display = 'block';
                vid.focus(); 

                const id = it.stream_id || it.id;
                let type, ext;
                
                if (this.modeVal === 'live') {
                    type = 'live';
                    ext = 'm3u8';
                } else {
                    type = this.modeVal === 'movie' ? 'movie' : 'series';
                    ext = it.container_extension || 'mp4';
                }

                // Ajuste de URL para evitar // duplicadas
                let baseUrl = this.auth.h;
                if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0,-1);
                
                const url = `${baseUrl}/${type}/${this.auth.u}/${this.auth.pass}/${id}.${ext}`;
                console.log("Play:", url);

                if (ext === 'm3u8' || (Hls.isSupported() && url.includes('m3u8'))) {
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(vid);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
                    this.hls.on(Hls.Events.ERROR, (e,d) => { if(d.fatal) this.fail(); });
                } else {
                    vid.src = url;
                    vid.play().catch(e => { console.log("Erro nativo", e); this.fail(); });
                }

                vid.onplaying = () => spin.style.display = 'none';
                vid.onwaiting = () => spin.style.display = 'block';
                vid.onended = () => this.next();
                vid.onerror = () => this.fail();
            },

            next: function() {
                if(this.activeState !== 'player') return;
                if(this.nav.queue.length && this.playIdx < this.nav.queue.length-1) {
                    this.playIdx++;
                    this.play(this.nav.queue[this.playIdx]);
                } else this.close();
            },

            fail: function() {
                if(this.activeState !== 'player') return;
                clearTimeout(this.skipT);
                this.skipT = setTimeout(() => { this.next(); }, 3000);
            },

            stopEngine: function() {
                const vid = document.getElementById('vid');
                clearTimeout(this.skipT);
                this.skipT = null;
                vid.onerror = null;
                vid.onended = null;
                vid.pause();
                vid.removeAttribute('src');
                if(this.hls) { this.hls.destroy(); this.hls = null; }
            },

            close: function() {
                this.stopEngine();
                document.getElementById('player-screen').classList.add('hide');
                document.getElementById('dash-screen').classList.remove('hide');
                this.activeState = 'dash';
                setTimeout(()=> {
                   const g = document.getElementById('grid');
                   if(g && g.firstChild) g.firstChild.focus();
                }, 100);
            },

            key: function(e) {
                const k = e.keyCode;
                // Backspace(8), ESC(27), Return-TV(461/10009)
                if([8,27,461,10009].includes(k)) {
                    e.preventDefault();
                    if(this.activeState === 'player') this.close();
                    else if(document.getElementById('grid').className == 'ep-list') {
                        this.loadCat(this.nav.cats[0].category_id);
                        document.getElementById('crumb').style.display='none';
                    }
                }
                else if(k === 13) { // Enter
                    const act = document.activeElement;
                    if(act && act.classList.contains('focusable') && act.tagName !== 'INPUT') {
                        e.preventDefault();
                        act.click();
                    }
                }
                else if([37,38,39,40].includes(k)) { // Setas
                    if(this.activeState === 'player') return; 
                    e.preventDefault();
                    this.moveFocus(k);
                }
            },

            moveFocus: function(dir) {
                const els = Array.from(document.querySelectorAll('.focusable:not(.hide)'));
                const visible = els.filter(el => el.offsetParent !== null);
                const current = document.activeElement;

                if(!visible.includes(current)) {
                    if(visible.length > 0) visible[0].focus();
                    return;
                }

                const rect1 = current.getBoundingClientRect();
                let best = null, minDist = Infinity;

                visible.forEach(el => {
                    if(el === current) return;
                    const rect2 = el.getBoundingClientRect();
                    let dist = Infinity, valid = false;
                    const c1 = { x: rect1.left + rect1.width/2, y: rect1.top + rect1.height/2 };
                    const c2 = { x: rect2.left + rect2.width/2, y: rect2.top + rect2.height/2 };

                    if(dir === 37 && c2.x < c1.x && Math.abs(c2.y - c1.y) < rect1.height) { valid = true; dist = c1.x - c2.x; }
                    else if(dir === 39 && c2.x > c1.x && Math.abs(c2.y - c1.y) < rect1.height) { valid = true; dist = c2.x - c1.x; }
                    else if(dir === 38 && c2.y < c1.y) { valid = true; dist = Math.sqrt(Math.pow(c1.x-c2.x,2) + Math.pow(c1.y-c2.y,2)); }
                    else if(dir === 40 && c2.y > c1.y) { valid = true; dist = Math.sqrt(Math.pow(c1.x-c2.x,2) + Math.pow(c1.y-c2.y,2)); }

                    if(valid && dist < minDist) { minDist = dist; best = el; }
                });

                if(best) { best.focus(); best.scrollIntoView({behavior: 'smooth', block: 'center'}); }
            }
        };
    </script>
