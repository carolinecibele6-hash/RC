// =================================================================
// CONFIGURAÇÃO DE TECLAS (PADRÃO NETRANGE / PHILCO)
// =================================================================
const KEYS = {
    UP: 38,
    DOWN: 40,
    LEFT: 37,
    RIGHT: 39,
    ENTER: 13,
    BACK: 461, // Às vezes 8 ou 10009 dependendo do modelo exato
    RED: 403,
    GREEN: 404,
    YELLOW: 405,
    BLUE: 406
};

// Estado Global
let currentZone = 'login'; // login, dashboard, sidebar, content
let focusedIndex = 0;

// =================================================================
// GERENCIADOR DE NAVEGAÇÃO
// =================================================================

document.addEventListener('keydown', function(e) {
    // IMPORTANTE: Impede o mouse virtual de aparecer/mover
    e.preventDefault();

    const key = e.keyCode;

    // 1. Mapeamento de Botões Coloridos (Ações Globais)
    if (key === KEYS.RED) handleColorButton('RED');
    if (key === KEYS.GREEN) handleColorButton('GREEN');
    if (key === KEYS.YELLOW) handleColorButton('YELLOW');
    if (key === KEYS.BLUE) handleColorButton('BLUE');
    if (key === KEYS.BACK) handleBack();

    // 2. Navegação Direcional
    if ([KEYS.UP, KEYS.DOWN, KEYS.LEFT, KEYS.RIGHT, KEYS.ENTER].includes(key)) {
        handleNavigation(key);
    }
});

function handleNavigation(key) {
    // Busca todos os itens focáveis NA TELA ATUAL visível
    const activeScreen = document.querySelector('.screen.active-screen');
    if (!activeScreen) return;

    // Seletor inteligente baseada na zona (Melhora a performance)
    let elements = Array.from(activeScreen.querySelectorAll('.focusable'));
    
    // Se não houver elementos (ex: carregando), ignora
    if (elements.length === 0) return;

    // Garante que o índice esteja dentro dos limites
    if (focusedIndex >= elements.length) focusedIndex = elements.length - 1;
    if (focusedIndex < 0) focusedIndex = 0;

    const currentEl = elements[focusedIndex];

    // --- LÓGICA DE MOVIMENTO ---
    if (key === KEYS.ENTER) {
        currentEl.click(); // Simula o clique
        return;
    }

    // Remove foco visual atual
    currentEl.classList.remove('focused');

    // NAVEGAÇÃO ESPACIAL SIMPLIFICADA
    // Define quantas colunas tem o layout atual para saber se sobe/desce ou vai p/ lado
    let columns = 1; 
    if (activeScreen.id === 'dashboard-screen') columns = 3; // Exemplo: Menu principal tem 3 cards lado a lado
    
    // Lógica Específica para a Tela de Conteúdo (Sidebar -> Lista -> EPG)
    if (activeScreen.id === 'content-screen') {
        handleContentScreenNav(key, currentEl);
        return; // Sai da função padrão pois a tela de conteúdo tem lógica própria
    }

    // Lógica Padrão (Login e Dashboard)
    if (key === KEYS.DOWN) {
        focusedIndex = Math.min(focusedIndex + columns, elements.length - 1);
    } else if (key === KEYS.UP) {
        focusedIndex = Math.max(focusedIndex - columns, 0);
    } else if (key === KEYS.RIGHT) {
        if ((focusedIndex + 1) % columns !== 0) focusedIndex++; // Não deixa pular linha se for grid
        else focusedIndex = Math.min(focusedIndex + 1, elements.length - 1);
    } else if (key === KEYS.LEFT) {
        if (focusedIndex % columns !== 0) focusedIndex--; // Não deixa voltar linha se for grid
        else focusedIndex = Math.max(focusedIndex - 1, 0);
    }

    // Aplica novo foco
    applyFocus(elements[focusedIndex]);
}

// Lógica Especial para a Tela Principal (Listas)
function handleContentScreenNav(key, currentEl) {
    // Zonas: 'sidebar-left' (Categorias) | 'content-middle' (Canais)
    const parentId = currentEl.parentElement.id || currentEl.parentElement.parentElement.id;

    if (key === KEYS.UP) {
        moveVertical(currentEl, -1);
    } else if (key === KEYS.DOWN) {
        moveVertical(currentEl, 1);
    } else if (key === KEYS.RIGHT) {
        // Se estiver na Categoria -> Vai para Canais
        if (parentId.includes('category-list') || currentEl.classList.contains('cat-item')) {
            focusFirstItem('channel-list');
        }
    } else if (key === KEYS.LEFT) {
        // Se estiver nos Canais -> Volta para Categoria
        if (parentId.includes('channel-list') || currentEl.classList.contains('channel-item')) {
            focusFirstItem('category-list');
        }
    }
}

// Auxiliar: Move para cima/baixo dentro da mesma lista
function moveVertical(element, direction) {
    const container = element.parentElement;
    const siblings = Array.from(container.querySelectorAll('.focusable'));
    let idx = siblings.indexOf(element);
    
    let newIdx = idx + direction;
    if (newIdx >= 0 && newIdx < siblings.length) {
        // Remove foco antigo e seta novo
        element.classList.remove('focused');
        applyFocus(siblings[newIdx]);
    }
}

// Auxiliar: Pula para a primeira opção de outra coluna
function focusFirstItem(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const target = container.querySelector('.focusable');
    if (target) {
        document.querySelector('.focused')?.classList.remove('focused');
        applyFocus(target);
    }
}

function applyFocus(element) {
    element.classList.add('focused');
    element.focus();
    element.scrollIntoView({ behavior: 'auto', block: 'center' });
    
    // Atualiza o índice global se estivermos na lógica padrão
    const allFocusables = Array.from(document.querySelector('.active-screen').querySelectorAll('.focusable'));
    focusedIndex = allFocusables.indexOf(element);
}

// =================================================================
// FUNÇÕES DOS BOTÕES COLORIDOS
// =================================================================
function handleColorButton(color) {
    const screen = document.querySelector('.active-screen').id;
    console.log(`Botão ${color} pressionado na tela ${screen}`);

    // Exemplo de ações personalizadas
    if (color === 'RED') {
        // Ação: SAIR ou LOGOUT
        if (screen !== 'login-screen') {
            if(confirm("Deseja desconectar?")) changeScreen('login-screen');
        }
    }
    else if (color === 'GREEN') {
        // Ação: PESQUISAR ou RECARREGAR
        alert("Função Pesquisar (A implementar)");
    }
    else if (color === 'YELLOW') {
        // Ação: ADICIONAR FAVORITOS
        const focused = document.querySelector('.focused');
        if (focused && focused.classList.contains('channel-item')) {
            focused.classList.toggle('favorite'); // Exemplo visual
            alert("Canal adicionado aos favoritos!");
        }
    }
    else if (color === 'BLUE') {
        // Ação: CONFIGURAÇÕES ou MUDAR FORMATO DE TELA
        alert("Ajustes de Tela / Áudio");
    }
}

// =================================================================
// INICIALIZAÇÃO E UTILITÁRIOS (IGUAL AO ANTERIOR)
// =================================================================
window.onload = function() {
    changeScreen('login-screen');
};

function changeScreen(screenId) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
    const newScreen = document.getElementById(screenId);
    newScreen.classList.add('active-screen');
    
    // Foca automaticamente no primeiro item da nova tela
    focusedIndex = 0;
    const firstItem = newScreen.querySelector('.focusable');
    if (firstItem) applyFocus(firstItem);
}

// ... (Mantenha as funções de Login e Relógio do código anterior aqui) ...
// Função Login Simples para Teste
document.getElementById('btn-connect').addEventListener('click', () => changeScreen('dashboard-screen'));
