<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoldStream STB Fix</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- ESTILO DARK/GOLD PREMIUM --- */
        :root { --bg: #000; --panel: #111; --gold: #d4af37; --card: #1a1a1a; }
        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; overflow: hidden; width: 100vw; height: 100vh; }
        .hide { display: none !important; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }

        /* Foco - Melhorado para TV */
        .focusable { border: 3px solid transparent; cursor: pointer; transition: all 0.1s; }
        /* O seletor :focus é importante para TVs que usam navegação nativa do browser */
        .focusable:focus, .focusable.focused, .focusable:hover { 
            border-color: var(--gold) !important; 
            transform: scale(1.02); 
            z-index: 50; 
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.4); 
            background-color: #333; /* Destaque leve no fundo */
        }

        /* Login */
        #login-screen { background: #000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { width: 350px; text-align: center; }
        .logo { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 25px; letter-spacing: 1px; }
        .logo span { color: var(--gold); }
        .inp { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #333; color: #fff; text-align: center; border-radius: 4px; font-size: 16px; }
        .btn { width: 100%; padding: 12px; margin-top: 15px; background: var(--gold); color: #000; font-weight: 700; border: none; border-radius: 4px; font-size: 16px; }

        /* Dashboard */
        #dash-screen { display: flex; background: var(--bg); }
        .sidebar { width: 230px; background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #222; }
        .menu-head { padding: 25px; font-weight: 800; color: var(--gold); text-align: center; }
        .menu-icons { display: flex; justify-content: space-evenly; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .icon-btn { padding: 10px; font-size: 20px; color: #555; border-radius: 5px; min-width: 40px; text-align: center; }
        .icon-btn.active { color: var(--gold); background: rgba(255,255,255,0.05); }
        
        .cat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .cat-item { padding: 12px 10px; margin-bottom: 2px; font-size: 13px; color: #999; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-item.active { background: #222; color: #fff; border-left: 3px solid var(--gold); }

        .content { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        
        /* Busca & Topo */
        .top-bar { display: flex; margin-bottom: 15px; gap: 10px; align-items: center; }
        .search-inp { flex: 1; max-width: 400px; background: #1a1a1a; border: 1px solid #333; padding: 10px 20px; border-radius: 30px; color: #fff; font-weight: bold; }
        .status-txt { font-size: 12px; color: var(--gold); font-weight: 600; }

        #crumb { font-size: 12px; color: #777; margin-bottom: 10px; display: none; }
        #crumb span { color: var(--gold); font-weight: bold; }

        /* Grid STB */
        .grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); grid-auto-rows: 220px; gap: 15px; padding-bottom: 50px; }
        .card { background: var(--card); border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.2s; }
        .card:focus .card-img, .card.focused .card-img { opacity: 1; }
        .card-ovl { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #000 10%, transparent); padding: 10px 5px; text-align: center; font-size: 12px; font-weight: 600; }

        /* Player */
        #player-screen { background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; background: #000; }
        .spinner { position: absolute; width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; z-index: 20; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Episódios */
        .ep-list { display: flex; flex-direction: column; gap: 5px; overflow-y: auto; max-height: 80vh; }
        .ep-row { background: #222; padding: 15px; border-radius: 4px; display: flex; align-items: center; }
        .ep-idx { color: var(--gold); font-weight: 800; width: 60px; margin-right: 10px; }

        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body onload="App.init()">

    <div id="login-screen" class="screen">
        <div class="login-box">
            <div class="logo">GOLD <span>STB</span></div>
            <input id="h" class="inp focusable" placeholder="http://url:porta" tabindex="1">
            <input id="u" class="inp focusable" placeholder="Usuário" tabindex="2">
            <input type="password" id="p" class="inp focusable" placeholder="Senha" tabindex="3">
            <button id="btn-login" class="btn focusable" onclick="App.login()" tabindex="4">CONECTAR</button>
            <div id="log-msg" style="color:#d44; margin-top:10px; font-size:12px"></div>
        </div>
    </div>

    <div id="dash-screen" class="screen hide">
        <div class="sidebar">
            <div class="menu-head">MENU</div>
            <div class="menu-icons">
                <div id="btn-live" class="icon-btn focusable" onclick="App.mode('live')" tabindex="10"><i class="fas fa-tv"></i></div>
                <div id="btn-movie" class="icon-btn focusable" onclick="App.mode('movie')" tabindex="11"><i class="fas fa-film"></i></div>
                <div id="btn-series" class="icon-btn focusable" onclick="App.mode('series')" tabindex="12"><i class="fas fa-layer-group"></i></div>
            </div>
            <div id="cats" class="cat-list"></div>
        </div>
        <div class="content">
            <div class="top-bar">
                <input id="search" class="search-inp focusable" placeholder="Buscar..." autocomplete="off" tabindex="20">
                <div id="status" class="status-txt"></div>
            </div>
            <div id="crumb"></div>
            <div id="grid" class="grid"></div>
        </div>
    </div>

    <div id="player-screen" class="screen hide">
        <div id="spin" class="spinner"></div>
        <video id="vid" controls autoplay playsinline></video>
    </div>

    <script>
        const App = {
            auth: {}, modeVal: 'live', nav: { cats: [], items: [], queue: [] },
            playIdx: 0, hls: null, skipT: null, cacheGlob: null, activeState: 'login',

            init: function() {
                if(localStorage.getItem('gh')) {
                    document.getElementById('h').value = localStorage.getItem('gh');
                    document.getElementById('u').value = localStorage.getItem('gu');
                    document.getElementById('p').value = localStorage.getItem('gp');
                }
                
                // Listener global de teclas
                document.addEventListener('keydown', (e) => this.key(e));
                
                // Busca Inteligente
                const s = document.getElementById('search');
                s.addEventListener('input', (e) => this.filterLocal(e.target.value));
                s.addEventListener('keydown', (e) => { 
                    // Permite digitar no input sem disparar navegação louca
                    if(e.key === 'Enter') this.searchGlobal(s.value); 
                    e.stopPropagation(); // Impede conflito com navegação
                });

                // Foco inicial
                setTimeout(() => {
                    const firstInput = document.getElementById('h');
                    if(firstInput) {
                        firstInput.focus();
                        firstInput.classList.add('focused');
                    }
                }, 500);
            },

            req: async function(a, p='') {
                const {h,u,pass} = this.auth;
                try {
                    const c = new AbortController();
                    const id = setTimeout(()=>c.abort(), 15000); // Aumentei timeout para 15s
                    // Correção: Garante que use 'http' se o servidor não suportar 'https'
                    const r = await fetch(`${h}/player_api.php?username=${u}&password=${pass}&action=${a}${p}`, {signal:c.signal});
                    clearTimeout(id);
                    return await r.json();
                } catch(e) { 
                    console.error("Erro Req:", e);
                    return null; 
                }
            },

            login: async function() {
                let h = document.getElementById('h').value.trim();
                // Remove barra final se existir
                if(h.endsWith('/')) h = h.slice(0, -1);
                if(!h.startsWith('http')) h = 'http://'+h;
                
                this.auth = { h, u: document.getElementById('u').value, pass: document.getElementById('p').value };
                
                document.getElementById('log-msg').innerText = "Conectando ao servidor...";
                const d = await this.req('user_info');
                
                if(d && d.user_info && d.user_info.auth == 1) {
                    localStorage.setItem('gh', h); localStorage.setItem('gu', this.auth.u); localStorage.setItem('gp', this.auth.pass);
                    document.getElementById('login-screen').classList.add('hide');
                    document.getElementById('dash-screen').classList.remove('hide');
                    this.activeState = 'dash';
                    this.mode('live');
                } else {
                    document.getElementById('log-msg').innerText = "Erro: Verifique URL/Usuário/Senha";
                }
            },

            mode: async function(m) {
                this.modeVal = m; this.cacheGlob = null;
                document.querySelectorAll('.icon-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('btn-'+m).classList.add('active');
                document.getElementById('crumb').style.display='none';
                document.getElementById('search').value = '';
                
                document.getElementById('cats').innerHTML = '...';
                document.getElementById('grid').innerHTML = '';

                let act = (m=='live')?'get_live_categories':(m=='movie'?'get_vod_categories':'get_series_categories');
                const cats = await this.req(act);
                
                if(cats) {
                    this.nav.cats = cats;
                    let h = '';
                    // Adicionei tabindex dinâmico
                    cats.forEach((c, i) => h += `<div class="cat-item focusable" tabindex="${100+i}" onclick="App.loadCat('${c.category_id}')">${c.category_name}</div>`);
                    document.getElementById('cats').innerHTML = h;
                    if(cats.length>0) this.loadCat(cats[0].category_id);
                }
            },

            loadCat: async function(cid) {
                // Remove active anterior
                document.querySelectorAll('.cat-item').forEach(c=>c.classList.remove('active'));
                
                // Marca o atual como ativo visualmente
                // Encontrar o elemento clicado seria ideal, mas simplificamos aqui
                const allCats = document.querySelectorAll('.cat-item');
                for(let c of allCats) {
                    if(c.getAttribute('onclick').includes(cid)) c.classList.add('active');
                }

                document.getElementById('grid').className = 'grid';
                document.getElementById('grid').innerHTML = '<div style="padding:20px">Carregando...</div>';
                
                let act = this.modeVal=='live'?'get_live_streams':(this.modeVal=='movie'?'get_vod_streams':'get_series');
                const items = await this.req(act, `&category_id=${cid}`);
                
                this.nav.items = items || [];
                this.render(this.nav.items);
            },

            render: function(list) {
                const g = document.getElementById('grid');
                g.innerHTML = '';
                if(!list || list.length===0) { g.innerHTML='<div style="padding:20px">Vazio</div>'; return; }
                
                list.slice(0, 100).forEach((i, idx) => {
                    const n = i.name || i.title;
                    const img = i.stream_icon || i.cover || '';
                    const d = document.createElement('div');
                    d.className = 'card focusable';
                    d.setAttribute('tabindex', 200 + idx); // Tabindex ajuda no foco nativo
                    d.onclick = () => this.click(i);
                    d.innerHTML = `<img src="${img}" class="card-img" onerror="this.style.opacity=0"><div class="card-ovl">${n}</div>`;
                    g.appendChild(d);
                });
            },

            // --- BUSCA ---
            filterLocal: function(t) {
                if(!t) { this.render(this.nav.items); return; }
                const c = t.toLowerCase();
                this.render(this.nav.items.filter(i => (i.name||i.title||"").toLowerCase().includes(c)));
            },

            searchGlobal: async function(t) {
                if(!t || t.length < 3) return;
                const stat = document.getElementById('status');
                stat.innerText = "Buscando Global...";
                document.getElementById('grid').innerHTML = '<div style="padding:20px">Baixando dados do servidor...</div>';

                if(!this.cacheGlob) {
                    let act = this.modeVal=='live'?'get_live_streams':(this.modeVal=='movie'?'get_vod_streams':'get_series');
                    const all = await this.req(act);
                    this.cacheGlob = all || [];
                }

                if(this.cacheGlob) {
                    const c = t.toLowerCase();
                    const res = this.cacheGlob.filter(i => (i.name||i.title||"").toLowerCase().includes(c));
                    stat.innerText = `${res.length} resultados.`;
                    this.render(res);
                } else {
                    stat.innerText = "Falha na busca.";
                    this.render([]);
                }
            },

            // --- LOGICA DE PLAYER ---
            click: async function(it) {
                if(this.modeVal !== 'series') {
                    this.nav.queue = [it]; this.playIdx = 0; this.play(it);
                } else {
                    const g = document.getElementById('grid');
                    g.innerHTML = 'Carregando...';
                    document.getElementById('crumb').style.display = 'block';
                    document.getElementById('crumb').innerHTML = `SÉRIES > <span>${it.name}</span>`;
                    
                    const info = await this.req('get_series_info', `&series_id=${it.series_id}`);
                    g.innerHTML = '';
                    
                    if(info.episodes) {
                        g.className = 'ep-list';
                        let epCount = 0;
                        Object.keys(info.episodes).forEach(s => {
                            info.episodes[s].forEach(ep => {
                                const d = document.createElement('div');
                                d.className = 'ep-row focusable';
                                d.setAttribute('tabindex', 300 + epCount++);
                                d.onclick = () => {
                                    this.nav.queue = info.episodes[s];
                                    this.playIdx = this.nav.queue.findIndex(x => x.id === ep.id);
                                    this.play(ep);
                                };
                                d.innerHTML = `<div class="ep-idx">T${s} E${ep.episode_num}</div><div>${ep.title}</div>`;
                                g.appendChild(d);
                            });
                        });
                        // Tenta focar no primeiro episódio
                        setTimeout(()=> {
                            const first = g.querySelector('.focusable');
                            if(first) { first.focus(); first.classList.add('focused'); }
                        }, 100);
                    }
                }
            },

            play: function(it) {
                this.stopEngine();

                const vid = document.getElementById('vid');
                const spin = document.getElementById('spin');
                
                document.getElementById('dash-screen').classList.add('hide');
                document.getElementById('player-screen').classList.remove('hide');
                this.activeState = 'player';
                spin.style.display = 'block';
                vid.focus(); // Foca no player para receber comandos

                const id = it.stream_id || it.id;
                let type, ext;
                
                if (this.modeVal === 'live') {
                    type = 'live';
                    ext = 'm3u8';
                } else {
                    type = this.modeVal === 'movie' ? 'movie' : 'series';
                    ext = it.container_extension || 'mp4';
                }

                const url = `${this.auth.h}/${type}/${this.auth.u}/${this.auth.pass}/${id}.${ext}`;
                console.log("Play:", url);

                if (ext === 'm3u8' || (Hls.isSupported() && url.includes('m3u8'))) {
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(vid);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
                    this.hls.on(Hls.Events.ERROR, (e,d) => { if(d.fatal) this.fail(); });
                } else {
                    vid.src = url;
                    vid.play().catch(e => { console.log("Erro nativo", e); this.fail(); });
                }

                vid.onplaying = () => spin.style.display = 'none';
                vid.onwaiting = () => spin.style.display = 'block';
                vid.onended = () => this.next();
                vid.onerror = () => this.fail();
            },

            next: function() {
                if(this.activeState !== 'player') return;
                if(this.nav.queue.length && this.playIdx < this.nav.queue.length-1) {
                    this.playIdx++;
                    this.play(this.nav.queue[this.playIdx]);
                } else this.close();
            },

            fail: function() {
                if(this.activeState !== 'player') return;
                clearTimeout(this.skipT);
                this.skipT = setTimeout(() => { this.next(); }, 3000);
            },

            stopEngine: function() {
                const vid = document.getElementById('vid');
                clearTimeout(this.skipT);
                this.skipT = null;
                vid.onerror = null;
                vid.onended = null;
                vid.pause();
                vid.removeAttribute('src');
                if(this.hls) { this.hls.destroy(); this.hls = null; }
            },

            close: function() {
                this.stopEngine();
                document.getElementById('player-screen').classList.add('hide');
                document.getElementById('dash-screen').classList.remove('hide');
                this.activeState = 'dash';
                // Devolve foco ao grid
                setTimeout(()=> {
                   const g = document.getElementById('grid');
                   if(g && g.firstChild) g.firstChild.focus();
                }, 100);
            },

            // --- SISTEMA DE CONTROLE REMOTO ---
            key: function(e) {
                const k = e.keyCode;
                // Códigos: Voltar(8,27,461,10009), Enter(13), Esq(37), Cima(38), Dir(39), Baixo(40)
                
                if([8,27,461,10009].includes(k)) {
                    e.preventDefault();
                    if(this.activeState === 'player') this.close();
                    else if(document.getElementById('grid').className == 'ep-list') {
                        this.loadCat(this.nav.cats[0].category_id);
                        document.getElementById('crumb').style.display='none';
                    }
                }
                else if(k === 13) {
                    // Enter
                    const act = document.activeElement;
                    if(act && act.classList.contains('focusable')) {
                        // Se for input, deixa o comportamento padrão (abrir teclado)
                        if(act.tagName === 'INPUT') return; 
                        e.preventDefault();
                        act.click();
                    }
                }
                else if([37,38,39,40].includes(k)) {
                    // Navegação Espacial
                    if(this.activeState === 'player') return; // Player usa nativo da TV (volume/seek)
                    e.preventDefault();
                    this.moveFocus(k);
                }
            },

            // Lógica para encontrar o elemento mais próximo na direção
            moveFocus: function(dir) {
                const els = Array.from(document.querySelectorAll('.focusable:not(.hide)'));
                // Filtra apenas visíveis
                const visible = els.filter(el => el.offsetParent !== null);
                
                const current = document.activeElement;
                if(!visible.includes(current)) {
                    if(visible.length > 0) {
                        visible[0].focus();
                        visible[0].classList.add('focused');
                    }
                    return;
                }

                const rect1 = current.getBoundingClientRect();
                let best = null;
                let minDist = Infinity;

                visible.forEach(el => {
                    if(el === current) return;
                    const rect2 = el.getBoundingClientRect();
                    
                    let dist = Infinity;
                    let valid = false;

                    // Centros
                    const c1 = { x: rect1.left + rect1.width/2, y: rect1.top + rect1.height/2 };
                    const c2 = { x: rect2.left + rect2.width/2, y: rect2.top + rect2.height/2 };

                    if(dir === 37) { // Esquerda
                        if(c2.x < c1.x && Math.abs(c2.y - c1.y) < rect1.height) { valid = true; dist = c1.x - c2.x; }
                    } else if(dir === 39) { // Direita
                        if(c2.x > c1.x && Math.abs(c2.y - c1.y) < rect1.height) { valid = true; dist = c2.x - c1.x; }
                    } else if(dir === 38) { // Cima
                        if(c2.y < c1.y) { valid = true; dist = Math.sqrt(Math.pow(c1.x-c2.x,2) + Math.pow(c1.y-c2.y,2)); }
                    } else if(dir === 40) { // Baixo
                        if(c2.y > c1.y) { valid = true; dist = Math.sqrt(Math.pow(c1.x-c2.x,2) + Math.pow(c1.y-c2.y,2)); }
                    }

                    if(valid && dist < minDist) {
                        minDist = dist;
                        best = el;
                    }
                });

                if(best) {
                    current.classList.remove('focused');
                    best.focus();
                    best.classList.add('focused');
                    best.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }
        };
    </script>
</body>
</html>
