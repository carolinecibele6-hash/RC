<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART UP - STB CORE V5.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>

    <style>
        /* --- CORE STB STYLES --- */
        :root {
            --bg-dark: #0f1114;
            --bg-panel: #16181c;
            --highlight: #ffcc00; /* Amarelo Padrão STB */
            --focus-bg: #e6b800;
            --text-main: #eeeeee;
            --text-dim: #888888;
            --border: #25282d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none !important; user-select: none; }
        
        body { 
            background: var(--bg-dark); color: var(--text-main); 
            font-family: 'Roboto Condensed', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
        }

        /* --- TELA DE LOGIN --- */
        #loginScreen {
            position: absolute; width: 100%; height: 100%; z-index: 9999;
            background: radial-gradient(circle at center, #1a1d21 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            width: 400px; padding: 40px; background: rgba(0,0,0,0.8); 
            border-top: 3px solid var(--highlight); text-align: center;
        }
        .lg-inp {
            width: 100%; padding: 12px; margin-bottom: 15px; 
            background: #222; border: 1px solid #444; color: #fff; text-align: center;
        }
        .lg-inp:focus { background: #fff; color: #000; border-color: var(--highlight); }
        .lg-btn {
            width: 100%; padding: 12px; background: var(--highlight); color: #000; 
            font-weight: bold; border: none; cursor: pointer; text-transform: uppercase;
        }
        .lg-btn:focus { box-shadow: 0 0 15px var(--highlight); transform: scale(1.02); }

        /* --- APP UI --- */
        #appInterface { display: none; width: 100%; height: 100%; flex-direction: column; }

        /* 1. TOPO */
        .top-bar {
            height: 45px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
            font-size: 13px; color: var(--text-dim);
        }
        .user-info b { color: var(--highlight); margin-left: 5px; }

        /* 2. MENU PRINCIPAL */
        .main-menu {
            height: 55px; background: linear-gradient(180deg, #25282d 0%, #16181c 100%);
            display: flex; align-items: center; padding: 0 20px; gap: 5px;
            border-bottom: 2px solid var(--highlight);
        }
        .menu-btn {
            padding: 0 20px; height: 35px; display: flex; align-items: center; gap: 8px;
            font-weight: bold; color: #aaa; border-radius: 3px; cursor: pointer; text-transform: uppercase;
        }
        .menu-btn.active-tab { color: #fff; background: rgba(255,255,255,0.1); }
        .menu-btn.focused { background: var(--highlight); color: #000; box-shadow: 0 0 10px rgba(255,204,0,0.3); }

        /* 3. ÁREA DE TRABALHO (3 Colunas) */
        .workspace { flex: 1; display: flex; overflow: hidden; }

        /* Coluna Categorias */
        .col-cat { width: 25%; background: #131518; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .head-title { padding: 10px; background: #000; color: #fff; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        .list-scroll { flex: 1; overflow-y: auto; }
        
        .item-row { padding: 10px 15px; border-bottom: 1px solid #1f2226; color: #999; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .item-row.active { color: #fff; background: #1f2226; border-left: 3px solid #ccc; }
        .item-row.focused { background: var(--focus-bg); color: #000; font-weight: bold; border-left: 3px solid #fff; transform: scale(1.01); z-index: 5; }

        /* Coluna Lista/Conteúdo */
        .col-list { width: 35%; background: #16181c; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .search-area { padding: 8px; background: #0a0a0a; border-bottom: 1px solid #333; }
        .search-input { 
            width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 6px; 
            text-transform: uppercase; font-weight: bold; text-align: center;
        }
        .search-input.focused { background: #fff; color: #000; border-color: var(--highlight); }

        /* Coluna Preview/Player */
        .col-view { flex: 1; background: #0f1114; display: flex; flex-direction: column; padding: 20px; }
        
        .player-frame {
            width: 100%; aspect-ratio: 16/9; background: #000; 
            border: 2px solid #333; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .player-frame.active-border { border-color: var(--highlight); }

        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* OSD (Barra de Séries/Filmes) */
        .vod-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0,0,0,0.85); display: none; align-items: center; padding: 0 15px; gap: 10px;
        }
        .vod-bar-bg { flex: 1; height: 5px; background: #444; border-radius: 2px; overflow: hidden; }
        .vod-bar-fill { height: 100%; background: var(--highlight); width: 0%; }
        .vod-time { font-family: monospace; font-size: 12px; color: #fff; }

        .meta-info { margin-top: 15px; }
        .meta-title { font-size: 20px; color: var(--highlight); font-weight: bold; margin-bottom: 5px; }
        .meta-desc { font-size: 13px; color: #aaa; line-height: 1.4; }

        /* FULLSCREEN REAL (Sem bordas) */
        .fullscreen-mode {
            position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important;
            z-index: 99999; background: #000; border: none !important; margin: 0; padding: 0;
        }

        /* 4. FOOTER */
        .footer-bar {
            height: 40px; background: #0a0a0a; border-top: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center; gap: 20px;
        }
        .f-btn { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: bold; color: #777; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body onload="App.init()">

    <div id="loginScreen">
        <div class="login-box">
            <div style="color:var(--highlight); font-size:24px; font-weight:bold; margin-bottom:20px;">SMART UP</div>
            <input type="text" id="url" class="lg-inp" placeholder="URL (http://...)" value="">
            <input type="text" id="user" class="lg-inp" placeholder="Usuário">
            <input type="password" id="pass" class="lg-inp" placeholder="Senha">
            <button id="btnLog" class="lg-btn" onclick="App.doLogin()">CONECTAR</button>
        </div>
    </div>

    <div id="appInterface">
        <div class="top-bar">
            <div class="user-info" id="userInfo">Conectando...</div>
            <div class="user-info" id="clock">00:00</div>
        </div>

        <div class="main-menu">
            <div class="menu-btn active-tab" id="menu-live"><i class="fas fa-tv"></i> TV</div>
            <div class="menu-btn" id="menu-vod"><i class="fas fa-film"></i> Filmes</div>
            <div class="menu-btn" id="menu-ser"><i class="fas fa-video"></i> Séries</div>
            <div class="menu-btn" id="menu-exit" style="margin-left:auto; color:#f44"><i class="fas fa-power-off"></i></div>
        </div>

        <div class="workspace">
            <div class="col-cat">
                <div class="head-title">Grupos</div>
                <div class="list-scroll" id="cat-list"></div>
            </div>

            <div class="col-list">
                <div class="head-title">Canais / Episódios</div>
                <div class="search-area">
                    <input type="text" id="search" class="search-input" placeholder="BUSCA" readonly>
                </div>
                <div class="list-scroll" id="content-list">
                    <div style="padding:20px;text-align:center;color:#444">Selecione um grupo</div>
                </div>
            </div>

            <div class="col-view">
                <div class="player-frame" id="vid-box">
                    <video id="player" playsinline></video>
                    <div class="vod-controls" id="vod-osd">
                        <i class="fas fa-play" style="color:#fff"></i>
                        <div class="vod-time" id="v-curr">00:00</div>
                        <div class="vod-bar-bg"><div class="vod-bar-fill" id="v-prog"></div></div>
                        <div class="vod-time" id="v-tot">00:00</div>
                    </div>
                </div>
                <div class="meta-info">
                    <div class="meta-title" id="m-title">Bem Vindo</div>
                    <div class="meta-desc" id="m-desc">Selecione uma categoria e um conteúdo para assistir.</div>
                </div>
            </div>
        </div>

        <div class="footer-bar">
            <div class="f-btn"><div class="dot" style="background:#f44"></div> Fullscreen</div>
            <div class="f-btn"><div class="dot" style="background:#4f4"></div> Atualizar</div>
            <div class="f-btn"><div class="dot" style="background:#ff4"></div> Busca</div>
            <div class="f-btn"><div class="dot" style="background:#44f"></div> Info</div>
        </div>
    </div>

    <script>
        // CONFIG
        const App = {
            state: 'login', // login, app
            mode: 'live',   // live, vod, ser
            zone: 0,        // 0:Menu, 1:Cat, 2:Search, 3:List
            idx: 0,         // Focus Index
            
            creds: {},
            cats: [],
            list: [],
            viewList: [],
            
            // Controle de Series
            isSeriesOpen: false,
            
            // Player
            currId: null,
            hls: null,

            init: function() {
                if(localStorage.getItem('stb_url')) {
                    document.getElementById('url').value = localStorage.getItem('stb_url');
                    document.getElementById('user').value = localStorage.getItem('stb_user');
                    document.getElementById('pass').value = localStorage.getItem('stb_pass');
                }
                document.getElementById('url').focus();
                
                setInterval(() => {
                    let d = new Date(); d.setHours(d.getHours()+1);
                    document.getElementById('clock').innerText = d.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
                }, 1000);

                // Eventos Player
                const vid = document.getElementById('player');
                vid.addEventListener('timeupdate', App.onTimeUpdate);
                vid.addEventListener('ended', App.onEnded);
                vid.addEventListener('error', (e) => {
                    console.log("Erro Player", e);
                    // Tenta reconectar se for live
                    if(App.mode === 'live' && App.currId) setTimeout(App.playCurrent, 2000);
                });
            },

            doLogin: async function() {
                let u = document.getElementById('url').value.trim();
                let n = document.getElementById('user').value.trim();
                let p = document.getElementById('pass').value.trim();
                if(!u.startsWith('http')) u = 'http://'+u;
                
                document.getElementById('btnLog').innerText = "Conectando...";
                try {
                    let res = await fetch(`${u}/player_api.php?username=${n}&password=${p}`);
                    let json = await res.json();
                    if(json.user_info && json.user_info.status === 'Active') {
                        localStorage.setItem('stb_url', u); localStorage.setItem('stb_user', n); localStorage.setItem('stb_pass', p);
                        App.creds = { u:u, n:n, p:p };
                        
                        let exp = new Date(parseInt(json.user_info.exp_date)*1000).toLocaleDateString('pt-BR');
                        document.getElementById('userInfo').innerHTML = `Vence: <b>${exp}</b>`;
                        
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appInterface').style.display = 'flex';
                        App.state = 'app';
                        App.setMode('live');
                    } else { alert("Login Inválido"); document.getElementById('btnLog').innerText = "CONECTAR"; }
                } catch(e) { alert("Erro Conexão"); document.getElementById('btnLog').innerText = "CONECTAR"; }
            },

            setMode: function(m) {
                App.mode = m; App.zone = 1; App.idx = 0; App.isSeriesOpen = false;
                App.list = []; App.viewList = [];
                App.stopPlayer();
                
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active-tab'));
                document.getElementById('menu-'+m).classList.add('active-tab');
                document.getElementById('content-list').innerHTML = '';
                document.getElementById('cat-list').innerHTML = '<div style="padding:10px;text-align:center">Carregando...</div>';

                let action = (m==='live') ? 'get_live_categories' : (m==='vod' ? 'get_vod_categories' : 'get_series_categories');
                
                fetch(`${App.creds.u}/player_api.php?username=${App.creds.n}&password=${App.creds.p}&action=${action}`)
                .then(r=>r.json()).then(data => {
                    App.cats = data;
                    // Adiciona Todos
                    App.cats.unshift({category_id:'all', category_name:'★ TODOS / BUSCA'});
                    
                    let html = '';
                    App.cats.forEach((c,i) => {
                        html += `<div class="item-row" id="cat-${i}" onclick="App.clickCat(${i})">${c.category_name}</div>`;
                    });
                    document.getElementById('cat-list').innerHTML = html;
                    App.renderFocus();
                }).catch(e=>console.log(e));
            },

            clickCat: function(i) {
                App.zone = 1; App.idx = i; App.renderFocus();
                App.loadList();
            },

            loadList: function() {
                let cat = App.cats[App.idx];
                let cid = cat.category_id;
                App.isSeriesOpen = false;
                
                document.getElementById('content-list').innerHTML = '<div style="padding:10px;text-align:center">Carregando...</div>';
                
                // Trava Input
                document.getElementById('search').setAttribute('readonly', true);

                let action = (App.mode==='live') ? 'get_live_streams' : (App.mode==='vod' ? 'get_vod_streams' : 'get_series');
                let url = `${App.creds.u}/player_api.php?username=${App.creds.n}&password=${App.creds.p}&action=${action}`;
                if(cid !== 'all') url += `&category_id=${cid}`;

                fetch(url).then(r=>r.json()).then(data => {
                    App.list = data;
                    App.viewList = [...data];
                    App.renderList();
                    App.zone = 3; App.idx = 0; App.renderFocus();
                });
            },

            openSeries: function(sid) {
                document.getElementById('content-list').innerHTML = '<div style="padding:10px;text-align:center">Carregando Episódios...</div>';
                fetch(`${App.creds.u}/player_api.php?username=${App.creds.n}&password=${App.creds.p}&action=get_series_info&series_id=${sid}`)
                .then(r=>r.json()).then(data => {
                    let eps = [];
                    if(data.episodes) {
                        for(let k in data.episodes) {
                            data.episodes[k].forEach(e => {
                                e.season_num = k; // Força numero season
                                eps.push(e);
                            });
                        }
                    }
                    App.list = eps; App.viewList = [...eps];
                    App.isSeriesOpen = true;
                    App.renderList();
                    App.zone = 3; App.idx = 0; App.renderFocus();
                });
            },

            renderList: function() {
                let html = '';
                if(App.isSeriesOpen) {
                    html += `<div class="item-row" id="item-back" onclick="App.loadList()" style="color:#aaa"><i class="fas fa-arrow-left"></i> VOLTAR</div>`;
                    App.viewList.forEach((item, i) => {
                        // NOME LIMPO
                        let title = item.title || item.name;
                        // Tenta montar S01 E01 se existir
                        let prefix = (item.season_num && item.episode_num) ? `S${item.season_num} E${item.episode_num} - ` : '';
                        html += `<div class="item-row" id="item-${i}" onclick="App.clickItem(${i})">${prefix}${title}</div>`;
                    });
                } else {
                    App.viewList.forEach((item, i) => {
                        let name = item.name || item.title;
                        html += `<div class="item-row" id="item-${i}" onclick="App.clickItem(${i})">${name}</div>`;
                    });
                }
                if(App.viewList.length===0) html = '<div style="padding:20px;text-align:center">Vazio</div>';
                document.getElementById('content-list').innerHTML = html;
            },

            clickItem: function(i) {
                App.zone = 3; App.idx = i; App.renderFocus();
                App.selectItem();
            },

            selectItem: function() {
                let item = App.viewList[App.idx];
                
                if(App.isSeriesOpen && App.idx === -1) { App.loadList(); return; } // Voltar

                if(App.mode === 'ser' && !App.isSeriesOpen) {
                    App.openSeries(item.series_id);
                } else {
                    // Tocar Live, Vod ou Episodio
                    let id = item.stream_id || item.id;
                    if(App.currId === id) {
                        App.toggleFS();
                    } else {
                        App.playItem(item);
                    }
                }
            },

            playItem: function(item) {
                let id = item.stream_id || item.id;
                App.currId = id;
                let vid = document.getElementById('player');
                let box = document.getElementById('vid-box');
                
                // Metadata
                document.getElementById('m-title').innerText = item.name || item.title;
                document.getElementById('m-desc').innerText = "Carregando...";
                box.classList.add('active-border');

                // STOP HLS
                if(App.hls) { App.hls.destroy(); App.hls=null; }

                // BUILD URL
                let ext = item.container_extension || 'mp4';
                if(App.mode === 'live') ext = 'ts'; // Live always TS
                else if(App.mode === 'ser' && !item.container_extension) ext = 'mkv'; // Series default mkv

                // IMPORTANT: SERIES USES /movie/ endpoint usually!
                let type = (App.mode === 'live') ? 'live' : 'movie';
                
                let url = `${App.creds.u}/${type}/${App.creds.n}/${App.creds.p}/${id}.${ext}`;

                // PLAY
                if(App.mode === 'live') {
                    // LIVE: Tenta TS Nativo -> HLS
                    vid.src = url;
                    vid.play().catch(e => {
                        console.log("TS Fail, trying HLS");
                        if(Hls.isSupported()) {
                            let hlsUrl = `${App.creds.u}/live/${App.creds.n}/${App.creds.p}/${id}.m3u8`;
                            App.hls = new Hls();
                            App.hls.loadSource(hlsUrl);
                            App.hls.attachMedia(vid);
                            App.hls.on(Hls.Events.MANIFEST_PARSED, ()=>vid.play());
                        }
                    });
                } else {
                    // VOD/SERIES: Direct
                    vid.src = url;
                    vid.play();
                }
            },

            onTimeUpdate: function() {
                if(App.mode === 'live') return;
                let vid = document.getElementById('player');
                if(vid.duration) {
                    let pct = (vid.currentTime/vid.duration)*100;
                    document.getElementById('v-prog').style.width = pct+'%';
                    // Simple formatting
                    document.getElementById('v-curr').innerText = Math.floor(vid.currentTime/60)+':'+Math.floor(vid.currentTime%60);
                    document.getElementById('v-tot').innerText = Math.floor(vid.duration/60)+':'+Math.floor(vid.duration%60);
                }
            },

            onEnded: function() {
                if(App.mode === 'live') { App.playCurrent(); } // Reconnect Live
                else if(App.mode === 'ser' && App.isSeriesOpen) {
                    // Next Ep
                    if(App.idx < App.viewList.length-1) {
                        App.idx++; App.renderFocus();
                        App.playItem(App.viewList[App.idx]);
                    } else App.toggleFS();
                } else {
                    App.toggleFS(); // Close FS
                }
            },

            toggleFS: function() {
                let box = document.getElementById('vid-box');
                if(box.classList.contains('fullscreen-mode')) {
                    box.classList.remove('fullscreen-mode');
                    if(document.exitFullscreen) document.exitFullscreen();
                    document.getElementById('vod-osd').style.display = 'none';
                } else {
                    box.classList.add('fullscreen-mode');
                    if(box.requestFullscreen) box.requestFullscreen();
                    if(App.mode !== 'live') document.getElementById('vod-osd').style.display = 'flex';
                }
            },

            renderFocus: function() {
                // Clear all
                document.querySelectorAll('.focused').forEach(e=>e.classList.remove('focused'));
                
                if(App.zone === 0) { // Menu
                    let ids = ['menu-live','menu-vod','menu-ser','menu-exit'];
                    document.getElementById(ids[App.idx]).classList.add('focused');
                } else if(App.zone === 1) { // Cat
                    let el = document.getElementById('cat-'+App.idx);
                    if(el) { el.classList.add('focused'); el.scrollIntoView({block:'center'}); }
                } else if(App.zone === 2) { // Search
                    document.getElementById('search').classList.add('focused');
                    document.getElementById('search').removeAttribute('readonly');
                    document.getElementById('search').focus();
                } else if(App.zone === 3) { // List
                    document.getElementById('search').setAttribute('readonly', true); // Lock search
                    let id = (App.isSeriesOpen && App.idx===-1) ? 'item-back' : 'item-'+App.idx;
                    let el = document.getElementById(id);
                    if(el) { el.classList.add('focused'); el.scrollIntoView({block:'center'}); }
                }
            },

            handleKey: function(k) {
                if(App.zone === 0) { // Menu
                    if(k===39 && App.idx<3) App.idx++;
                    if(k===37 && App.idx>0) App.idx--;
                    if(k===40) { App.zone=1; App.idx=0; }
                    if(k===13) {
                        if(App.idx===0) App.setMode('live');
                        if(App.idx===1) App.setMode('vod');
                        if(App.idx===2) App.setMode('ser');
                        if(App.idx===3) location.reload();
                    }
                } else if(App.zone === 1) { // Cat
                    if(k===38) { if(App.idx>0)App.idx--; else {App.zone=0;App.idx=0;} }
                    if(k===40 && App.idx<App.cats.length-1) App.idx++;
                    if(k===39) { App.zone=2; } // Right -> Search
                    if(k===13) App.loadList();
                } else if(App.zone === 2) { // Search
                    if(k===40 && App.viewList.length>0) { App.zone=3; App.idx=0; }
                    if(k===37) { App.zone=1; }
                    if(k===38) { App.zone=0; App.idx=0; }
                    // Digitação nativa
                } else if(App.zone === 3) { // List
                    if(k===38) { 
                        if(App.idx>0) App.idx--; 
                        else { App.zone=2; } // Up -> Search
                    }
                    if(k===40 && App.idx<App.viewList.length-1) App.idx++;
                    if(k===37) { App.zone=1; }
                    if(k===13) App.selectItem();
                }
                App.renderFocus();
            }
        };

        document.addEventListener('keydown', (e) => {
            let k = e.keyCode;
            if(App.state === 'login') {
                if(k===13) document.activeElement.click();
                if(k===40) { /* nav simples */ }
                return;
            }
            
            // Global Keys
            if(k===403||k===82) App.toggleFS(); // Red
            if(k===8||k===461||k===27) { // Back
                if(document.fullscreenElement || document.getElementById('vid-box').classList.contains('fullscreen-mode')) App.toggleFS();
                else if(App.zone===3 && App.isSeriesOpen) App.loadList();
                else if(App.zone===3) App.zone=1;
                else if(App.zone===1) App.zone=0;
                App.renderFocus();
            }
            
            if(App.zone!==2 && k>=37 && k<=40) e.preventDefault(); // Block scroll
            if(App.zone!==2 && k>=65 && k<=90) e.preventDefault(); // Block typing outside search
            
            App.handleKey(k);
        });
    </script>
</body>
</html>
