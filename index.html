<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKY GOLD - SPEED EDITION</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>

    <style>
        /* --- PERFORMANCE CSS --- */
        :root { --bg: #0b0b0b; --gold: #ffd700; --focus: #ffd700; --text: #ddd; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: system-ui, -apple-system, sans-serif; /* Fonte do Sistema é +Rápida */
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            text-rendering: optimizeSpeed; /* Prioriza velocidade sobre beleza */
        }

        /* ÍCONES SVG LEVES */
        .ico { width: 16px; height: 16px; fill: currentColor; display: inline-block; vertical-align: middle; }

        /* TELA LOGIN */
        #loginScreen { position: absolute; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { width: 400px; padding: 30px; border: 1px solid #333; background: #111; }
        .lg-inp { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: #fff; text-align: center; font-size: 16px; }
        .lg-inp:focus { background: #fff; color: #000; border-color: var(--gold); }
        .lg-btn { width: 100%; padding: 15px; background: var(--gold); font-weight: bold; border: none; cursor: pointer; font-size: 16px; color: #000; }
        
        /* INTERFACE */
        #appInterface { display: none; width: 100%; height: 100%; flex-direction: column; }
        
        .top-bar { height: 35px; background: #080808; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 12px; color: #666; border-bottom: 1px solid #222; }
        
        .main-nav { height: 50px; background: #111; display: flex; align-items: center; padding: 0 10px; border-bottom: 2px solid #333; }
        .nav-item { padding: 8px 20px; font-weight: bold; color: #888; text-transform: uppercase; font-size: 14px; display: flex; gap: 8px; align-items: center; }
        .nav-item.active-mode { color: #fff; border-bottom: 2px solid var(--gold); background: rgba(255,255,255,0.03); }
        .nav-item.focused { background: var(--gold); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); transform: scale(1.02); }

        .workspace { flex: 1; display: flex; overflow: hidden; background: #0e0e0e; }

        /* OTIMIZAÇÃO DE LISTAS: 'content-visibility' ajuda o browser a não renderizar o que não vê */
        .col-cats { width: 22%; background: #111; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .col-content { width: 30%; background: #161616; display: flex; flex-direction: column; border-right: 1px solid #222; }
        
        .list-container { flex: 1; overflow-y: auto; contain: content; /* PERFORMANCE BOOST */ }
        
        .list-item { 
            padding: 10px 12px; font-size: 13px; color: #bbb; border-bottom: 1px solid #1f1f1f;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            will-change: transform, background; /* Dica para GPU */
        }
        .list-item.active { background: #222; color: #fff; border-left: 3px solid #777; }
        .list-item.focused { background: var(--gold); color: #000; font-weight: bold; transform: translateX(5px); }

        .search-bar { padding: 8px; background: #000; }
        .search-inp { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 8px; font-size: 13px; text-transform: uppercase; }
        .search-inp.focused { background: #fff; color: #000; border-color: var(--gold); }

        /* PREVIEW AREA */
        .col-preview { flex: 1; padding: 20px; display: flex; flex-direction: column; background: #050505; }
        .preview-window { 
            width: 100%; aspect-ratio: 16/9; background: #000; position: relative; 
            border: 2px solid #222; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .preview-window.active { border-color: var(--gold); }
        
        video { width: 100%; height: 100%; object-fit: contain; }

        /* VOD OSD */
        .vod-osd { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: rgba(0,0,0,0.8); display: none; align-items: center; gap: 10px; z-index: 100; }
        .prog-bg { flex: 1; height: 5px; background: #333; }
        .prog-fill { height: 100%; background: var(--gold); width: 0%; }
        .osd-txt { font-family: monospace; font-size: 12px; color: #fff; }

        /* FULLSCREEN */
        .fs { position: fixed !important; top:0; left:0; width:100vw !important; height:100vh !important; z-index: 99999; border:none !important; margin:0 !important; background: #000; }

        .info-panel { margin-top: 20px; color: #888; font-size: 14px; }
        .info-title { color: var(--gold); font-size: 20px; font-weight: bold; margin-bottom: 10px; }

        /* UTILS */
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 0px; } /* Esconde scrollbar para ganhar performance de render */
    </style>
</head>
<body onload="App.init()">

    <svg style="display: none;">
        <symbol id="icon-tv" viewBox="0 0 512 512"><path d="M448 96H64C28.65 96 0 124.7 0 160v224c0 35.35 28.65 64 64 64h384c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64zM256 32c12.5 0 24.1 6.56 30.6 17.2L320 106h-32l-23-40.4L241 106h-31l32.9-57.2C249.2 38.3 253.1 32 256 32z"/></symbol>
        <symbol id="icon-film" viewBox="0 0 512 512"><path d="M448 64H64C28.65 64 0 92.65 0 128v256c0 35.3 28.65 64 64 64h384c35.3 0 64-28.7 64-64V128c0-35.35-28.7-64-64-64zM64 112h64v48H64v-48zm0 104h64v48H64v-48zm0 104h64v48H64v-48zm384 48h-64v-48h64v48zm0-104h-64v-48h64v48zm0-104h-64v-48h64v48z"/></symbol>
        <symbol id="icon-play" viewBox="0 0 448 512"><path d="M424.4 214.7L72.4 6.6C43.8-10.3 0 6.1 0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1 0-82.6z"/></symbol>
    </svg>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:var(--gold); text-align:center; margin-bottom:20px;">SKY FAST</h2>
            <input type="text" id="h" class="lg-inp" placeholder="URL (http://...)" autocomplete="off">
            <input type="text" id="u" class="lg-inp" placeholder="Usuário" autocomplete="off">
            <input type="password" id="p" class="lg-inp" placeholder="Senha">
            <button id="btnEnter" class="lg-btn" onclick="App.login()">ENTRAR</button>
        </div>
    </div>

    <div id="appInterface">
        <div class="top-bar">
            <span id="acc-info">Conectando...</span>
            <span id="clock" style="color:#fff; font-weight:bold;">00:00</span>
        </div>

        <div class="main-nav">
            <div class="nav-item active-mode" id="tab-live">
                <svg class="ico"><use xlink:href="#icon-tv"></use></svg> AO VIVO
            </div>
            <div class="nav-item" id="tab-vod">
                <svg class="ico"><use xlink:href="#icon-film"></use></svg> FILMES
            </div>
            <div class="nav-item" id="tab-ser">
                <svg class="ico"><use xlink:href="#icon-film"></use></svg> SÉRIES
            </div>
            <div class="nav-item" id="btn-logout" style="margin-left:auto; color:#d44;">SAIR</div>
        </div>

        <div class="workspace">
            <div class="col-cats">
                <div class="list-container" id="list-cats"></div>
            </div>

            <div class="col-content">
                <div class="search-bar">
                    <input type="text" id="search-input" class="search-inp" placeholder="BUSCAR..." onkeyup="App.debouncedSearch(event)">
                </div>
                <div class="list-container" id="list-cnt">
                    <div style="padding:20px; text-align:center; color:#555">Selecione uma categoria</div>
                </div>
            </div>

            <div class="col-preview">
                <div class="preview-window" id="v-box">
                    <video id="player" playsinline></video>
                    <div id="vod-osd" class="vod-osd">
                        <svg class="ico" id="play-icon" style="fill:#fff"><use xlink:href="#icon-play"></use></svg>
                        <div class="osd-txt" id="vod-curr">00:00</div>
                        <div class="prog-bg"><div class="prog-fill" id="vod-prog"></div></div>
                        <div class="osd-txt" id="vod-total">00:00</div>
                    </div>
                </div>
                <div class="info-panel">
                    <div class="info-title" id="lbl-title">Bem Vindo</div>
                    <div id="lbl-desc">Modo de Alta Performance ativado.</div>
                    <br>
                    <div style="font-size:12px; color:#555">
                        [ OK 1x ] Preview &nbsp;&nbsp; [ OK 2x ] Tela Cheia<br>
                        Dica: Use a BUSCA para encontrar canais rapidamente.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let hls = null;
        // CONFIG HLS OTIMIZADA PARA VELOCIDADE
        const HlsConfig = {
            autoStartLoad: true, startPosition: -1,
            maxBufferLength: 10, // Buffer menor = menos RAM
            enableWorker: true,
            startFragPrefetch: true, // Inicia mais rápido
            manifestLoadingTimeOut: 10000
        };

        const App = {
            screen: 'login', mode: 'live', zone: 0, focusIdx: 0,
            cats: [], list: [], viewList: [], creds: {},
            currentStreamId: null, isVodPlaying: false,
            searchTimer: null, maxRender: 100, // LIMITADOR DE RENDERIZAÇÃO (SEGREDO DA VELOCIDADE)

            init: function() {
                if(localStorage.getItem('sf_h')) {
                    document.getElementById('h').value = localStorage.getItem('sf_h');
                    document.getElementById('u').value = localStorage.getItem('sf_u');
                    document.getElementById('p').value = localStorage.getItem('sf_p');
                    document.getElementById('btnEnter').focus();
                } else {
                    document.getElementById('h').focus();
                }
                setInterval(() => {
                    let d = new Date(); d.setHours(d.getHours()+1);
                    document.getElementById('clock').innerText = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
                }, 60000);
                
                // VOD Listeners
                const vid = document.getElementById('player');
                vid.addEventListener('timeupdate', App.updateVodUI);
                vid.addEventListener('ended', () => App.exitFullscreen());
            },

            login: async function() {
                let h = document.getElementById('h').value.trim();
                let u = document.getElementById('u').value.trim();
                let p = document.getElementById('p').value.trim();
                if(!h.startsWith('http')) h = 'http://'+h;
                if(h.endsWith('/')) h = h.slice(0, -1);
                
                document.getElementById('btnEnter').innerText = "...";
                
                try {
                    let r = await fetch(`${h}/player_api.php?username=${u}&password=${p}`);
                    let d = await r.json();
                    if(d.user_info && d.user_info.status === 'Active') {
                        localStorage.setItem('sf_h', h); localStorage.setItem('sf_u', u); localStorage.setItem('sf_p', p);
                        this.creds = {h,u,p};
                        
                        let info = d.user_info;
                        let exp = new Date(parseInt(info.exp_date)*1000).toLocaleDateString('pt-BR');
                        document.getElementById('acc-info').innerHTML = `Exp: ${exp} | Telas: ${info.active_cons}/${info.max_connections}`;
                        
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appInterface').style.display = 'flex';
                        this.screen = 'app';
                        this.switchMode('live');
                    } else { alert('Erro Login'); document.getElementById('btnEnter').innerText = "ENTRAR"; }
                } catch(e) { alert('Erro Conexão'); document.getElementById('btnEnter').innerText = "ENTRAR"; }
            },

            switchMode: async function(m) {
                this.mode = m; this.zone = 1; this.focusIdx = 0;
                this.list = []; this.viewList = [];
                this.stopPlayer();
                document.getElementById('list-cnt').innerHTML = '';
                document.getElementById('search-input').value = '';
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-mode'));
                document.getElementById('tab-'+m).classList.add('active-mode');

                let act = (m==='live')?'get_live_categories':(m==='vod'?'get_vod_categories':'get_series_categories');
                
                document.getElementById('list-cats').innerHTML = '<div style="padding:10px">Carregando...</div>';
                try {
                    let r = await fetch(`${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${act}`);
                    this.cats = await r.json();
                    this.cats.unshift({category_id:'all', category_name:'★ TODOS (BUSCA GLOBAL)'});
                    
                    // Render Cats via Fragment (Mais rápido)
                    let frag = document.createDocumentFragment();
                    this.cats.forEach((c, i) => {
                        let d = document.createElement('div');
                        d.className = 'list-item';
                        d.id = `cat-${i}`;
                        d.innerText = c.category_name;
                        frag.appendChild(d);
                    });
                    document.getElementById('list-cats').innerHTML = '';
                    document.getElementById('list-cats').appendChild(frag);
                    this.renderFocus();
                } catch(e){}
            },

            loadContent: async function() {
                let cat = this.cats[this.focusIdx];
                let cid = cat.category_id;
                
                document.getElementById('list-cnt').innerHTML = '<div style="padding:20px">Carregando...</div>';
                
                let act = '';
                if(this.mode === 'live') act = 'get_live_streams';
                else if(this.mode === 'vod') act = 'get_vod_streams';
                else act = 'get_series';

                try {
                    let url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${act}`;
                    if(cid !== 'all') url += `&category_id=${cid}`;
                    
                    let r = await fetch(url);
                    this.list = await r.json();
                    this.viewList = [...this.list];
                    
                    this.renderContentList();
                    this.zone = 2; document.getElementById('search-input').focus(); 
                } catch(e) { document.getElementById('list-cnt').innerHTML = 'Erro'; }
            },

            debouncedSearch: function(e) {
                clearTimeout(this.searchTimer);
                this.searchTimer = setTimeout(() => {
                    let term = e.target.value.toLowerCase();
                    if(term.length === 0) {
                        this.viewList = [...this.list];
                    } else {
                        this.viewList = this.list.filter(i => (i.name || i.title || '').toLowerCase().includes(term));
                    }
                    this.renderContentList();
                }, 300); // Espera 300ms antes de filtrar (Evita travar digitando)
                
                if(e.keyCode === 13) { this.zone = 3; this.focusIdx = 0; document.getElementById('search-input').blur(); this.renderFocus(); }
            },

            renderContentList: function() {
                let frag = document.createDocumentFragment();
                // OTIMIZAÇÃO CRÍTICA: Renderiza apenas os primeiros 100 itens
                let limit = Math.min(this.viewList.length, this.maxRender);
                
                for(let i=0; i<limit; i++) {
                    let item = this.viewList[i];
                    let d = document.createElement('div');
                    d.className = 'list-item';
                    if(this.currentStreamId == (item.stream_id || item.id)) d.classList.add('active');
                    d.id = `cnt-${i}`;
                    d.innerText = item.name || item.title;
                    frag.appendChild(d);
                }
                
                if(this.viewList.length > this.maxRender) {
                    let more = document.createElement('div');
                    more.style.padding = "10px"; more.style.color = "#888"; more.style.textAlign="center";
                    more.innerText = `...e mais ${this.viewList.length - this.maxRender} itens. Use a BUSCA.`;
                    frag.appendChild(more);
                }
                
                if(limit === 0) {
                    let d = document.createElement('div'); d.innerText = "Nada encontrado."; d.style.padding="20px"; frag.appendChild(d);
                }

                let c = document.getElementById('list-cnt');
                c.innerHTML = '';
                c.appendChild(frag);
            },

            openSeries: async function(sid) {
                try {
                    let r = await fetch(`${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=get_series_info&series_id=${sid}`);
                    let d = await r.json();
                    let eps = [];
                    if(d.episodes) {
                        for(let k in d.episodes) d.episodes[k].forEach(e => eps.push({...e, name:`S${k} E${e.episode_num} - ${e.title}`}));
                    }
                    this.list = eps; this.viewList = eps;
                    this.renderContentList();
                    this.zone=3; this.focusIdx=0; this.renderFocus();
                } catch(e){}
            },

            play: function(idx) {
                let item = this.viewList[idx];
                if(this.mode === 'ser' && !item.container_extension) { this.openSeries(item.series_id); return; }

                let vid = document.getElementById('player');
                let sid = item.stream_id || item.id;
                
                if(this.currentStreamId === sid) { this.enterFS(); return; }
                this.currentStreamId = sid;

                let ext = item.container_extension || (this.mode==='live'?'ts':'mp4');
                let type = this.mode==='live'?'live':(this.mode==='ser'?'series':'movie');
                let url = `${this.creds.h}/${type}/${this.creds.u}/${this.creds.p}/${sid}.${ext}`;

                document.getElementById('lbl-title').innerText = item.name || item.title;
                document.getElementById('v-box').classList.add('active');
                
                this.isVodPlaying = (this.mode !== 'live');
                if(this.isVodPlaying) document.getElementById('vod-osd').style.display = 'none';

                if(hls) { hls.destroy(); hls = null; }
                if(Hls.isSupported() && !vid.canPlayType('application/vnd.apple.mpegurl')) {
                    hls = new Hls(HlsConfig);
                    hls.loadSource(url);
                    hls.attachMedia(vid);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
                } else {
                    vid.src = url;
                    vid.play();
                }
                this.renderContentList(); // Atualiza highlight active
                this.renderFocus(); // Mantem foco
            },

            stopPlayer: function() {
                let vid = document.getElementById('player');
                vid.pause(); vid.src="";
                if(hls) { hls.destroy(); hls=null; }
                this.currentStreamId = null;
                this.isVodPlaying = false;
                document.getElementById('v-box').classList.remove('active');
                document.getElementById('vod-osd').style.display='none';
            },

            updateVodUI: function() {
                if(!App.isVodPlaying) return;
                let v = document.getElementById('player');
                if(!v.duration) return;
                let pct = (v.currentTime/v.duration)*100;
                document.getElementById('vod-prog').style.width = pct+'%';
                
                const fmt = (s) => new Date(s*1000).toISOString().substr(11,8);
                document.getElementById('vod-curr').innerText = fmt(v.currentTime);
                document.getElementById('vod-total').innerText = fmt(v.duration);
            },

            enterFS: function() {
                let b = document.getElementById('v-box');
                b.classList.add('fs');
                if(b.requestFullscreen) b.requestFullscreen();
            },
            exitFullscreen: function() {
                let b = document.getElementById('v-box');
                b.classList.remove('fs');
                if(document.exitFullscreen) document.exitFullscreen();
            },

            renderFocus: function() {
                document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused'));
                if(this.zone === 0) {
                    let ids = ['tab-live','tab-vod','tab-ser','btn-logout'];
                    document.getElementById(ids[this.focusIdx]).classList.add('focused');
                } else if(this.zone === 1) {
                    let el = document.getElementById(`cat-${this.focusIdx}`);
                    if(el) { el.classList.add('focused'); el.scrollIntoView({block:'center'}); }
                } else if(this.zone === 2) {
                    document.getElementById('search-input').classList.add('focused');
                } else if(this.zone === 3) {
                    let el = document.getElementById(`cnt-${this.focusIdx}`);
                    if(el) { el.classList.add('focused'); el.scrollIntoView({block:'center'}); }
                }
            },

            handleKey: function(k) {
                if(this.zone === 0) { // NAV
                    if(k==39 && this.focusIdx<3) this.focusIdx++;
                    if(k==37 && this.focusIdx>0) this.focusIdx--;
                    if(k==40) { this.zone=1; this.focusIdx=0; }
                    if(k==13) {
                        if(this.focusIdx==0) this.switchMode('live');
                        if(this.focusIdx==1) this.switchMode('vod');
                        if(this.focusIdx==2) this.switchMode('ser');
                        if(this.focusIdx==3) { localStorage.clear(); location.reload(); }
                    }
                }
                else if(this.zone === 1) { // CATS
                    if(k==38) { if(this.focusIdx>0) this.focusIdx--; else {this.zone=0; this.focusIdx=0;} }
                    if(k==40 && this.focusIdx < this.cats.length-1) this.focusIdx++;
                    if(k==39) { this.zone=2; document.getElementById('search-input').focus(); }
                    if(k==13) this.loadContent();
                }
                else if(this.zone === 2) { // SEARCH
                    if(k==40) { this.zone=3; this.focusIdx=0; document.getElementById('search-input').blur(); }
                    if(k==37) { this.zone=1; document.getElementById('search-input').blur(); }
                    if(k==13) this.debouncedSearch({target:document.getElementById('search-input'), keyCode:13});
                }
                else if(this.zone === 3) { // LIST
                    let limit = Math.min(this.viewList.length, this.maxRender);
                    if(k==38) { if(this.focusIdx>0) this.focusIdx--; else {this.zone=2; document.getElementById('search-input').focus();} }
                    if(k==40 && this.focusIdx < limit-1) this.focusIdx++;
                    if(k==37) { this.zone=1; }
                    if(k==13) this.play(this.focusIdx);
                }
                this.renderFocus();
            }
        };

        document.addEventListener('keydown', (e) => {
            let k = e.keyCode;
            let isFs = document.getElementById('v-box').classList.contains('fs');

            if(isFs) {
                let v = document.getElementById('player');
                document.getElementById('vod-osd').style.display='flex';
                setTimeout(()=>document.getElementById('vod-osd').style.display='none', 3000);
                
                if(k==8 || k==27 || k==461 || k==10009) { App.exitFullscreen(); e.preventDefault(); return; }
                if(App.isVodPlaying) {
                    if(k==39) v.currentTime+=10;
                    if(k==37) v.currentTime-=10;
                    if(k==13) v.paused ? v.play() : v.pause();
                }
                return;
            }

            if(k==8 || k==27 || k==461 || k==10009) { 
                if(App.zone==3 || App.zone==2) App.zone=1; else if(App.zone==1) App.zone=0; 
                App.renderFocus(); return; 
            }

            if(App.screen === 'login') return; // Login padrão browser
            if(App.zone === 2 && ((k>=48 && k<=90)||k==8||k==32)) return; // Digitação
            if([37,38,39,40,13].includes(k)) e.preventDefault();
            
            App.handleKey(k);
        });
    </script>
</body>
</html>
