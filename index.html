<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&C GOLD NETRANGE V31</title>
    <style>
        /* --- TEMA NETRANGE EXTREME (V31) --- */
        /* Design "Brutalista" para performance máxima */
        :root { 
            --bg: #000000; 
            --gold: #FFD700; 
            --sel: #FFFFFF;
            --text: #AAAAAA;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: sans-serif; /* Fonte nativa é mais leve */
            width: 1280px; height: 720px; /* Resolução fixa HD evita recálculos */
            overflow: hidden; 
        }

        .hide { display: none !important; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #000; }

        /* LOGIN */
        #login-layer { z-index: 50; padding-top: 100px; text-align: center; }
        .login-box {
            display: inline-block; width: 400px; padding: 20px; background: #111; border: 2px solid #333;
        }
        .nr-title { color: var(--gold); font-size: 30px; font-weight: bold; margin-bottom: 20px; }
        
        input {
            width: 100%; padding: 10px; margin-bottom: 10px;
            background: #333; border: 1px solid #555; color: #fff; font-size: 18px; text-align: center;
        }
        input.focused { background: #fff; color: #000; border: 2px solid var(--gold); }
        
        button {
            width: 100%; padding: 10px; margin-top: 10px;
            background: #006400; color: #fff; font-size: 18px; border: none;
        }
        button.focused { background: var(--gold); color: #000; }

        /* MENU PRINCIPAL */
        #dash-layer { text-align: center; padding-top: 50px; }
        .dash-logo { font-size: 60px; color: #fff; font-weight: bold; margin-bottom: 50px; }
        .dash-logo span { color: var(--gold); }
        
        .dash-row { display: flex; justify-content: center; gap: 20px; }
        .dash-card {
            width: 200px; height: 150px; background: #111; border: 2px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: #888;
        }
        .dash-card.focused { background: var(--gold); color: #000; border: 4px solid #fff; }

        .dash-info { margin-top: 50px; font-size: 14px; color: #555; }

        /* CONTEÚDO */
        #content-layer { display: flex; height: 100%; }
        
        /* Coluna Categorias */
        .col-cat { width: 300px; background: #080808; border-right: 2px solid #333; display: flex; flex-direction: column; }
        .cat-head { padding: 15px; font-size: 20px; color: var(--gold); background: #111; font-weight: bold; text-align: center; }
        .cat-list { flex: 1; overflow-y: hidden; position: relative; } /* Overflow hidden para performance, scroll manual JS */
        
        .cat-item { 
            padding: 10px; border-bottom: 1px solid #222; 
            font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .cat-item.active { background: #222; color: #fff; }
        .cat-item.focused { background: var(--gold); color: #000; font-weight: bold; }

        /* Coluna Lista */
        .col-list { width: 400px; background: #111; border-right: 2px solid #333; display: flex; flex-direction: column; }
        .search-div { padding: 5px; background: #000; }
        .item-list { flex: 1; overflow-y: hidden; }
        
        .item { 
            padding: 10px; border-bottom: 1px solid #222; color: #999;
            font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item.focused { background: #fff; color: #000; font-weight: bold; }

        /* Player */
        .col-play { flex: 1; background: #000; display: flex; flex-direction: column; }
        .video-wrapper { 
            width: 100%; height: 60%; background: #000; border-bottom: 2px solid #333; 
            display: flex; align-items: center; justify-content: center;
        }
        .video-wrapper.focused { border: 4px solid var(--gold); }
        
        video { width: 100%; height: 100%; background: #000; }
        
        .meta-info { padding: 20px; color: #fff; }
        .m-title { font-size: 24px; color: var(--gold); margin-bottom: 10px; font-weight: bold; }
        .m-desc { font-size: 14px; color: #888; }

        /* Fullscreen Nativo */
        .fs-mode { position: fixed; top:0; left:0; width:1280px; height:720px; z-index: 9999; border:none; }

        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9000; display: none; 
            align-items: center; justify-content: center; 
            color: var(--gold); font-size: 30px; font-weight: bold;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body onload="App.init()">

    <div id="loader">CARREGANDO...</div>

    <div id="login-layer" class="layer">
        <div class="login-box">
            <div class="nr-title">R&C GOLD LITE</div>
            <input type="text" id="url" class="focused" placeholder="URL http://..." autocomplete="off">
            <input type="text" id="user" placeholder="Usuário" autocomplete="off">
            <input type="password" id="pass" placeholder="Senha" autocomplete="off">
            <button id="btn-login" onclick="App.doLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="dash-layer" class="layer hide">
        <div class="dash-logo">R&C <span>GOLD</span></div>
        <div class="dash-row">
            <div class="dash-card" id="m0">TV AO VIVO</div>
            <div class="dash-card" id="m1">FILMES</div>
            <div class="dash-card" id="m2">SÉRIES</div>
            <div class="dash-card" id="m3">SAIR</div>
        </div>
        <div class="dash-info">VERSÃO PHILCO NETRANGE • V31</div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-div">
                <input type="text" id="search" placeholder="BUSCAR..." style="width:100%; padding:5px;">
            </div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="vid-box" class="video-wrapper">
                <video id="player" playsinline></video>
            </div>
            <div class="meta-info">
                <div id="m-title" class="m-title">Selecione</div>
                <div id="m-desc" class="m-desc">Aguardando...</div>
                <div style="margin-top:20px; font-size:12px; color:#555;">
                    [OK] TELA CHEIA &nbsp; [VOLTAR] SAIR
                </div>
            </div>
        </div>
    </div>

    <script>
        var App = {
            screen: 0, // 0:Login, 1:Dash, 2:Content
            col: 0, // 0:Cat, 1:List, 2:Video
            idx: 0, // Login Index
            
            // Dados
            creds: {h:'', u:'', p:''},
            mode: 'live', // live, movie, series
            cats: [],
            items: [],
            
            // Controle de Lista (Paginação Virtual Simples)
            catIdx: 0,
            itemIdx: 0,
            listScroll: 0,
            catScroll: 0,

            init: function() {
                var h = localStorage.getItem('rc_h');
                if(h) {
                    document.getElementById('url').value = h;
                    document.getElementById('user').value = localStorage.getItem('rc_u');
                    document.getElementById('pass').value = localStorage.getItem('rc_p');
                }
                this.updateFocus();
            },

            // --- API SIMPLES (XTREAM) ---
            api: function(params, callback) {
                document.getElementById('loader').style.display = 'flex';
                var x = new XMLHttpRequest();
                // Anti-Cache String
                var url = this.creds.h + "/player_api.php?username=" + this.creds.u + "&password=" + this.creds.p + "&" + params;
                x.open("GET", url, true);
                x.timeout = 15000;
                x.onload = function() {
                    document.getElementById('loader').style.display = 'none';
                    if(x.status === 200) {
                        try { callback(JSON.parse(x.responseText)); } 
                        catch(e) { callback([]); }
                    } else callback([]);
                };
                x.onerror = function() { document.getElementById('loader').style.display = 'none'; alert("Erro Conexão"); };
                x.send();
            },

            doLogin: function() {
                var h = document.getElementById('url').value;
                var u = document.getElementById('user').value;
                var p = document.getElementById('pass').value;
                if(h.indexOf('http') === -1) h = 'http://' + h;
                
                this.creds = {h:h, u:u, p:p};
                var me = this;
                this.api("", function(d){
                    if(d && d.user_info && d.user_info.auth === 1) {
                        localStorage.setItem('rc_h', h); localStorage.setItem('rc_u', u); localStorage.setItem('rc_p', p);
                        me.openDash();
                    } else { alert("Login Falhou"); }
                });
            },

            openDash: function() {
                this.screen = 1; this.idx = 0;
                document.getElementById('login-layer').classList.add('hide');
                document.getElementById('dash-layer').classList.remove('hide');
                document.getElementById('content-layer').classList.add('hide');
                this.updateFocus();
            },

            openContent: function(mode) {
                if(mode === 'exit') { localStorage.clear(); location.reload(); return; }
                
                this.mode = mode;
                this.screen = 2; this.col = 0; this.catIdx = 0; this.catScroll = 0;
                
                document.getElementById('dash-layer').classList.add('hide');
                document.getElementById('content-layer').classList.remove('hide');
                
                // Limpa player
                var v = document.getElementById('player'); v.src = "";
                
                // Chama API correta para CATEGORIAS
                var action = 'get_live_categories';
                if(mode === 'movie') action = 'get_vod_categories';
                if(mode === 'series') action = 'get_series_categories';
                
                var me = this;
                this.api("action=" + action, function(data){
                    me.cats = data || [];
                    me.renderCats();
                    if(me.cats.length > 0) me.loadItems(0); // Carrega a primeira automaticamente
                });
            },

            renderCats: function() {
                // Renderiza APENAS o que cabe na tela (Top 15) + Scroll lógico
                var el = document.getElementById('cat-list');
                var html = '';
                var start = this.catScroll;
                var end = start + 15; // NetRange não aguenta 100 divs
                if(end > this.cats.length) end = this.cats.length;

                for(var i=0; i<this.cats.length; i++) {
                    // Esconde itens fora da visão via CSS display none para economizar RAM
                    var display = (i >= start && i < end) ? 'block' : 'none';
                    var active = (i === this.catIdx) ? 'active' : '';
                    if(i === this.catIdx && this.col === 0) active += ' focused';
                    
                    html += '<div class="cat-item '+active+'" style="display:'+display+'">' + this.cats[i].category_name + '</div>';
                }
                el.innerHTML = html;
            },

            loadItems: function(cIdx) {
                var catId = this.cats[cIdx].category_id;
                var action = 'get_live_streams';
                if(this.mode === 'movie') action = 'get_vod_streams';
                if(this.mode === 'series') action = 'get_series';
                
                var me = this;
                this.api("action=" + action + "&category_id=" + catId, function(data){
                    me.items = data || [];
                    me.itemIdx = 0; me.listScroll = 0;
                    me.renderItems();
                });
            },

            renderItems: function() {
                var el = document.getElementById('item-list');
                var html = '';
                
                // LIMITADOR RIGOROSO: Renderiza apenas 12 itens visíveis
                var start = this.listScroll;
                var end = start + 12;
                if(end > this.items.length) end = this.items.length;

                if(this.items.length === 0) {
                    el.innerHTML = '<div style="padding:10px;color:#555">Vazio</div>';
                    return;
                }

                for(var i=0; i<this.items.length; i++) {
                    var display = (i >= start && i < end) ? 'block' : 'none';
                    var focused = (i === this.itemIdx && this.col === 1) ? 'focused' : '';
                    var name = this.items[i].name || this.items[i].title;
                    
                    html += '<div class="item '+focused+'" style="display:'+display+'">' + name + '</div>';
                }
                el.innerHTML = html;
            },

            play: function() {
                var item = this.items[this.itemIdx];
                var v = document.getElementById('player');
                var url = "";
                
                // Construção URL Simples
                var ext = (this.mode === 'live') ? 'ts' : 'mp4';
                if(this.mode !== 'live' && item.container_extension) ext = item.container_extension;
                
                var id = item.stream_id || item.series_id;
                var type = (this.mode === 'live') ? 'live' : (this.mode === 'movie' ? 'movie' : 'series');
                
                // Se for série, precisa pegar episódio (Simplificado: Toca S01E01 se possível ou alerta)
                if(this.mode === 'series') {
                    alert("Selecione Filmes ou TV. Séries pesado para esta TV.");
                    return;
                }

                url = this.creds.h + "/" + type + "/" + this.creds.u + "/" + this.creds.p + "/" + id + "." + ext;
                
                // Correção AO VIVO NetRange: Tenta HLS se for .ts
                if(this.mode === 'live') {
                    if(Hls.isSupported()) {
                        var hls = new Hls();
                        // Converte URL para m3u8 internamente para o HLS.js processar
                        var m3u8Url = url.replace('.ts', '.m3u8'); 
                        hls.loadSource(m3u8Url);
                        hls.attachMedia(v);
                        hls.on(Hls.Events.MANIFEST_PARSED,function() { v.play(); });
                    } else {
                        v.src = url; v.play();
                    }
                } else {
                    // VOD: Direto
                    v.src = url; v.play();
                }

                document.getElementById('m-title').innerText = item.name || item.title;
                document.getElementById('m-desc').innerText = "Reproduzindo...";
            },

            toggleFull: function() {
                var box = document.getElementById('vid-box');
                if(box.classList.contains('fs-mode')) box.classList.remove('fs-mode');
                else box.classList.add('fs-mode');
            },

            updateFocus: function() {
                // Remove todos focos
                var all = document.querySelectorAll('.focused');
                for(var i=0; i<all.length; i++) all[i].classList.remove('focused');

                if(this.screen === 0) {
                    var ids = ['url', 'user', 'pass', 'btn-login'];
                    document.getElementById(ids[this.idx]).classList.add('focused');
                    if(this.idx < 3) document.getElementById(ids[this.idx]).focus();
                } 
                else if(this.screen === 1) {
                    document.getElementById('m'+this.idx).classList.add('focused');
                }
                else if(this.screen === 2) {
                    if(this.col === 0) this.renderCats(); // Re-renderiza para aplicar classe
                    if(this.col === 1) this.renderItems();
                    if(this.col === 2) {
                        document.getElementById('vid-box').classList.add('focused');
                        document.getElementById('search').blur();
                    }
                    
                    // Foco Input Busca
                    if(this.col === 1 && this.itemIdx === -1) document.getElementById('search').focus();
                    else document.getElementById('search').blur();
                }
            },

            move: function(dir) {
                if(this.screen === 0) {
                    if(dir === 'down' && this.idx < 3) this.idx++;
                    if(dir === 'up' && this.idx > 0) this.idx--;
                    this.updateFocus();
                }
                else if(this.screen === 1) {
                    if(dir === 'right' && this.idx < 3) this.idx++;
                    if(dir === 'left' && this.idx > 0) this.idx--;
                    this.updateFocus();
                }
                else if(this.screen === 2) {
                    // COLUNA CATEGORIA
                    if(this.col === 0) {
                        if(dir === 'down' && this.catIdx < this.cats.length-1) {
                            this.catIdx++;
                            if(this.catIdx >= this.catScroll + 15) this.catScroll++; // Scroll Logic
                        }
                        if(dir === 'up' && this.catIdx > 0) {
                            this.catIdx--;
                            if(this.catIdx < this.catScroll) this.catScroll--;
                        }
                        if(dir === 'right' || dir === 'enter') {
                            this.loadItems(this.catIdx);
                            this.col = 1; 
                        }
                    }
                    // COLUNA LISTA
                    else if(this.col === 1) {
                        if(dir === 'down' && this.itemIdx < this.items.length-1) {
                            this.itemIdx++;
                            if(this.itemIdx >= this.listScroll + 12) this.listScroll++;
                        }
                        if(dir === 'up') {
                            if(this.itemIdx > 0) {
                                this.itemIdx--;
                                if(this.itemIdx < this.listScroll) this.listScroll--;
                            } else {
                                // Subir para busca? Por enquanto mantem na lista
                            }
                        }
                        if(dir === 'left') this.col = 0;
                        if(dir === 'right') this.col = 2;
                        if(dir === 'enter') {
                            this.col = 2; 
                            this.play();
                        }
                    }
                    // VIDEO
                    else if(this.col === 2) {
                        if(dir === 'left') this.col = 1;
                        if(dir === 'enter') this.toggleFull();
                    }
                    this.updateFocus();
                }
            }
        };

        // CONTROLES
        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            if(k === 13) { // Enter
                if(App.screen === 0 && App.idx === 3) App.doLogin();
                else if(App.screen === 1) {
                    var modes = ['live', 'movie', 'series', 'exit'];
                    App.openContent(modes[App.idx]);
                }
                else App.move('enter');
            }
            else if(k === 37) App.move('left');
            else if(k === 38) App.move('up');
            else if(k === 39) App.move('right');
            else if(k === 40) App.move('down');
            else if(k === 8 || k === 461 || k === 27) { // Voltar
                if(App.screen === 2) {
                    if(document.getElementById('vid-box').classList.contains('fs-mode')) App.toggleFull();
                    else if(App.col === 2) { App.col = 1; App.updateFocus(); }
                    else if(App.col === 1) { App.col = 0; App.updateFocus(); }
                    else App.openDash();
                }
            }
        });
    </script>
</body>
</html>
