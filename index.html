<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R&C GOLD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- TEMA PROFISSIONAL OTIMIZADO --- */
        :root { 
            --bg: #0a0a0a; 
            --gold: #FFD700; 
            --gold-light: #FFED4E;
            --card-bg: linear-gradient(145deg, rgba(26,26,26,0.95), rgba(13,13,13,0.98));
            --focus-grad: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 10px 30px rgba(0,0,0,0.4);
            --radius: 16px;
        }
        
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            outline: none; user-select: none; -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            background-color: var(--bg); 
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; 
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,215,0,0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,215,0,0.02) 0%, transparent 50%),
                linear-gradient(180deg, #111 0%, #000 100%);
        }

        .hide { display: none !important; opacity: 0; visibility: hidden; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; background: #000; 
            opacity: 0; transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .layer.active { opacity: 1; transform: translateY(0); }

        /* ANIMA√á√ïES SUAVES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* CURSOR M√ÉOZINHA PARA PC */
        button, .smart-card, .cat-item, .item, .power-btn, .key { 
            cursor: pointer; 
            transition: var(--transition);
        }

        /* FOCO OTIMIZADO */
        .focusable {
            position: relative;
            transition: var(--transition);
        }

        .focused {
            border: 3px solid var(--gold) !important;
            background: var(--focus-grad) !important;
            color: #000 !important;
            transform: scale(1.03) translateY(-2px);
            z-index: 50;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            animation: pulse 2s infinite;
        }
        
        .focused::after {
            content: '';
            position: absolute;
            top: -3px; left: -3px; right: -3px; bottom: -3px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: inherit;
            pointer-events: none;
            animation: pulse 2s infinite 0.5s;
        }
        
        /* CORRE√á√ÉO DO PLAYER */
        #vid-box.focused {
            transform: none !important;
            border: 4px solid var(--gold) !important;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
            z-index: 60;
        }

        /* FULLSCREEN */
        #vid-box.fs, #vid-box.fs.focused {
            transform: none !important;
            border: none !important;
            box-shadow: none !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9999 !important;
            animation: none !important;
        }

        .focused i, .focused span, .focused div { color: #000 !important; }

        /* LOGIN RESPONSIVO */
        .login-box { 
            width: 420px; max-width: 90%; padding: 50px 40px; 
            background: rgba(17, 17, 17, 0.95); 
            border: 1px solid rgba(51, 51, 51, 0.8); 
            border-radius: var(--radius); 
            text-align: center; 
            backdrop-filter: blur(10px);
            animation: fadeIn 0.6s ease-out;
            box-shadow: var(--shadow);
        }
        .logo-txt { 
            font-size: 42px; font-weight: 900; 
            letter-spacing: -1.5px; color:#fff; 
            margin-bottom: 40px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .logo-txt span { 
            color: var(--gold); 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .inp { 
            width: 100%; padding: 16px 20px; 
            margin: 12px 0; 
            background: rgba(34, 34, 34, 0.9); 
            border: 1px solid rgba(68, 68, 68, 0.8); 
            color: #fff; 
            text-align: center; 
            font-weight: 600; 
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
        }
        .inp:focus { 
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }
        .btn { 
            width: 100%; padding: 16px; 
            margin-top: 25px; 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000; 
            border: none; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-weight: 900; 
            border-radius: 10px;
            font-size: 15px;
            letter-spacing: 1px;
            transition: var(--transition);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        /* DASHBOARD */
        #dash-layer { 
            display: flex; flex-direction: column; 
            padding: 40px 60px;
            justify-content: space-between;
            animation: fadeIn 0.6s ease-out;
        }

        /* Ajustes Mobile Dashboard */
        @media (max-width: 768px) {
            #dash-layer { padding: 25px; }
            .dash-grid { flex-direction: column; gap: 25px; overflow-y: auto; padding: 20px 0; }
            .smart-card { width: 100%; height: 110px; flex-direction: row; gap: 25px; }
            .smart-card i { margin-bottom: 0; font-size: 44px; }
            .col-cat { width: 35%; } 
            .col-list { width: 65%; border: none; }
            .col-play { position: fixed; bottom: 0; left: 0; width: 100%; height: auto; z-index: 100; border-top: 2px solid #333; }
            .vid-box { height: 220px; }
            .meta { display: none; }
            #content-layer { flex-wrap: wrap; }
        }

        @media (min-width: 1920px) {
            #dash-layer { padding: 60px 100px; }
            .smart-card { width: 320px; height: 380px; }
            .smart-card i { font-size: 100px; }
        }

        .top-bar { 
            display: flex; justify-content: space-between; 
            align-items: center; height: 80px; 
            animation: slideInRight 0.5s ease-out;
        }
        .dash-logo { 
            font-size: 42px; font-weight: 900; 
            letter-spacing: -2px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .dash-logo span { 
            color: var(--gold); 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dash-clock { 
            text-align: center; 
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .clock-time { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: 1px; }
        .clock-date { font-size: 14px; color: #aaa; text-transform: uppercase; font-weight: 600; margin-top: 5px; }

        .power-btn { 
            font-size: 30px; color: #666; padding: 18px; 
            border-radius: 50%; transition: var(--transition); 
            border: 2px solid transparent;
            background: rgba(0,0,0,0.3);
        }
        .power-btn:hover { color: var(--gold); transform: rotate(90deg); }
        .power-btn.focused { 
            border-radius: 50%; 
            width: 65px; height: 65px; 
            display: flex; align-items: center; justify-content: center; 
        }

        .dash-grid { 
            display: flex; gap: 50px; 
            justify-content: center; align-items: center; flex: 1; 
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        .smart-card { 
            width: 300px; height: 350px;
            background: var(--card-bg);
            border: 2px solid rgba(51, 51, 51, 0.8);
            border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .smart-card:hover { 
            transform: translateY(-5px);
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }
        .smart-card i { 
            font-size: 90px; margin-bottom: 35px; 
            color: #666;
            transition: var(--transition);
        }
        .smart-card:hover i { color: var(--gold-light); }
        .smart-card span { 
            font-size: 22px; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 2px; 
            color: #ccc;
            transition: var(--transition);
        }
        .smart-card:hover span { color: #fff; }

        .bottom-bar { 
            display: flex; justify-content: space-between; 
            align-items: flex-end;
            animation: slideInRight 0.5s ease-out 0.4s both;
        }
        .info-pill { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 12px 30px; border-radius: 30px; 
            border: 1px solid rgba(51, 51, 51, 0.8);
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }
        .info-pill:hover {
            border-color: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        .lbl { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .val { font-size: 18px; color: var(--gold); font-weight: 800; letter-spacing: 1px; }

        /* CONTE√öDO */
        #content-layer { 
            display: flex; 
            animation: fadeIn 0.6s ease-out;
        }
        .col-cat { 
            width: 25%; background: rgba(11, 11, 11, 0.95); 
            border-right: 1px solid rgba(34, 34, 34, 0.8); 
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .cat-head { 
            padding: 22px; background: rgba(17, 17, 17, 0.95); 
            color: var(--gold); font-weight: 900; 
            text-align: center; border-bottom: 3px solid var(--gold);
            font-size: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .cat-list { flex: 1; overflow-y: auto; }
        .cat-item { 
            padding: 18px 28px; border-bottom: 1px solid rgba(26, 26, 26, 0.8); 
            color: #999; font-size: 15px; font-weight: 600; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block;
            transition: var(--transition);
        }
        .cat-item:hover { color: #fff; background: rgba(255,255,255,0.03); }
        .cat-item.active { 
            border-left: 6px solid var(--gold); 
            background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, rgba(24,24,24,0.8) 100%);
            color: #fff; 
            font-weight: 700;
        }

        .col-list { 
            width: 35%; background: rgba(17, 17, 17, 0.95); 
            border-right: 1px solid rgba(34, 34, 34, 0.8); 
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .search-area { 
            padding: 18px; background: rgba(8, 8, 8, 0.95); 
            border-bottom: 1px solid rgba(51, 51, 51, 0.8); 
            display: flex; align-items: center;
        }
        .inp-search { 
            width: 100%; background: rgba(34, 34, 34, 0.9); 
            border: 1px solid rgba(51, 51, 51, 0.8); 
            color: #fff; padding: 14px; 
            text-align: center; font-weight: 600; 
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
        }
        .inp-search:focus { 
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }
        .item-list { flex: 1; overflow-y: auto; }
        .item { 
            padding: 18px 28px; border-bottom: 1px solid rgba(26, 26, 26, 0.8); 
            color: #bbb; font-size: 16px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block;
            transition: var(--transition);
        }
        .item:hover { color: #fff; background: rgba(255,255,255,0.03); }
        .item.playing { 
            color: var(--gold); font-weight: bold; 
            background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, rgba(24,24,24,0.8) 100%);
            border-left: 4px solid var(--gold); 
        }
        .fav-icon { 
            float: right; color: var(--gold); margin-left: 10px;
            transition: var(--transition);
            text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        .item:hover .fav-icon { transform: scale(1.2); }

        .col-play { 
            flex: 1; background: #000; 
            display: flex; flex-direction: column; position: relative;
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Vid-box Base */
        .vid-box { 
            width: 100%; height: 45vh; 
            background: #000; position: relative; 
            border-bottom: 2px solid rgba(51, 51, 51, 0.8);
            transition: var(--transition);
        }
        
        video { 
            width: 100%; height: 100%; background: #000; 
            object-fit: contain !important;
        }
        
        .meta { 
            padding: 35px; flex: 1; background: rgba(8, 8, 8, 0.95); 
            display: flex; flex-direction: column; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .meta-title { 
            font-size: 28px; color: var(--gold); 
            font-weight: 800; margin-bottom: 15px;
            line-height: 1.3;
        }
        .meta-epg { 
            font-size: 14px; background: rgba(34, 34, 34, 0.9); 
            color: #fff; padding: 8px 16px; 
            border-radius: 8px; display: inline-block; 
            margin-bottom: 20px; max-width: fit-content;
            border-left: 3px solid var(--gold);
        }
        .meta-desc { 
            font-size: 15px; color: #aaa; 
            overflow-y: auto; flex: 1; 
            line-height: 1.6;
            padding-right: 10px;
        }
        .keys { 
            display: flex; gap: 25px; margin-top: 30px; 
            padding-top: 25px; border-top: 1px solid rgba(34, 34, 34, 0.8); 
            flex-wrap: wrap;
        }
        .key { 
            font-size: 13px; font-weight: bold; 
            color: #aaa; text-transform: uppercase; 
            display: flex; align-items: center; gap: 10px;
            transition: var(--transition);
        }
        .key:hover { color: #fff; }
        .dot { 
            width: 14px; height: 14px; 
            border-radius: 50%;
            transition: var(--transition);
        }
        .key:hover .dot { transform: scale(1.2); }

        /* LOADER MODERNO */
        #loader { 
            background: rgba(0,0,0,0.98); 
            z-index: 20000; 
            flex-direction: column; 
            color: var(--gold); 
            font-weight: 900;
            backdrop-filter: blur(20px);
        }
        
        .load-spinner {
            font-size: 60px;
            margin-bottom: 25px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* OSD MODERNO */
        .osd-status { 
            position: absolute; top: 25px; right: 25px; 
            background: rgba(0,0,0,0.9); 
            color: var(--gold) !important; 
            padding: 12px 24px; border-radius: 10px; 
            font-weight: 800; display: none; 
            border: 1px solid var(--gold); 
            z-index: 10000; pointer-events: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease-out;
        }
        
        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #FFED4E 0%, #FFD700 100%); }
        
        /* TEXTO TRUNCATE */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* BADGE PARA NOVO CONTE√öDO */
        .badge-new {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="hide flex-center">
        <i class="fas fa-circle-notch load-spinner"></i>
        <div id="load-txt">CARREGANDO...</div>
    </div>

    <div id="login-layer" class="layer">
        <div class="login-box">
            <div class="logo-txt">R&C <span>GOLD</span></div>
            <input type="text" id="i0" class="inp focusable" placeholder="URL DNS" autocomplete="off">
            <input type="text" id="i1" class="inp focusable" placeholder="USU√ÅRIO" autocomplete="off">
            <input type="password" id="i2" class="inp focusable" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn focusable" onclick="App.login()">CONECTAR</button>
            <div id="msg-login" style="color:#ff4444; margin-top:15px; font-size:13px; font-weight:600;"></div>
        </div>
    </div>

    <div id="dash-layer" class="layer hide">
        <div class="top-bar">
            <div class="dash-logo">R&C <span>GOLD</span></div>
            <div class="dash-clock">
                <div id="clock-time" class="clock-time">12:00</div>
                <div id="clock-date" class="clock-date">--/--/----</div>
            </div>
            <div id="m3" class="power-btn focusable" onclick="App.logout()">
                <i class="fas fa-power-off"></i>
            </div>
        </div>

        <div class="dash-grid">
            <div id="m0" class="smart-card focusable" onclick="App.openMode('live')">
                <i class="fas fa-tv"></i><span>TV AO VIVO</span>
            </div>
            <div id="m1" class="smart-card focusable" onclick="App.openMode('movie')">
                <i class="fas fa-film"></i><span>FILMES</span>
            </div>
            <div id="m2" class="smart-card focusable" onclick="App.openMode('series')">
                <i class="fas fa-video"></i><span>S√âRIES</span>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="info-pill">
                <span class="lbl">VENCIMENTO</span>
                <span id="info-exp" class="val">...</span>
            </div>
            <div class="info-pill" style="text-align: right;">
                <span class="lbl">TELAS ATIVAS</span>
                <span id="info-conn" class="val">...</span>
            </div>
        </div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-area">
                <input type="text" id="search" class="inp-search focusable" placeholder="PESQUISAR..." autocomplete="off">
            </div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="vid-box" class="vid-box focusable">
                <video id="player" playsinline webkit-playsinline></video>
                <div id="osd" class="osd-status"></div>
            </div>
            <div class="meta">
                <div id="meta-title" class="meta-title">R&C GOLD</div>
                <div id="meta-epg" class="meta-epg hide"></div>
                <div id="meta-desc" class="meta-desc">Selecione um conte√∫do.</div>
                
                <div class="keys">
                    <div class="key"><div class="dot" style="background:#ff4444"></div> TELA CHEIA</div>
                    <div class="key"><div class="dot" style="background:#00C851"></div> TOPO</div>
                    <div class="key"><div class="dot" style="background:#ffbb33"></div> BUSCAR</div>
                    <div class="key"><div class="dot" style="background:#33b5e5"></div> MENU</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GEST√ÉO DE PERFORMANCE
        const Debounce = {
            timeout: null,
            exec: function(fn, delay = 300) {
                clearTimeout(this.timeout);
                this.timeout = setTimeout(fn, delay);
            }
        };

        const Throttle = {
            last: 0,
            exec: function(fn, limit = 100) {
                const now = Date.now();
                if (now - this.last >= limit) {
                    fn();
                    this.last = now;
                }
            }
        };

        var FavManager = {
            key: 'rc_favs_smart', list: [],
            init: function() { 
                try {
                    var s = localStorage.getItem(this.key); 
                    this.list = s ? JSON.parse(s) : []; 
                } catch(e) { this.list = []; }
            },
            toggle: function(id) {
                var idx = this.list.indexOf(id);
                if(idx > -1) this.list.splice(idx, 1); 
                else this.list.push(id);
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.list));
                } catch(e) { console.warn('Storage limit exceeded'); }
                if(App.idx < App.fullData.length) App.renderList(true);
            },
            isFav: function(id) { return this.list.indexOf(id) > -1; }
        };

        var PlayerEngine = {
            hls: null, video: null, url: null, retryCount: 0, 
            monitorTimer: null, lastTime: 0, stallCount: 0,
            qualityLevels: [],
            
            init: function() { 
                this.video = document.getElementById('player'); 
                this.video.preload = 'auto';
                this.video.onerror = function() { PlayerEngine.recover(); };
                this.video.onwaiting = function() { App.osd("BUFFERING..."); };
                this.video.onplaying = function() { App.osd(""); };
                
                // Preven√ß√£o de memory leak
                window.addEventListener('beforeunload', () => this.cleanup());
            },
            
            play: function(url, isLive) {
                if(this.url === url && !this.video.paused) return;
                
                this.cleanup();
                this.url = url; 
                this.retryCount = 0; 
                this.stallCount = 0;
                
                this.video.controls = false;
                
                // Otimiza√ß√£o para mobile
                if(isLive) {
                    this.video.classList.add('live');
                    if(!url.includes('.m3u8') && url.includes('.ts')) {
                        url = url.replace('.ts', '.m3u8');
                    }
                } else {
                    this.video.classList.remove('live');
                }

                if(isLive || url.includes('.m3u8')) {
                    this.startMonitor();
                }

                // Detec√ß√£o inteligente de player
                const canPlayNative = this.video.canPlayType('application/vnd.apple.mpegurl');
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                if ((canPlayNative === "probably" || canPlayNative === "maybe") && isSafari) {
                    // Safari - usar nativo
                    this.video.src = url; 
                    this.video.load();
                    this.playPromise = this.video.play().catch(e => {
                        console.log('Native play failed, trying HLS');
                        if(Hls.isSupported()) this.startHls(url);
                    });
                } else if (Hls.isSupported()) {
                    // Usar HLS.js para outros browsers
                    this.startHls(url);
                } else {
                    // Fallback
                    this.video.src = url; 
                    this.video.load();
                    this.playPromise = this.video.play().catch(e => console.log('Fallback error:', e));
                }
            },
            
            startHls: function(url) {
                this.cleanupHls();
                
                const config = { 
                    enableWorker: true,
                    enableSoftwareAES: true,
                    autoStartLoad: true,
                    startPosition: -1,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: 10,
                    manifestLoadingTimeOut: 20000,
                    manifestLoadingMaxRetry: 3,
                    levelLoadingTimeOut: 10000,
                    levelLoadingMaxRetry: 3,
                    fragLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 3,
                    capLevelToPlayerSize: true,
                    capLevelOnFPSDrop: true,
                    fpsDroppedMonitoringPeriod: 1000,
                    fpsDroppedMonitoringThreshold: 0.2
                };
                
                this.hls = new Hls(config);
                this.hls.loadSource(url);
                this.hls.attachMedia(this.video);
                
                this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    this.playPromise = this.video.play().catch(e => {});
                });
                
                this.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                this.hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                this.hls.recoverMediaError();
                                break;
                            default:
                                this.recover();
                                break;
                        }
                    }
                });
            },
            
            startMonitor: function() {
                this.stopMonitor();
                this.monitorTimer = setInterval(() => {
                    if(!this.video || !this.url || this.video.paused) return;
                    
                    const currentTime = this.video.currentTime;
                    if(Math.abs(currentTime - this.lastTime) < 0.1) {
                        this.stallCount++;
                        if(this.stallCount > 5) { 
                            App.osd("RECONECTANDO..."); 
                            this.recover(); 
                        }
                    } else { 
                        this.stallCount = 0; 
                        this.lastTime = currentTime; 
                    }
                }, 2000);
            },
            
            stopMonitor: function() { 
                if(this.monitorTimer) {
                    clearInterval(this.monitorTimer);
                    this.monitorTimer = null;
                }
            },
            
            recover: function() {
                this.retryCount++;
                if(this.retryCount > 8) { 
                    this.cleanup(); 
                    App.osd("FALHA DE SINAL"); 
                    return; 
                }
                
                setTimeout(() => { 
                    this.cleanup();
                    setTimeout(() => { 
                        if(App.mode === 'live' || (this.url && this.url.includes('.m3u8'))) {
                            this.video.load();
                            this.play(this.url, true);
                        }
                    }, 500); 
                }, 1000);
            },
            
            cleanupHls: function() {
                if(this.hls) { 
                    this.hls.destroy(); 
                    this.hls = null; 
                }
            },
            
            cleanup: function() { 
                this.stopMonitor(); 
                this.cleanupHls();
                if(this.video) { 
                    this.video.pause();
                    this.video.removeAttribute('src');
                    this.video.load();
                }
                if(this.playPromise) {
                    this.playPromise.catch(() => {});
                    this.playPromise = null;
                }
            }
        };

        var App = {
            scr: 0, zone: 0, idx: 0, lastCatIdx: 0, 
            creds: {}, fullData: [], storedList: [], 
            memIdx: 0, globalData: null, isFolder: false, 
            seriesEps: [], playingId: null, mode: '',

            init: function() {
                FavManager.init();
                this.restoreCredentials();
                PlayerEngine.init();
                this.setupEventListeners();
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
                this.showLayer('login-layer');
            },

            restoreCredentials: function() {
                const savedHost = localStorage.getItem('rc_h');
                if(savedHost) {
                    document.getElementById('i0').value = savedHost;
                    document.getElementById('i1').value = localStorage.getItem('rc_u') || '';
                    document.getElementById('i2').value = localStorage.getItem('rc_p') || '';
                }
            },

            setupEventListeners: function() {
                const player = document.getElementById('player');
                player.onended = () => { 
                    if(this.mode === 'series' && this.isFolder && this.idx < this.seriesEps.length - 1) {
                        this.idx++; 
                        this.updateFocus(); 
                        this.playStream(this.seriesEps[this.idx]);
                    } else {
                        this.exitFull(); 
                    }
                };

                // Debounce para pesquisa
                const searchInput = document.getElementById('search');
                searchInput.addEventListener('input', () => {
                    Debounce.exec(() => this.doSearch(), 500);
                });
            },

            updateClock: function() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const dateStr = now.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                }).toUpperCase();
                
                const timeEl = document.getElementById('clock-time');
                const dateEl = document.getElementById('clock-date');
                
                if(timeEl) timeEl.textContent = timeStr;
                if(dateEl) dateEl.textContent = dateStr;
            },

            req: function(url, cb) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.timeout = 25000;
                xhr.setRequestHeader('Cache-Control', 'no-cache');
                
                xhr.onload = function() { 
                    if(xhr.status === 200) { 
                        try {
                            cb(JSON.parse(xhr.responseText));
                        } catch(e) {
                            cb(null);
                        }
                    } else {
                        cb(null);
                    }
                };
                
                xhr.onerror = function() { cb('ERR_NET'); };
                xhr.ontimeout = function() { cb('ERR_TIMEOUT'); };
                xhr.send();
            },

            login: function() {
                let host = document.getElementById('i0').value.trim();
                const user = document.getElementById('i1').value.trim();
                const pass = document.getElementById('i2').value.trim();
                
                // Limpar mensagem anterior
                document.getElementById('msg-login').textContent = '';
                
                if(!host || !user || !pass) {
                    document.getElementById('msg-login').textContent = "Preencha todos os campos!";
                    return;
                }
                
                // Normalizar URL
                if(host.endsWith('/')) host = host.slice(0, -1);
                if(!host.startsWith('http')) host = 'http://' + host;
                
                this.showLoader("CONECTANDO...");
                
                const url = `${host}/player_api.php?username=${user}&password=${pass}`;
                
                this.req(url, (data) => {
                    this.hideLoader();
                    
                    if(data === 'ERR_NET' || data === 'ERR_TIMEOUT') {
                        document.getElementById('msg-login').textContent = 
                            "Falha de conex√£o. Verifique a URL e sua internet.";
                        return;
                    }
                    
                    if(data && data.user_info && data.user_info.auth === 1) {
                        // Salvar credenciais
                        this.creds = { h: host, u: user, p: pass };
                        localStorage.setItem('rc_h', host);
                        localStorage.setItem('rc_u', user);
                        localStorage.setItem('rc_p', pass);
                        
                        // Atualizar informa√ß√µes
                        const info = data.user_info;
                        const expDate = info.exp_date ? 
                            new Date(info.exp_date * 1000).toLocaleDateString("pt-BR") : 
                            "ILIMITADO";
                        const connStr = `${info.active_cons || 0} / ${info.max_connections || 1}`;
                        
                        document.getElementById('info-exp').textContent = expDate;
                        document.getElementById('info-conn').textContent = connStr;
                        
                        this.showLayer('dash-layer');
                    } else {
                        document.getElementById('msg-login').textContent = 
                            "Credenciais inv√°lidas. Verifique usu√°rio e senha.";
                    }
                });
            },

            logout: function() { 
                PlayerEngine.cleanup();
                localStorage.clear(); 
                location.reload(); 
            },

            showLoader: function(message) {
                const loader = document.getElementById('loader');
                const loadText = document.getElementById('load-txt');
                
                if(loadText && message) loadText.textContent = message;
                loader.classList.remove('hide');
                setTimeout(() => loader.style.opacity = '1', 10);
            },

            hideLoader: function() {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => loader.classList.add('hide'), 300);
            },

            showLayer: function(layerId) {
                // Esconder todas as layers
                document.querySelectorAll('.layer').forEach(layer => {
                    layer.classList.remove('active');
                    setTimeout(() => layer.classList.add('hide'), 400);
                });
                
                // Mostrar layer solicitada
                setTimeout(() => {
                    const layer = document.getElementById(layerId);
                    layer.classList.remove('hide');
                    setTimeout(() => layer.classList.add('active'), 10);
                    
                    // Atualizar estado
                    this.scr = layerId === 'login-layer' ? 0 : 
                               layerId === 'dash-layer' ? 1 : 2;
                    this.zone = 0;
                    this.idx = 0;
                    
                    if(this.scr === 1) {
                        PlayerEngine.cleanup();
                    }
                    
                    this.updateFocus();
                }, 50);
            },

            openMode: function(mode) {
                PlayerEngine.cleanup();
                this.resetInfo();
                
                this.mode = mode;
                this.isFolder = false;
                this.globalData = null;
                this.playingId = null;
                
                this.showLayer('content-layer');
                
                // Limpar UI
                document.getElementById('cat-list').innerHTML = '';
                document.getElementById('item-list').innerHTML = '';
                document.getElementById('search').value = '';
                
                this.showLoader("CARREGANDO CATEGORIAS...");
                
                const actions = {
                    'live': 'get_live_categories',
                    'movie': 'get_vod_categories',
                    'series': 'get_series_categories'
                };
                
                const url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${actions[mode]}`;
                
                this.req(url, (data) => {
                    this.hideLoader();
                    
                    if(data && data !== 'ERR_NET') {
                        let html = '<div class="cat-item" id="c0" data-id="fav" onclick="App.catClick(0)">‚≠ê FAVORITOS</div>';
                        
                        data.forEach((cat, index) => {
                            html += `<div class="cat-item" id="c${index + 1}" data-id="${cat.category_id}" onclick="App.catClick(${index + 1})">
                                        ${cat.category_name}
                                     </div>`;
                        });
                        
                        document.getElementById('cat-list').innerHTML = html;
                        this.zone = 0;
                        this.idx = 0;
                        this.updateFocus();
                    } else {
                        this.osd("ERRO AO CARREGAR CATEGORIAS");
                    }
                });
            },

            resetInfo: function() {
                document.getElementById('meta-title').textContent = "R&C GOLD";
                document.getElementById('meta-desc').textContent = "Selecione um conte√∫do.";
                document.getElementById('meta-epg').textContent = "";
                document.getElementById('meta-epg').classList.add('hide');
            },

            catClick: function(index) { 
                this.idx = index; 
                this.zone = 0; 
                this.loadContent(index); 
            },

            loadContent: function(catIndex) {
                this.lastCatIdx = catIndex; 
                const catEl = document.getElementById('c' + catIndex);
                if(!catEl) return;
                
                const categoryId = catEl.getAttribute('data-id');
                
                // Ativar categoria selecionada
                document.querySelectorAll('.cat-item').forEach(el => {
                    el.classList.remove('active');
                });
                catEl.classList.add('active');
                
                // Limpar busca
                document.getElementById('search').value = '';
                
                this.showLoader("CARREGANDO...");
                document.getElementById('item-list').innerHTML = '';

                const onDataLoaded = (data) => {
                    this.hideLoader();
                    if(data && data !== 'ERR_NET') { 
                        this.fullData = data; 
                        this.isFolder = false; 
                        this.renderList(); 
                    } else {
                        this.osd("ERRO AO CARREGAR CONTE√öDO");
                    }
                };

                if(categoryId === 'fav') {
                    // Carregar favoritos
                    const actions = {
                        'live': 'get_live_streams',
                        'movie': 'get_vod_streams',
                        'series': 'get_series'
                    };
                    
                    const url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${actions[this.mode]}`;
                    
                    this.req(url, (data) => {
                        if(data && data !== 'ERR_NET') { 
                            this.fullData = data.filter(item => 
                                FavManager.isFav(item.stream_id || item.series_id)
                            ); 
                            this.isFolder = false; 
                            this.renderList(); 
                        }
                        this.hideLoader();
                    });
                } else {
                    // Carregar por categoria
                    const actions = {
                        'live': 'get_live_streams',
                        'movie': 'get_vod_streams',
                        'series': 'get_series'
                    };
                    
                    const url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${actions[this.mode]}&category_id=${categoryId}`;
                    this.req(url, onDataLoaded);
                }
            },

            renderList: function(keepIndex = false) {
                const data = this.fullData;
                const maxItems = Math.min(data.length, 300); // Limite para performance
                
                if(maxItems === 0) { 
                    document.getElementById('item-list').innerHTML = 
                        '<div style="padding: 30px; text-align: center; color: #888;">Nenhum item encontrado</div>'; 
                    return; 
                }
                
                let html = '';
                
                for(let i = 0; i < maxItems; i++) {
                    const item = data[i];
                    const name = item.name || item.title || 'Sem nome';
                    const id = item.stream_id || item.series_id || i;
                    const isFavorite = FavManager.isFav(id);
                    const favIcon = isFavorite ? 
                        '<i class="fas fa-star fav-icon" style="color: #FFD700;"></i>' : 
                        '<i class="far fa-star fav-icon" style="color: #666;"></i>';
                    
                    const playingClass = (this.playingId === id && this.zone !== 3) ? 'playing' : '';
                    
                    html += `<div class="item ${playingClass}" id="row-${i}" onclick="App.itemClick(${i})">
                                <span class="text-truncate">${name}</span>
                                ${favIcon}
                            </div>`;
                }
                
                document.getElementById('item-list').innerHTML = html;
                this.zone = 2;
                
                if(!keepIndex) { 
                    this.idx = 0; 
                }
                
                this.updateFocus();
            },

            itemClick: function(index) { 
                Throttle.exec(() => {
                    this.idx = index; 
                    this.zone = 2; 
                    this.clickItem();
                }, 200);
            },

            clickItem: function() {
                if(this.isFolder) { 
                    this.playStream(this.seriesEps[this.idx]); 
                    return; 
                }
                
                const item = this.fullData[this.idx];
                if(!item) return;
                
                if(this.mode !== 'series') { 
                    this.playStream(item); 
                    return; 
                }
                
                // Para s√©ries, carregar epis√≥dios
                this.storedList = [...this.fullData];
                this.memIdx = this.idx;
                
                this.showLoader("CARREGANDO EPIS√ìDIOS...");
                
                const url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=get_series_info&series_id=${item.series_id}`;
                
                this.req(url, (data) => {
                    this.hideLoader();
                    
                    if(data && data.episodes) {
                        // Coletar todos epis√≥dios
                        const episodes = [];
                        for(const season in data.episodes) {
                            episodes.push(...data.episodes[season]);
                        }
                        
                        this.seriesEps = episodes;
                        this.fullData = episodes;
                        this.isFolder = true;
                        this.renderList();
                        
                        document.getElementById('meta-title').textContent = `üìÇ ${item.name || item.title}`;
                    } else {
                        this.osd("ERRO AO CARREGAR EPIS√ìDIOS");
                    }
                });
            },

            playStream: function(item) {
                if(!item) return;
                
                const extensions = {
                    'live': 'ts',
                    'movie': item.container_extension || 'mp4',
                    'series': item.container_extension || 'mp4'
                };
                
                const type = this.mode;
                const id = item.stream_id || item.id;
                const ext = extensions[type];
                const url = `${this.creds.h}/${type}/${this.creds.u}/${this.creds.p}/${id}.${ext}`;
                
                this.playingId = id;
                
                // Atualizar metadata
                document.getElementById('meta-title').textContent = item.name || item.title || 'Sem t√≠tulo';
                document.getElementById('meta-desc').textContent = item.description || "Sem descri√ß√£o dispon√≠vel.";
                document.getElementById('meta-epg').classList.add('hide');
                
                // Para live TV, buscar EPG
                if(this.mode === 'live') {
                    const epgUrl = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=get_short_epg&stream_id=${id}`;
                    
                    this.req(epgUrl, (data) => {
                        if(data && data.epg_listings && data.epg_listings.length > 0) {
                            let title = data.epg_listings[0].title;
                            
                            // Tentar decodificar se estiver em base64
                            try {
                                if(window.atob && /^[A-Za-z0-9+/=]+$/.test(title)) {
                                    title = atob(title);
                                }
                            } catch(e) {}
                            
                            document.getElementById('meta-epg').textContent = title;
                            document.getElementById('meta-epg').classList.remove('hide');
                        }
                    });
                }
                
                // Reproduzir
                PlayerEngine.play(url, this.mode === 'live');
                
                // Marcar item como playing
                document.querySelectorAll('.item').forEach(el => {
                    el.classList.remove('playing');
                });
                
                const rowEl = document.getElementById('row-' + this.idx);
                if(rowEl) rowEl.classList.add('playing');
                
                // Atualizar foco para player
                this.zone = 3;
                this.updateFocus();
            },

            doSearch: function() {
                const term = document.getElementById('search').value.toLowerCase().trim();
                
                if(term.length < 2) {
                    // Se termo muito curto, voltar √† lista normal
                    if(this.lastCatIdx !== undefined) {
                        this.loadContent(this.lastCatIdx);
                    }
                    return;
                }
                
                document.getElementById('item-list').innerHTML = 
                    '<div style="padding: 30px; text-align: center; color: #888;">Buscando...</div>';
                
                const searchCallback = (data) => {
                    if(data && data !== 'ERR_NET') { 
                        this.fullData = data.filter(item => {
                            const name = (item.name || item.title || "").toLowerCase();
                            return name.includes(term);
                        }); 
                        
                        this.isFolder = false; 
                        this.renderList();
                        
                        this.zone = 2; 
                        this.idx = 0; 
                        this.updateFocus();
                    }
                };
                
                if(this.globalData) {
                    searchCallback(this.globalData);
                } else {
                    const actions = {
                        'live': 'get_live_streams',
                        'movie': 'get_vod_streams',
                        'series': 'get_series'
                    };
                    
                    const url = `${this.creds.h}/player_api.php?username=${this.creds.u}&password=${this.creds.p}&action=${actions[this.mode]}`;
                    
                    this.req(url, (data) => { 
                        this.globalData = data; 
                        searchCallback(data); 
                    });
                }
            },

            toggleFull: function() {
                const videoBox = document.getElementById('vid-box');
                if(videoBox.classList.contains('fs')) {
                    this.exitFull();
                } else {
                    videoBox.classList.add('fs');
                    this.osd("TELA CHEIA");
                    
                    // Tentar entrar em fullscreen nativo
                    if(videoBox.requestFullscreen) {
                        videoBox.requestFullscreen();
                    } else if(videoBox.webkitRequestFullscreen) {
                        videoBox.webkitRequestFullscreen();
                    } else if(videoBox.msRequestFullscreen) {
                        videoBox.msRequestFullscreen();
                    }
                }
            },

            exitFull: function() { 
                document.getElementById('vid-box').classList.remove('fs');
                
                // Sair do fullscreen nativo
                if(document.exitFullscreen) {
                    document.exitFullscreen();
                } else if(document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if(document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                this.syncFocusToPlaying();
            },

            osd: function(message) {
                const osdEl = document.getElementById('osd');
                if(!osdEl) return;
                
                osdEl.textContent = message;
                osdEl.style.display = 'block';
                
                // Auto-esconder ap√≥s 2 segundos
                setTimeout(() => {
                    osdEl.style.opacity = '0';
                    setTimeout(() => {
                        osdEl.style.display = 'none';
                        osdEl.style.opacity = '1';
                    }, 300);
                }, 2000);
            },

            back: function() {
                // Se est√° em fullscreen, sair primeiro
                if(document.getElementById('vid-box').classList.contains('fs')) {
                    this.exitFull();
                    return;
                }
                
                // Navega√ß√£o hier√°rquica
                if(this.zone === 3) {
                    this.zone = 2;
                    this.syncFocusToPlaying();
                    this.updateFocus();
                    return;
                }
                
                if(this.zone === 2 && this.isFolder) {
                    // Voltar da lista de epis√≥dios para lista de s√©ries
                    this.isFolder = false;
                    this.fullData = this.storedList;
                    this.renderList(true);
                    this.idx = this.memIdx;
                    this.updateFocus();
                    document.getElementById('meta-title').textContent = "R&C GOLD";
                    return;
                }
                
                if(this.zone === 2) {
                    this.zone = 0;
                    this.idx = this.lastCatIdx;
                    this.updateFocus();
                    return;
                }
                
                if(this.zone === 1) {
                    this.zone = 2;
                    this.idx = 0;
                    this.updateFocus();
                    return;
                }
                
                if(this.zone === 0) {
                    this.showLayer('dash-layer');
                    return;
                }
            },

            syncFocusToPlaying: function() {
                if(!this.playingId) return;
                
                for(let i = 0; i < this.fullData.length; i++) {
                    const item = this.fullData[i];
                    const id = item.stream_id || item.series_id || item.id;
                    
                    if(id == this.playingId) {
                        this.idx = i;
                        this.updateFocus();
                        return;
                    }
                }
            },

            updateFocus: function() {
                // Remover foco anterior
                document.querySelectorAll('.focused').forEach(el => {
                    el.classList.remove('focused');
                });
                
                let element = null;
                
                switch(this.scr) {
                    case 0: // Login
                        element = document.getElementById('i' + this.idx);
                        break;
                        
                    case 1: // Dashboard
                        element = document.getElementById('m' + this.idx);
                        break;
                        
                    case 2: // Conte√∫do
                        switch(this.zone) {
                            case 0: // Categorias
                                element = document.getElementById('c' + this.idx);
                                break;
                            case 1: // Busca
                                element = document.getElementById('search');
                                break;
                            case 2: // Lista
                                element = document.getElementById('row-' + this.idx);
                                break;
                            case 3: // Player
                                element = document.getElementById('vid-box');
                                break;
                        }
                        break;
                }
                
                if(element) {
                    element.classList.add('focused');
                    
                    // Para inputs, focar e selecionar texto
                    if(element.tagName === 'INPUT') {
                        element.focus();
                        setTimeout(() => element.select(), 100);
                    } else {
                        // Remover foco de inputs
                        document.querySelectorAll('input').forEach(input => input.blur());
                    }
                    
                    // Scroll suave para elementos n√£o-input
                    if(element.tagName !== 'INPUT') {
                        element.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center', 
                            inline: 'nearest' 
                        });
                    }
                }
            },

            move: function(direction) {
                // 0: up, 1: down, 2: left, 3: right
                
                Throttle.exec(() => {
                    if(this.scr === 0) { // Login
                        if(direction === 1 && this.idx < 3) this.idx++;
                        if(direction === 0 && this.idx > 0) this.idx--;
                    } 
                    else if(this.scr === 1) { // Dashboard
                        if(this.idx <= 2) {
                            if(direction === 3 && this.idx < 2) this.idx++;
                            if(direction === 2 && this.idx > 0) this.idx--;
                            if(direction === 0) this.idx = 3;
                        } else if(this.idx === 3) {
                            if(direction === 1) this.idx = 1;
                        }
                    }
                    else if(this.scr === 2) { // Conte√∫do
                        if(this.zone === 3) {
                            if(direction === 2) {
                                this.zone = 2;
                                this.syncFocusToPlaying();
                                this.updateFocus();
                            }
                            return;
                        }
                        
                        if(this.zone === 0) { // Categorias
                            const maxCat = document.getElementById('cat-list').children.length - 1;
                            
                            if(direction === 1 && this.idx < maxCat) this.idx++;
                            if(direction === 0 && this.idx > 0) this.idx--;
                            if(direction === 3 && this.fullData.length > 0) {
                                this.zone = 2;
                                this.idx = 0;
                            }
                        }
                        else if(this.zone === 2) { // Lista de itens
                            const maxItems = document.getElementById('item-list').children.length - 1;
                            
                            if(direction === 1 && this.idx < maxItems) this.idx++;
                            else if(direction === 0) {
                                if(this.idx > 0) this.idx--;
                                else this.zone = 1;
                            }
                            else if(direction === 2) {
                                this.zone = 0;
                                this.idx = this.lastCatIdx;
                            }
                            else if(direction === 3) this.zone = 3;
                        }
                        else if(this.zone === 1) { // Busca
                            if(direction === 1) {
                                this.zone = 2;
                                this.idx = 0;
                            }
                            if(direction === 2) {
                                this.zone = 0;
                                this.idx = this.lastCatIdx;
                            }
                        }
                    }
                    
                    this.updateFocus();
                }, 100);
            },

            enter: function() {
                if(this.scr === 0) { // Login
                    this.login();
                }
                else if(this.scr === 1) { // Dashboard
                    if(this.idx === 3) {
                        this.logout();
                    } else {
                        const modes = ['live', 'movie', 'series'];
                        this.openMode(modes[this.idx]);
                    }
                }
                else if(this.scr === 2) { // Conte√∫do
                    switch(this.zone) {
                        case 0: // Categorias
                            this.loadContent(this.idx);
                            break;
                        case 1: // Busca
                            this.doSearch();
                            break;
                        case 2: // Lista
                            this.clickItem();
                            break;
                        case 3: // Player
                            this.toggleFull();
                            break;
                    }
                }
            }
        };

        // CONTROLES POR TECLADO
        document.addEventListener('keydown', function(e) {
            const key = e.keyCode || e.which;
            
            // Prevenir comportamento padr√£o para teclas de navega√ß√£o
            if([8, 9, 13, 27, 32, 33, 34, 35, 36, 37, 38, 39, 40, 46].includes(key)) {
                e.preventDefault();
            }
            
            // Se estiver em um input
            if(document.activeElement.tagName === 'INPUT') {
                if(App.scr === 0) { // Login
                    if(key === 13) { // Enter
                        App.login();
                        return;
                    }
                    if(key === 40) { // Seta para baixo
                        App.move(1);
                        return;
                    }
                    if(key === 38) { // Seta para cima
                        App.move(0);
                        return;
                    }
                    return;
                }
                
                if(App.scr === 2 && document.activeElement.id === 'search') {
                    if(key === 13) { // Enter - buscar
                        App.doSearch();
                        return;
                    }
                    if(key === 40) { // Seta para baixo - sair do input
                        App.zone = 2;
                        App.idx = 0;
                        App.updateFocus();
                        return;
                    }
                    if(key === 27) { // ESC - limpar busca
                        document.getElementById('search').value = '';
                        if(App.lastCatIdx !== undefined) {
                            App.loadContent(App.lastCatIdx);
                        }
                        return;
                    }
                    return;
                }
            }
            
            // Controles de v√≠deo em tela cheia
            const isFullscreen = document.getElementById('vid-box').classList.contains('fs');
            
            if(isFullscreen && App.mode !== 'live') {
                const video = document.getElementById('player');
                
                switch(key) {
                    case 39: // Seta direita - Avan√ßar 30s
                    case 417: // Controle avan√ßar
                        if(video) {
                            video.currentTime = Math.min(video.duration, video.currentTime + 30);
                            App.osd(">> 30s");
                        }
                        return;
                        
                    case 37: // Seta esquerda - Voltar 30s
                    case 412: // Controle voltar
                        if(video) {
                            video.currentTime = Math.max(0, video.currentTime - 30);
                            App.osd("<< 30s");
                        }
                        return;
                        
                    case 32: // Espa√ßo
                    case 13: // Enter
                    case 179: // Play/Pause
                        if(video) {
                            if(video.paused) {
                                video.play();
                                App.osd("‚ñ∂ PLAY");
                            } else {
                                video.pause();
                                App.osd("‚è∏ PAUSE");
                            }
                        }
                        return;
                        
                    case 27: // ESC - Sair do fullscreen
                        App.exitFull();
                        return;
                }
            }
            
            // Teclas de fun√ß√£o
            switch(key) {
                case 48: // 0
                case 96: // Numpad 0
                    if(App.scr === 2 && App.zone === 2) {
                        const item = App.fullData[App.idx];
                        if(item) {
                            FavManager.toggle(item.stream_id || item.series_id);
                        }
                    }
                    break;
                    
                case 82: // R
                case 403: // Controle vermelho
                    if(App.scr === 2) {
                        App.toggleFull();
                    }
                    break;
                    
                case 71: // G
                case 404: // Controle verde
                    if(App.scr === 2) {
                        App.zone = 0;
                        App.idx = 0;
                        App.updateFocus();
                    }
                    break;
                    
                case 89: // Y
                case 405: // Controle amarelo
                    if(App.scr === 2) {
                        App.zone = 1;
                        App.updateFocus();
                    }
                    break;
                    
                case 66: // B
                case 406: // Controle azul
                case 275: // Menu
                    App.showLayer('dash-layer');
                    break;
            }
            
            // Navega√ß√£o b√°sica
            switch(key) {
                case 37: // Seta esquerda
                    App.move(2);
                    break;
                    
                case 38: // Seta cima
                    App.move(0);
                    break;
                    
                case 39: // Seta direita
                    App.move(3);
                    break;
                    
                case 40: // Seta baixo
                    App.move(1);
                    break;
                    
                case 13: // Enter
                    App.enter();
                    break;
                    
                case 8:  // Backspace
                case 27: // ESC
                case 461: // Voltar (TV)
                    if(App.scr > 0) {
                        App.back();
                    }
                    break;
                    
                case 9: // Tab - Navega√ß√£o especial
                    if(App.scr === 2) {
                        if(e.shiftKey) {
                            // Tab + Shift: voltar zona
                            if(App.zone > 0) App.zone--;
                        } else {
                            // Tab: avan√ßar zona
                            if(App.zone < 3) App.zone++;
                        }
                        App.updateFocus();
                    }
                    break;
            }
        });

        // Suporte a controles de TV/Android
        document.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id);
            
            let lastButtons = [];
            
            function checkGamepad() {
                const gamepads = navigator.getGamepads();
                if (!gamepads[0]) return;
                
                const gp = gamepads[0];
                
                // Mapeamento de bot√µes
                if (gp.buttons[0].pressed && !lastButtons[0]) App.enter(); // A
                if (gp.buttons[1].pressed && !lastButtons[1]) App.back();   // B
                if (gp.buttons[12].pressed && !lastButtons[12]) App.move(0); // D-pad up
                if (gp.buttons[13].pressed && !lastButtons[13]) App.move(1); // D-pad down
                if (gp.buttons[14].pressed && !lastButtons[14]) App.move(2); // D-pad left
                if (gp.buttons[15].pressed && !lastButtons[15]) App.move(3); // D-pad right
                
                lastButtons = gp.buttons.map(b => b.pressed);
                requestAnimationFrame(checkGamepad);
            }
            
            requestAnimationFrame(checkGamepad);
        });

        // Otimiza√ß√£o de performance
        let rafId = null;
        function optimizeRender() {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                // Opera√ß√µes de renderiza√ß√£o aqui
                rafId = null;
            });
        }

        // Preload de fontes cr√≠ticas
        window.addEventListener('load', () => {
            // For√ßar renderiza√ß√£o de fonts
            document.body.style.opacity = '1';
        });
    </script>
</body>
</html>
