<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XEON V44 BARE METAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- MODO ULTRA DESEMPENHO (BARE METAL) --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: #000000; /* Preto absoluto - Zero processamento */
            color: #ffffff;
            font-family: Arial, sans-serif; /* Fonte padrão do sistema */
            overflow: hidden; height: 100vh; width: 100vw;
        }

        .hidden { display: none !important; }
        .full-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* --- FOCO DE ALTO CONTRASTE (SEM SOMBRAS) --- */
        .focusable {
            border: 2px solid transparent; 
            background: #111;
        }
        
        .focusable.focused {
            border: 4px solid #ff0000; /* Borda grossa vermelha */
            background: #333; /* Fundo cinza claro */
            color: #fff !important;
            transform: none; /* SEM ANIMAÇÃO DE ZOOM */
            box-shadow: none; /* SEM SOMBRA */
            z-index: 10;
        }

        /* --- TELA LOGIN --- */
        #login-screen { display: flex; align-items: center; justify-content: center; background: #000; }
        .login-box {
            background: #000; border: 2px solid #333; padding: 20px; width: 400px; text-align: center;
        }
        .logo-title { font-size: 30px; font-weight: bold; color: #ff0000; margin-bottom: 20px; }
        
        .xeon-input {
            width: 100%; padding: 10px; margin-bottom: 10px;
            background: #fff; border: 1px solid #999; color: #000; font-size: 16px;
        }
        .btn-xeon {
            width: 100%; padding: 10px; background: #900; color: #fff; border: none; font-size: 18px; font-weight: bold;
        }
        .btn-xeon.focused { background: #f00; border: 2px solid #fff; }

        /* --- DASHBOARD --- */
        #dashboard-screen { padding: 20px; display: flex; flex-direction: column; }
        .top-bar { height: 60px; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .app-brand { font-size: 24px; font-weight: bold; color: #f00; }
        
        /* Menu Cards - Simples */
        .menu-grid { display: flex; gap: 20px; justify-content: center; margin-top: 50px; }
        .menu-card {
            width: 180px; height: 180px; background: #111; border: 2px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-card i { font-size: 50px; margin-bottom: 10px; color: #888; }
        .menu-card h3 { font-size: 18px; margin: 0; }
        
        .menu-card.focused { background: #333; border-color: #f00; }
        .menu-card.focused i { color: #fff; }

        /* --- CONTEUDO --- */
        #content-screen { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #050505; border-right: 2px solid #222; display: flex; flex-direction: column; }
        .cat-list { flex: 1; overflow-y: hidden; /* Remove scroll nativo pesado */ } 
        
        .cat-item { padding: 10px; color: #aaa; border-bottom: 1px solid #111; font-size: 14px; white-space: nowrap; overflow: hidden; }
        .cat-item.active { background: #333; color: #fff; font-weight: bold; }
        .cat-item.focused { background: #f00; color: #fff; }

        .content-area { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        
        /* Header Conteudo */
        .content-header { height: 50px; border-bottom: 2px solid #222; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        
        /* Botão Busca - Simples */
        #search-btn { width: 40px; height: 40px; background: #222; display: flex; align-items: center; justify-content: center; border: 1px solid #444; }
        #search-btn.focused { background: #f00; border-color: #fff; }

        /* Modal Busca */
        #search-modal { position: absolute; top: 50px; left: 0; width: 100%; background: #111; padding: 10px; display: none; border-bottom: 2px solid #f00; z-index: 99; }
        #search-modal.active { display: block; }
        #local-search-input { width: 100%; padding: 10px; font-size: 18px; color: #000; }

        /* Grid - Cards Pequenos e Leves */
        #grid { 
            padding: 20px; overflow: hidden; /* JS controla scroll */
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 10px; align-content: start;
        }
        
        .item-card { height: 160px; background: #111; border: 1px solid #333; position: relative; }
        .item-card.focused { border: 3px solid #f00; z-index: 5; }
        
        .poster { height: 120px; background-color: #222; background-size: cover; background-position: center; }
        .meta { height: 40px; font-size: 12px; display: flex; align-items: center; justify-content: center; text-align: center; background: #000; color: #ccc; }
        .item-card.focused .meta { background: #f00; color: #fff; }

        /* Player */
        #player-screen { background: #000; z-index: 9999; }
        #video-player { width: 100%; height: 100%; }
        #toast { position: fixed; top: 10px; right: 10px; background: #f00; color: #fff; padding: 10px; font-weight: bold; display: none; font-size: 16px; border: 2px solid #fff; z-index: 10000; }
        
        /* Spinner Simples */
        .spinner { position: absolute; top: 45%; left: 45%; color: red; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="toast">Aviso</div>

    <div id="login-screen" class="full-screen">
        <div class="login-box">
            <div class="logo-title">XEON LITE</div>
            <input type="text" id="login-dns" class="xeon-input focusable" placeholder="URL DNS">
            <input type="text" id="login-user" class="xeon-input focusable" placeholder="Usuário">
            <input type="password" id="login-pass" class="xeon-input focusable" placeholder="Senha">
            <button id="btn-login" class="btn-xeon focusable" onclick="App.login()">ENTRAR</button>
        </div>
    </div>

    <div id="dashboard-screen" class="full-screen hidden">
        <div class="top-bar">
            <div class="app-brand">XEON V44</div>
            <div id="clock-display" style="font-size: 18px; font-weight: bold;">00:00</div>
        </div>
        <div class="menu-grid">
            <div class="menu-card focusable" onclick="App.openCategory('live')"><i class="fas fa-tv"></i><h3>TV</h3></div>
            <div class="menu-card focusable" onclick="App.openCategory('movie')"><i class="fas fa-film"></i><h3>Filmes</h3></div>
            <div class="menu-card focusable" onclick="App.openCategory('series')"><i class="fas fa-list"></i><h3>Séries</h3></div>
            <div class="menu-card focusable" onclick="App.logout()"><i class="fas fa-times"></i><h3>Sair</h3></div>
        </div>
    </div>

    <div id="content-screen" class="full-screen hidden">
        <div class="sidebar">
            <div style="padding:10px; font-weight:bold; border-bottom:1px solid #333; text-align:center;">MENU</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="content-area">
            <div class="content-header">
                <span id="section-title">Lista</span>
                <div id="search-btn" class="focusable" onclick="App.toggleSearch()"><i class="fas fa-search"></i></div>
            </div>
            <div id="search-modal">
                <input type="text" id="local-search-input" placeholder="Pesquisar..." onkeydown="if(event.key==='Enter') App.contextSearch()">
            </div>
            <div id="grid"></div>
        </div>
    </div>

    <div id="episodes-screen" class="full-screen hidden">
        <div style="padding:10px; border-bottom:1px solid #333; font-size:18px;">Episódios <span style="font-size:12px; color:#888;">(Voltar para sair)</span></div>
        <div id="ep-list" style="padding:10px; overflow-y:auto; height:90%;"></div>
    </div>

    <div id="player-screen" class="full-screen hidden">
        <div id="spinner" class="spinner hidden">CARREGANDO...</div>
        <video id="video-player"></video>
    </div>

    <script>
        // RELOGIO SIMPLES
        setInterval(() => {
            const d = new Date();
            const el = document.getElementById('clock-display');
            if(el) el.innerText = d.toLocaleTimeString('pt-BR');
        }, 1000);

        const State = {
            server: '', user: '', pass: '',
            screen: 'login', currentType: '',
            activeCategoryElement: null, lastFocusedId: null,
            streams: [], playlist: [], playIndex: -1, hls: null,
            searchOpen: false,
            lastInputTime: 0 // Anti-bounce
        };

        const Utils = {
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },
            storage: {
                set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
                get: (k) => JSON.parse(localStorage.getItem(k) || 'null')
            }
        };

        const API = {
            auth: async (dns, u, p) => {
                try {
                    if(!dns.startsWith('http')) dns = 'http://' + dns;
                    const res = await fetch(`${dns}/player_api.php?username=${u}&password=${p}`);
                    const data = await res.json();
                    if(data.user_info && data.user_info.auth === 1) {
                        State.server = dns; State.user = u; State.pass = p;
                        Utils.storage.set('xeon_v44', {dns, u, p});
                        return true;
                    }
                    return false;
                } catch(e) { return false; }
            },
            get: async (action, catId) => {
                let url = `${State.server}/player_api.php?username=${State.user}&password=${State.pass}&action=${action}`;
                if(catId && catId !== 'all') url += `&category_id=${catId}`;
                try { const res = await fetch(url); return await res.json(); } catch(e) { return []; }
            },
            getSeriesInfo: async (id) => {
                const res = await fetch(`${State.server}/player_api.php?username=${State.user}&password=${State.pass}&action=get_series_info&series_id=${id}`);
                return await res.json();
            }
        };

        const App = {
            init: async () => {
                const saved = Utils.storage.get('xeon_v44');
                if(saved) {
                    document.getElementById('login-dns').value = saved.dns;
                    document.getElementById('login-user').value = saved.u;
                    document.getElementById('login-pass').value = saved.p;
                    if(await API.auth(saved.dns, saved.u, saved.p)) App.showScreen('dashboard');
                } else {
                    document.getElementById('login-dns').focus();
                }
                Nav.init();
            },
            login: async () => {
                const d = document.getElementById('login-dns').value.trim();
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                if(await API.auth(d, u, p)) App.showScreen('dashboard'); else Utils.toast("Erro Login");
            },
            logout: () => { localStorage.clear(); location.reload(); },
            showScreen: (id) => {
                document.querySelectorAll('.full-screen').forEach(el => el.classList.add('hidden'));
                document.getElementById(id + '-screen').classList.remove('hidden');
                State.screen = id;
                setTimeout(Nav.resetFocus, 50);
            },
            toggleSearch: () => {
                State.searchOpen = !State.searchOpen;
                const modal = document.getElementById('search-modal');
                if (State.searchOpen) {
                    modal.classList.add('active');
                    setTimeout(() => document.getElementById('local-search-input').focus(), 100);
                } else {
                    modal.classList.remove('active');
                    Nav.focus(document.getElementById('search-btn'));
                }
            },
            openCategory: async (type) => {
                State.currentType = type;
                App.showScreen('content');
                State.activeCategoryElement = null; 
                document.getElementById('grid').innerHTML = '<div style="padding:20px; text-align:center;">Carregando...</div>';
                
                const cats = await API.get(type==='live'?'get_live_categories':type==='movie'?'get_vod_categories':'get_series_categories');
                let html = `<div id="cat-all" class="cat-item focusable" onclick="App.loadItems('all', this)">Todos</div>`;
                cats.forEach(c => html += `<div id="cat-${c.category_id}" class="cat-item focusable" onclick="App.loadItems('${c.category_id}', this)">${c.category_name}</div>`);
                document.getElementById('cat-list').innerHTML = html;
                
                setTimeout(() => { 
                    const first = document.getElementById('cat-all');
                    Nav.focus(first); 
                    State.activeCategoryElement = first;
                }, 100);
            },
            loadItems: async (catId, element) => {
                if(element) {
                    document.querySelectorAll('.cat-item').forEach(c => c.classList.remove('active'));
                    element.classList.add('active');
                    State.activeCategoryElement = element;
                }
                document.getElementById('grid').innerHTML = '<div style="padding:20px;">Carregando...</div>';
                
                const items = await API.get(State.currentType==='live'?'get_live_streams':State.currentType==='movie'?'get_vod_streams':'get_series', catId);
                State.streams = items;
                App.renderGrid(items);
            },
            contextSearch: async () => {
                const term = document.getElementById('local-search-input').value.toLowerCase();
                const filtered = State.streams.filter(i => (i.name||i.title||'').toLowerCase().includes(term));
                App.renderGrid(filtered);
                App.toggleSearch(); // Fecha busca e foca no grid
                setTimeout(() => {
                    const first = document.querySelector('.item-card');
                    if(first) Nav.focus(first);
                }, 100);
            },
            renderGrid: (items) => {
                const grid = document.getElementById('grid'); grid.innerHTML = '';
                // LIMITADOR DE MEMÓRIA: SÓ RENDERIZA 48 ITENS
                if(!items.length) { grid.innerHTML = 'Vazio.'; return; }
                
                const limit = items.slice(0, 48); 
                limit.forEach(item => {
                    const id = item.stream_id || item.series_id;
                    const d = document.createElement('div'); d.className = 'item-card focusable'; 
                    d.id = `item-${id}`;
                    d.onclick = () => App.clickItem(item);
                    d.innerHTML = `<div class="poster" style="background-image:url('${item.stream_icon||item.cover||''}')"></div><div class="meta">${(item.name||item.title).substring(0, 20)}</div>`;
                    grid.appendChild(d);
                });
            },
            clickItem: (item) => {
                State.lastFocusedId = `item-${item.stream_id || item.series_id}`;
                if(State.currentType==='live') Player.playLive(item);
                else if(State.currentType==='movie') Player.playMovie(item);
                else App.openSeries(item);
            },
            openSeries: async (item) => {
                Utils.toast("Abrindo...");
                const info = await API.getSeriesInfo(item.series_id);
                let eps = [];
                if(info.episodes) { if(Array.isArray(info.episodes)) eps = info.episodes; else Object.values(info.episodes).forEach(v => eps = eps.concat(v)); }
                State.playlist = eps;
                document.getElementById('ep-series-title').innerText = item.name||item.title;
                const list = document.getElementById('ep-list'); list.innerHTML = '';
                eps.forEach((ep, i) => {
                    const d = document.createElement('div'); d.className = 'ep-item focusable'; d.id = `ep-idx-${i}`;
                    d.style.marginBottom = "5px";
                    d.innerHTML = `S${ep.season} E${ep.episode_num} - ${ep.title}`;
                    d.onclick = () => Player.playSeries(i); list.appendChild(d);
                });
                App.showScreen('episodes');
                setTimeout(() => { const f=document.getElementById('ep-idx-0'); if(f) Nav.focus(f); }, 100);
            }
        };

        const Player = {
            video: document.getElementById('video-player'),
            playLive: (item) => Player.start(`${State.server}/live/${State.user}/${State.pass}/${item.stream_id}.m3u8`),
            playMovie: (item) => Player.start(`${State.server}/movie/${State.user}/${State.pass}/${item.stream_id}.${item.container_extension||'mp4'}`),
            playSeries: (i) => { State.playIndex = i; const ep = State.playlist[i]; Player.start(`${State.server}/series/${State.user}/${State.pass}/${ep.id}.${ep.container_extension||'mp4'}`); },
            start: (url) => {
                document.getElementById('spinner').classList.remove('hidden'); App.showScreen('player');
                const v = Player.video;
                if(Hls.isSupported() && url.includes('.m3u8')) {
                    if(State.hls) State.hls.destroy();
                    // CONFIGURAÇÃO ULTRA LEVE HLS
                    State.hls = new Hls({
                        maxBufferLength: 10, // Buffer minúsculo para economizar RAM
                        maxMaxBufferLength: 10,
                        enableWorker: false // Worker trava TVs velhas
                    });
                    State.hls.loadSource(url); State.hls.attachMedia(v);
                    State.hls.on(Hls.Events.MANIFEST_PARSED, () => v.play());
                } else { v.src = url; v.play(); }
                v.onplaying = () => document.getElementById('spinner').classList.add('hidden');
            },
            stop: () => {
                const v = Player.video; v.pause(); v.removeAttribute('src'); v.load();
                if(State.hls) { State.hls.destroy(); State.hls = null; }
                if(State.currentType==='series') App.showScreen('episodes');
                else {
                    App.showScreen('content');
                    // Tenta focar de volta
                    if(State.lastFocusedId) setTimeout(() => {
                        const el = document.getElementById(State.lastFocusedId);
                        if(el) { Nav.focus(el); el.scrollIntoView({block:'center'}); }
                    }, 100);
                }
            }
        };

        // --- NAVEGAÇÃO BÁSICA (SEM CALCULOS PESADOS) ---
        const Nav = {
            focused: null,
            init: () => {
                window.addEventListener('keydown', (e) => {
                    const now = Date.now();
                    // Anti-bounce simples (150ms)
                    if (now - State.lastInputTime < 150) return;
                    State.lastInputTime = now;

                    const k = e.key;
                    
                    if (document.activeElement.tagName === 'INPUT') {
                        if (k === 'Enter') { 
                            if(State.screen === 'login') App.login();
                            else App.contextSearch(); 
                        }
                        if (k === 'ArrowDown') { /* Sair da busca */
                             const grid = document.querySelector('.item-card');
                             if(grid) Nav.focus(grid);
                        }
                        return;
                    }

                    if(k === 'Escape' || k === 'Backspace') {
                        if(State.screen === 'player') Player.stop();
                        else if(State.screen === 'episodes') App.showScreen('content');
                        else if(State.screen === 'content') App.showScreen('dashboard');
                        return;
                    }

                    const map = {'ArrowUp':'up', 'ArrowDown':'down', 'ArrowLeft':'left', 'ArrowRight':'right', 'Enter':'enter'};
                    if(map[k]) { e.preventDefault(); Nav.move(map[k]); }
                });
            },
            resetFocus: () => { const el = document.querySelector(`#${State.screen}-screen .focusable`); if(el) Nav.focus(el); },
            focus: (el) => {
                if(Nav.focused) Nav.focused.classList.remove('focused');
                Nav.focused = el; Nav.focused.classList.add('focused');
                el.scrollIntoView({block:'center', behavior:'auto'}); // Auto = Sem animação
            },
            move: (dir) => {
                if(dir === 'enter') { if(Nav.focused) Nav.focused.click(); return; }

                // Lógica de LUPA
                if (dir === 'up' && Nav.focused.classList.contains('item-card')) {
                    const rect = Nav.focused.getBoundingClientRect();
                    // Se estiver no topo, vai pra lupa
                    if(rect.top < 200) {
                        Nav.focus(document.getElementById('search-btn'));
                        return;
                    }
                }

                const els = Array.from(document.querySelectorAll(`#${State.screen}-screen .focusable`));
                // Filtrar apenas visíveis se necessário, mas querySelectorAll já ajuda
                
                const cur = Nav.focused.getBoundingClientRect();
                let best = null, minDist = Infinity;

                els.forEach(el => {
                    if (el === Nav.focused) return;
                    // Ignora input de busca se fechado
                    if(!State.searchOpen && el.id === 'local-search-input') return;

                    const rect = el.getBoundingClientRect();
                    
                    // Lógica de direção SIMPLIFICADA (Geometria Básica)
                    let ok = false;
                    if(dir==='up') ok = rect.bottom <= cur.top && Math.abs((rect.left+rect.width/2) - (cur.left+cur.width/2)) < 50; 
                    if(dir==='down') ok = rect.top >= cur.bottom && Math.abs((rect.left+rect.width/2) - (cur.left+cur.width/2)) < 50;
                    if(dir==='left') ok = rect.right <= cur.left && Math.abs((rect.top+rect.height/2) - (cur.top+cur.height/2)) < 50;
                    if(dir==='right') ok = rect.left >= cur.right && Math.abs((rect.top+rect.height/2) - (cur.top+cur.height/2)) < 50;

                    // Fallback para grids irregulares (Sidebar -> Grid)
                    if(!ok && dir === 'right' && Nav.focused.classList.contains('cat-item') && el.classList.contains('item-card')) ok = true;
                    if(!ok && dir === 'left' && Nav.focused.classList.contains('item-card') && el.classList.contains('cat-item')) {
                        // Só volta pra categoria ativa
                        if(el.classList.contains('active')) ok = true;
                    }

                    if (ok) {
                        const dist = Math.hypot(rect.x - cur.x, rect.y - cur.y);
                        if (dist < minDist) { minDist = dist; best = el; }
                    }
                });

                if(best) Nav.focus(best);
            }
        };
        App.init();
    </script>
</body>
</html>
