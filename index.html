<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&C GOLD XTREAM V22</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- TEMA PREMIUM GOLD V22 --- */
        :root { 
            --bg: #050505; 
            --gold: #FFD700; 
            --gold-dim: #b8860b;
            --text: #ffffff; 
            --panel: rgba(20, 20, 20, 0.95);
            --input-bg: #1a1a1a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }

        /* UTILITÁRIOS */
        .hide { display: none !important; }
        .show-flex { display: flex !important; }
        
        /* HEADER */
        .top-bar {
            height: 10vh; display: flex; align-items: center; justify-content: space-between;
            padding: 0 4vw; border-bottom: 1px solid #333;
            background: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
        }
        .logo h1 { font-size: 2.5vh; color: var(--gold); letter-spacing: 2px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }

        /* --- TELA DE LOGIN --- */
        #login-screen {
            height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            width: 40vw; background: var(--panel); padding: 4vh;
            border: 1px solid var(--gold-dim); border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            text-align: center;
        }
        .login-box h2 { color: var(--gold); margin-bottom: 3vh; font-size: 3vh; }
        
        .input-group { margin-bottom: 2vh; text-align: left; }
        .input-group label { display: block; color: #888; font-size: 1.5vh; margin-bottom: 0.5vh; margin-left: 10px;}
        .login-input {
            width: 100%; padding: 1.5vh; background: var(--input-bg);
            border: 2px solid #333; color: white; border-radius: 8px; font-size: 2vh;
        }
        .login-input:focus { border-color: var(--gold); }
        
        .btn-login {
            width: 100%; padding: 2vh; margin-top: 2vh;
            background: linear-gradient(90deg, var(--gold-dim), var(--gold));
            border: none; color: black; font-weight: bold; font-size: 2vh;
            border-radius: 8px; cursor: pointer; text-transform: uppercase;
        }

        /* --- DASHBOARD (MENU PRINCIPAL) --- */
        #dashboard-screen { height: 90vh; justify-content: center; align-items: center; gap: 2vw; }
        
        .card {
            width: 20vw; height: 30vh; background: linear-gradient(145deg, #151515, #0a0a0a);
            border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: all 0.2s;
        }
        .card i { font-size: 6vh; color: #555; margin-bottom: 2vh; }
        .card span { font-size: 2vh; font-weight: 600; color: #888; }

        /* --- TELA DE CATEGORIAS E CANAIS --- */
        #list-screen { height: 90vh; display: none; }
        
        .sidebar { width: 30vw; height: 100%; background: #080808; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .list-header { padding: 2vh; background: #111; color: var(--gold); font-weight: bold; border-bottom: 1px solid var(--gold); }
        
        .list-items { flex: 1; overflow-y: auto; }
        .list-item {
            padding: 1.5vh 2vh; border-bottom: 1px solid #222; font-size: 1.6vh; color: #ccc;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .content-area { width: 70vw; height: 100%; background: #000; position: relative; }
        #player { width: 100%; height: 100%; }
        
        .info-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8);
            padding: 2vh; display: none;
        }

        /* --- FOCO (CONTROLE REMOTO) --- */
        .focused {
            border-color: var(--gold) !important;
            background: #252525 !important;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            z-index: 10;
        }
        .focused i { color: var(--gold) !important; }
        .focused span { color: #fff !important; }
        .list-item.focused { background: var(--gold) !important; color: #000 !important; transform: none; box-shadow: none; }
        .login-input.focused { border-color: var(--gold); background: #222; }
        .btn-login.focused { box-shadow: 0 0 15px var(--gold); color: white; }

        /* Loading */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #loader-text { margin-top: 20px; color: var(--gold); }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><div id="loader-text">CONECTANDO...</div></div>

    <div class="top-bar">
        <div class="logo"><h1>R&C <span style="color:#fff">GOLD</span></h1></div>
        <div style="color:#fff; font-size:1.5vh;" id="status">Desconectado</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2>ACESSO SERVIDOR</h2>
            <div class="input-group">
                <label>DNS / SERVIDOR (ex: http://servidor.com:80)</label>
                <input type="text" id="host" class="login-input focusable" placeholder="http://url_do_dns:porta">
            </div>
            <div class="input-group">
                <label>USUÁRIO</label>
                <input type="text" id="user" class="login-input focusable" placeholder="Seu Usuário">
            </div>
            <div class="input-group">
                <label>SENHA</label>
                <input type="password" id="pass" class="login-input focusable" placeholder="Sua Senha">
            </div>
            <button class="btn-login focusable" onclick="App.doLogin()">CONECTAR</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hide">
        <div class="card focusable" onclick="App.loadCategories('live')">
            <i class="fas fa-tv"></i><span>TV AO VIVO</span>
        </div>
        <div class="card focusable" onclick="App.loadCategories('movie')">
            <i class="fas fa-film"></i><span>FILMES</span>
        </div>
        <div class="card focusable" onclick="App.loadCategories('series')">
            <i class="fas fa-video"></i><span>SÉRIES</span>
        </div>
        <div class="card focusable" onclick="App.logout()">
            <i class="fas fa-sign-out-alt"></i><span>SAIR</span>
        </div>
    </div>

    <div id="list-screen">
        <div class="sidebar">
            <div class="list-header" id="list-title">CATEGORIAS</div>
            <div class="list-items" id="dynamic-list">
                </div>
        </div>
        <div class="content-area">
            <video id="player" controls></video>
            <div class="info-overlay" id="info-bar">
                <h2 id="now-playing">Selecione um canal</h2>
            </div>
        </div>
    </div>

    <script>
        const App = {
            data: { host: '', user: '', pass: '' },
            screen: 'login', // login, dashboard, categories, streams
            focusIndex: 0,
            items: [],
            hls: null,
            
            // Inicialização
            init: function() {
                // Tenta recuperar dados salvos
                const saved = localStorage.getItem('iptv_creds');
                if (saved) {
                    this.data = JSON.parse(saved);
                    document.getElementById('host').value = this.data.host;
                    document.getElementById('user').value = this.data.user;
                    document.getElementById('pass').value = this.data.pass;
                    // Se já tem dados, foca no botão conectar
                    setTimeout(() => { 
                        this.items = document.querySelectorAll('#login-screen .focusable');
                        this.focusIndex = 3; 
                        this.updateFocus();
                    }, 500);
                } else {
                    this.scanFocusables();
                }

                // Escuta teclado
                document.addEventListener('keydown', (e) => this.handleKey(e));
            },

            // Navegação de Foco
            scanFocusables: function() {
                let scope = '';
                if(this.screen === 'login') scope = '#login-screen';
                else if(this.screen === 'dashboard') scope = '#dashboard-screen';
                else if(this.screen === 'categories' || this.screen === 'streams') scope = '#dynamic-list';

                this.items = document.querySelectorAll(`${scope} .focusable`);
                this.focusIndex = 0;
                this.updateFocus();
            },

            updateFocus: function() {
                document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused'));
                if(this.items[this.focusIndex]) {
                    this.items[this.focusIndex].classList.add('focused');
                    this.items[this.focusIndex].scrollIntoView({block: "center", behavior: "smooth"});
                    
                    // Se for Input, focar de verdade para aparecer teclado
                    if(this.items[this.focusIndex].tagName === 'INPUT') {
                        this.items[this.focusIndex].focus();
                    }
                }
            },

            handleKey: function(e) {
                const k = e.keyCode;
                // 37-40 (Setas), 13 (Enter), 461/10009/8 (Voltar)
                
                if (k === 8 || k === 461 || k === 10009) {
                    e.preventDefault();
                    this.goBack();
                    return;
                }

                if (this.screen === 'login') {
                    if(k === 40) { this.focusIndex++; if(this.focusIndex >= this.items.length) this.focusIndex=this.items.length-1; this.updateFocus(); }
                    if(k === 38) { this.focusIndex--; if(this.focusIndex < 0) this.focusIndex=0; this.updateFocus(); }
                    if(k === 13) { this.items[this.focusIndex].click(); }
                }
                else if (this.screen === 'dashboard') {
                    if(k === 39) { this.focusIndex++; if(this.focusIndex >= this.items.length) this.focusIndex=this.items.length-1; this.updateFocus(); }
                    if(k === 37) { this.focusIndex--; if(this.focusIndex < 0) this.focusIndex=0; this.updateFocus(); }
                    if(k === 13) { this.items[this.focusIndex].click(); }
                }
                else if (this.screen === 'categories' || this.screen === 'streams') {
                    if(k === 40) { this.focusIndex++; if(this.focusIndex >= this.items.length) this.focusIndex=this.items.length-1; this.updateFocus(); }
                    if(k === 38) { this.focusIndex--; if(this.focusIndex < 0) this.focusIndex=0; this.updateFocus(); }
                    if(k === 13) { this.items[this.focusIndex].click(); }
                    if(k === 39 && this.screen === 'streams') { document.getElementById('player').focus(); } // Focar player
                }
            },

            // --- LÓGICA DE LOGIN ---
            doLogin: function() {
                const h = document.getElementById('host').value.trim(); // .replace(/\/$/, "");
                const u = document.getElementById('user').value.trim();
                const p = document.getElementById('pass').value.trim();

                if(!h || !u || !p) { alert("Preencha tudo!"); return; }

                this.data = { host: h, user: u, pass: p };
                localStorage.setItem('iptv_creds', JSON.stringify(this.data));

                this.setLoading(true, "Autenticando...");

                // Teste simples de conexão (Get Live Categories)
                const url = `${this.data.host}/player_api.php?username=${this.data.user}&password=${this.data.pass}&action=get_live_categories`;
                
                fetch(url)
                    .then(r => r.json())
                    .then(d => {
                        this.setLoading(false);
                        if(d && d.length > 0) {
                            document.getElementById('status').innerText = "Conectado: " + this.data.user;
                            this.changeScreen('dashboard');
                        } else {
                            alert("Login falhou ou lista vazia.");
                        }
                    })
                    .catch(e => {
                        this.setLoading(false);
                        alert("Erro de conexão. Verifique DNS ou CORS.\n" + e);
                        // Hack: Permite entrar mesmo com erro se o usuário insistir (pra TVs antigas com CORS chato)
                        if(confirm("Deseja tentar entrar forçado? (Se for erro de CORS pode funcionar)")) {
                            this.changeScreen('dashboard');
                        }
                    });
            },

            // --- API & NAVEGAÇÃO ---
            loadCategories: function(type) {
                this.currentType = type;
                let action = '';
                if(type === 'live') action = 'get_live_categories';
                if(type === 'movie') action = 'get_vod_categories';
                if(type === 'series') action = 'get_series_categories';

                this.setLoading(true, "Baixando Categorias...");
                const url = `${this.data.host}/player_api.php?username=${this.data.user}&password=${this.data.pass}&action=${action}`;

                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        this.renderList(data, 'category');
                        this.changeScreen('categories');
                        document.getElementById('list-title').innerText = "CATEGORIAS";
                        this.setLoading(false);
                    })
                    .catch(e => { this.setLoading(false); alert("Erro ao carregar categorias."); });
            },

            loadStreams: function(catId) {
                let action = '';
                if(this.currentType === 'live') action = `get_live_streams&category_id=${catId}`;
                if(this.currentType === 'movie') action = `get_vod_streams&category_id=${catId}`;
                if(this.currentType === 'series') action = `get_series&category_id=${catId}`; // Séries é diferente na API Xtream

                this.setLoading(true, "Carregando Canais...");
                const url = `${this.data.host}/player_api.php?username=${this.data.user}&password=${this.data.pass}&action=${action}`;

                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        this.renderList(data, 'stream');
                        this.changeScreen('streams');
                        document.getElementById('list-title').innerText = "CANAIS / FILMES";
                        this.setLoading(false);
                    })
                    .catch(e => { this.setLoading(false); alert("Erro ao carregar lista."); });
            },

            renderList: function(data, mode) {
                const list = document.getElementById('dynamic-list');
                list.innerHTML = '';
                
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item focusable';
                    
                    if (mode === 'category') {
                        div.innerText = item.category_name;
                        div.onclick = () => this.loadStreams(item.category_id);
                    } else {
                        // Stream ou Filme
                        div.innerText = item.name;
                        // Montar URL do Stream
                        let streamUrl = "";
                        if(this.currentType === 'live') {
                            streamUrl = `${this.data.host}/live/${this.data.user}/${this.data.pass}/${item.stream_id}.m3u8`;
                        } else if(this.currentType === 'movie') {
                            streamUrl = `${this.data.host}/movie/${this.data.user}/${this.data.pass}/${item.stream_id}.${item.container_extension}`;
                        }
                        
                        div.onclick = () => this.playStream(streamUrl, item.name);
                    }
                    list.appendChild(div);
                });
                
                // Reseta foco para o topo da lista
                this.scanFocusables();
            },

            playStream: function(url, name) {
                const video = document.getElementById('player');
                document.getElementById('now-playing').innerText = name;
                document.getElementById('info-bar').style.display = 'block';

                if (Hls.isSupported() && url.includes('.m3u8')) {
                    if(this.hls) this.hls.destroy();
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
                } else {
                    video.src = url;
                    video.play();
                }
            },

            // --- UTILITÁRIOS DE TELA ---
            changeScreen: function(newScreen) {
                document.getElementById('login-screen').classList.add('hide');
                document.getElementById('dashboard-screen').classList.remove('show-flex'); // Flex precisa de cuidado
                document.getElementById('dashboard-screen').classList.add('hide');
                document.getElementById('list-screen').classList.remove('show-flex');
                document.getElementById('list-screen').style.display = 'none';

                this.screen = newScreen;

                if(newScreen === 'dashboard') {
                    document.getElementById('dashboard-screen').classList.remove('hide');
                    document.getElementById('dashboard-screen').classList.add('show-flex');
                } else if(newScreen === 'categories' || newScreen === 'streams') {
                    document.getElementById('list-screen').style.display = 'flex';
                    document.getElementById('list-screen').classList.add('show-flex');
                }

                this.scanFocusables();
            },

            goBack: function() {
                if(this.screen === 'streams') {
                    this.changeScreen('categories');
                    // Para o player
                    const v = document.getElementById('player'); v.pause(); v.src = "";
                }
                else if(this.screen === 'categories') {
                    this.changeScreen('dashboard');
                }
                else if(this.screen === 'dashboard') {
                    if(confirm("Sair do Login?")) {
                        localStorage.removeItem('iptv_creds');
                        location.reload();
                    }
                }
            },
            
            logout: function() {
                 localStorage.removeItem('iptv_creds');
                 location.reload();
            },

            setLoading: function(active, text) {
                const l = document.getElementById('loader');
                l.style.display = active ? 'flex' : 'none';
                if(text) document.getElementById('loader-text').innerText = text;
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
