<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>IPTV GOLD | ULTIMATE EDITION</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- TEMA DARK/GOLD VIP --- */
        :root { 
            --gold-main: #d4af37;
            --gold-dim: #8a6e18;
            --gold-bright: #fff2cc;
            --bg-deep: #000000;
            --bg-panel: #0b0b0b;
            --bg-item: #111;
            --focus-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-deep); 
            color: #e0e0e0;
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
            background-image: url('https://static.vecteezy.com/system/resources/previews/006/468/964/original/abstract-black-hexagon-luxury-background-with-gold-line-texture-free-vector.jpg');
            background-size: cover; background-position: center;
        }

        /* UTILITÁRIOS */
        .hide { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        /* Cursor habilitado para PC */
        button, .smart-card, .cat-item, .item, .power-btn { cursor: pointer; }

        /* --- SISTEMA DE FOCO (ESTILO VISUAL 04) --- */
        .focused {
            background: linear-gradient(90deg, var(--gold-dim) 0%, var(--gold-main) 100%) !important;
            color: #000 !important;
            border-left: 5px solid #fff !important;
            transform: scale(1.01);
            z-index: 50;
            box-shadow: var(--focus-shadow);
            font-weight: 800 !important;
        }
        .focused * { color: #000 !important; }

        /* EXCEÇÃO: O Player não pode ter fundo colorido, apenas borda */
        #vid-box.focused {
            background: #000 !important;
            border: 3px solid var(--gold-main) !important;
            border-left: 3px solid var(--gold-main) !important;
            color: #fff !important;
            transform: none !important;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.6);
        }

        /* --- LOGIN --- */
        #login-layer { background: rgba(0,0,0,0.92); backdrop-filter: blur(5px); }
        .login-box { 
            width: 420px; padding: 45px; 
            background: rgba(15, 15, 15, 0.98); 
            border: 1px solid #333; border-top: 4px solid var(--gold-main);
            border-radius: 8px; text-align: center; box-shadow: 0 20px 60px #000;
        }
        .logo-txt { font-family: 'Cinzel', serif; font-size: 38px; color: #fff; margin-bottom: 5px; }
        .logo-txt span { color: var(--gold-main); }
        .inp { width: 100%; padding: 15px; margin: 10px 0; background: #080808; border: 1px solid #333; color: var(--gold-main); text-align: center; border-radius: 4px; font-weight: 600; }
        .btn { width: 100%; padding: 15px; margin-top: 20px; background: var(--gold-main); color: #000; border: none; font-weight: 900; border-radius: 4px; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { background: #fff; }

        /* --- DASHBOARD (MENU PRINCIPAL) --- */
        #dash-layer { 
            display: flex; flex-direction: column; padding: 40px 60px; justify-content: space-between;
            background: rgba(0,0,0,0.85); /* Fundo escuro para destacar os cards */
        }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 80px; }
        .user-welcome { font-size: 18px; color: #aaa; text-transform: uppercase; }
        .user-welcome span { color: #fff; font-weight: 700; margin-left: 5px; }
        .dash-clock { text-align: right; }
        .clock-time { font-size: 34px; font-weight: 300; color: #fff; }
        .clock-date { font-size: 11px; color: var(--gold-main); letter-spacing: 2px; text-transform: uppercase; }

        .dash-grid { display: flex; gap: 40px; justify-content: center; align-items: center; flex: 1; }
        
        /* CARDS GRANDES (RESTAURADOS) */
        .smart-card { 
            width: 270px; height: 340px; 
            background: linear-gradient(160deg, #181818, #050505);
            border: 1px solid #333; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .smart-card i { font-size: 70px; margin-bottom: 25px; color: #555; transition: 0.3s; }
        .smart-card span { font-size: 18px; font-weight: 700; color: #999; letter-spacing: 2px; text-transform: uppercase; }
        
        .focused.smart-card i { color: #000; } /* Ícone preto no foco */

        .account-bar { 
            display: flex; justify-content: center; gap: 40px; 
            background: rgba(255,255,255,0.05); padding: 12px 30px; border-radius: 50px; 
            border: 1px solid rgba(255,255,255,0.05); margin: 0 auto;
        }
        .acc-lbl { font-size: 9px; color: #666; font-weight: 800; display: block; text-align: center; margin-bottom: 2px; }
        .acc-val { font-size: 13px; color: #ddd; font-weight: 700; }

        /* --- PLAYER INTERNO (ALINHAMENTO 3 COLUNAS PERFEITO) --- */
        #content-layer { display: flex; height: 100vh; background: #000; overflow: hidden; }

        /* COLUNA 1: CATEGORIAS (22%) */
        .col-cat { 
            width: 22%; min-width: 240px; 
            background: #080808; border-right: 1px solid #222; 
            display: flex; flex-direction: column; 
        }
        .cat-head { 
            height: 60px; display: flex; align-items: center; justify-content: center;
            background: #050505; color: var(--gold-main); font-weight: 800; 
            border-bottom: 2px solid var(--gold-main); font-family: 'Cinzel', serif; letter-spacing: 1px;
        }
        .cat-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .cat-item { 
            padding: 14px 20px; border-bottom: 1px solid #141414; 
            color: #888; font-size: 13px; font-weight: 600; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .cat-item.active { 
            background: #1a1a1a; border-left: 4px solid var(--gold-main); color: #fff; 
        }

        /* COLUNA 2: CANAIS (30%) */
        .col-list { 
            width: 30%; min-width: 300px; 
            background: #111; border-right: 1px solid #222; 
            display: flex; flex-direction: column; 
        }
        .search-area { height: 60px; padding: 10px; background: #0e0e0e; border-bottom: 1px solid #222; display: flex; align-items: center; }
        .inp-search { 
            width: 100%; height: 35px; background: #222; border: 1px solid #333; 
            color: #fff; text-align: center; border-radius: 4px; 
            text-transform: uppercase; font-weight: bold; font-size: 12px;
        }
        .item-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .item { 
            padding: 14px 20px; border-bottom: 1px solid #1a1a1a; 
            color: #bbb; font-size: 14px; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; 
        }
        .item.playing { 
            color: var(--gold-main); font-weight: 800; 
            background: rgba(212, 175, 55, 0.08); border-left: 3px solid var(--gold-main); 
        }

        /* COLUNA 3: PLAYER & INFO (48%) */
        .col-play { 
            flex: 1; background: #000; 
            display: flex; flex-direction: column; position: relative; 
        }
        
        /* CAIXA DE VÍDEO FIXA */
        .vid-box { 
            width: 100%; 
            aspect-ratio: 16/9; /* Mantém sempre Widescreen */
            background: #000; position: relative; 
            border-bottom: 2px solid #222; 
        }
        
        /* FULLSCREEN REAL */
        #vid-box.fs { 
            position: fixed !important; top: 0 !important; left: 0 !important; 
            width: 100vw !important; height: 100vh !important; 
            z-index: 999999 !important; border: none !important; 
            background: #000 !important;
        }
        
        video { width: 100%; height: 100%; object-fit: contain; }

        .meta { 
            flex: 1; padding: 25px; display: flex; flex-direction: column; 
            background: linear-gradient(180deg, #111 0%, #000 100%); overflow: hidden; 
        }
        .meta-title { 
            font-size: 22px; color: var(--gold-main); font-weight: 700; 
            margin-bottom: 10px; font-family: 'Cinzel', serif; border-bottom: 1px solid #222; padding-bottom: 10px;
        }
        .meta-epg { 
            font-size: 12px; background: #222; color: #eee; 
            padding: 5px 10px; border-radius: 4px; display: inline-block; 
            margin-bottom: 15px; align-self: flex-start; 
        }
        .meta-desc { font-size: 13px; color: #777; line-height: 1.5; overflow-y: auto; flex: 1; }

        .keys { display: flex; gap: 20px; margin-top: 10px; padding-top: 15px; border-top: 1px solid #222; }
        .key { font-size: 10px; color: #666; text-transform: uppercase; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #loader { background: #000; z-index: 20000; flex-direction: column; color: var(--gold-main); }
        .osd-status { 
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.8); color: var(--gold-main); 
            padding: 8px 15px; border: 1px solid var(--gold-main); 
            font-weight: 800; border-radius: 4px; display: none; 
            z-index: 10000; pointer-events: none;
        }

        /* Scrollbars Finas */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #080808; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-main); }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="layer hide flex-center">
        <i class="fas fa-circle-notch fa-spin" style="font-size:50px; margin-bottom:20px"></i>
        <div style="font-weight:700; letter-spacing:2px">CARREGANDO SISTEMA...</div>
    </div>

    <div id="login-layer" class="layer flex-center">
        <div class="login-box">
            <div class="logo-txt">IPTV <span>GOLD</span></div>
            <div style="color:#666; font-size:10px; letter-spacing:4px; margin-bottom:30px">ACESSO RESTRITO</div>
            <input type="text" id="i0" class="inp focusable" placeholder="http://url-do-servidor:porta" autocomplete="off">
            <input type="text" id="i1" class="inp focusable" placeholder="USUÁRIO" autocomplete="off">
            <input type="password" id="i2" class="inp focusable" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn focusable" onclick="App.login()">ENTRAR</button>
            <div id="msg-login" style="color:#d9534f; margin-top:15px; font-size:12px; font-weight:600"></div>
        </div>
    </div>

    <div id="dash-layer" class="layer hide">
        <div class="top-bar">
            <div class="user-welcome">OLÁ, <span id="display-user">VISITANTE</span></div>
            <div class="dash-clock">
                <div id="clock-time" class="clock-time">00:00</div>
                <div id="clock-date" class="clock-date">--/--/----</div>
            </div>
            <div id="m3" class="power-btn focusable" onclick="App.logout()" style="color:#aaa; font-size:24px; padding:10px">
                <i class="fas fa-power-off"></i>
            </div>
        </div>

        <div class="dash-grid">
            <div id="m0" class="smart-card focusable" onclick="App.openMode('live')">
                <i class="fas fa-tv"></i><span>TV Ao Vivo</span>
            </div>
            <div id="m1" class="smart-card focusable" onclick="App.openMode('movie')">
                <i class="fas fa-film"></i><span>Filmes</span>
            </div>
            <div id="m2" class="smart-card focusable" onclick="App.openMode('series')">
                <i class="fas fa-layer-group"></i><span>Séries</span>
            </div>
        </div>

        <div class="account-bar">
            <div><span class="acc-lbl">CRIAÇÃO</span><span id="info-created" class="acc-val">--</span></div>
            <div style="margin:0 30px; border-left:1px solid #333; border-right:1px solid #333; padding:0 30px">
                <span class="acc-lbl">VENCIMENTO</span><span id="info-exp" class="acc-val" style="color:var(--gold-main)">--</span>
            </div>
            <div><span class="acc-lbl">TELAS</span><span id="info-conn" class="acc-val">--</span></div>
        </div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-area"><input type="text" id="search" class="inp-search focusable" placeholder="BUSCAR CANAL..." autocomplete="off"></div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="vid-box" class="vid-box focusable">
                <video id="player" playsinline webkit-playsinline></video>
                <div id="osd" class="osd-status"></div>
            </div>
            <div class="meta">
                <div id="meta-title" class="meta-title">R&C GOLD</div>
                <div id="meta-epg" class="meta-epg hide"></div>
                <div id="meta-desc" class="meta-desc">Selecione um canal na lista para assistir.</div>
                
                <div class="keys">
                    <div class="key"><div class="dot" style="background:#ff4444"></div> FULLSCREEN</div>
                    <div class="key"><div class="dot" style="background:#00C851"></div> RECARREGAR</div>
                    <div class="key"><div class="dot" style="background:#ffbb33"></div> BUSCA</div>
                    <div class="key"><div class="dot" style="background:#33b5e5"></div> MENU</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- ENGINE HÍBRIDA (Compatibilidade PC/TV) --- */
        var PlayerEngine = {
            hls: null, video: null, url: null, retry: 0,
            init: function() { 
                this.video = document.getElementById('player'); 
                // Error listener para recuperar "Tela Preta"
                this.video.addEventListener('error', function(e) { PlayerEngine.handleError(); }, true);
            },
            play: function(url, isLive) {
                if(this.url === url && !this.video.paused) return;
                this.stop(); this.url = url; this.retry = 0;
                this.video.controls = false;
                
                // Converte .ts para .m3u8 se necessário (Melhora compatibilidade)
                if(isLive && url.indexOf('.m3u8') === -1 && url.indexOf('.ts') > -1) url = url.replace('.ts', '.m3u8');
                
                App.osd("CARREGANDO...");

                // MÉTODOS DE REPRODUÇÃO
                // 1. Tentar Hls.js (Melhor para PCs e Chrome)
                if (Hls.isSupported()) {
                    var config = { enableWorker: true, maxBufferLength: 30, manifestLoadingTimeOut: 10000 };
                    this.hls = new Hls(config);
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, function() { PlayerEngine.video.play().catch(e=>console.log(e)); });
                    this.hls.on(Hls.Events.ERROR, function(event, data) {
                        if(data.fatal) { PlayerEngine.handleError(); }
                    });
                } 
                // 2. Tentar Nativo (Smart TVs Samsung/LG, Safari, iOS)
                else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
                    this.video.src = url;
                    this.video.play().catch(e => PlayerEngine.handleError());
                }
                // 3. Fallback genérico
                else {
                    this.video.src = url;
                    this.video.play();
                }
            },
            handleError: function() {
                this.retry++;
                if(this.retry > 2) { 
                    App.osd("FALHA DE SINAL"); 
                    return; 
                }
                App.osd("RECONECTANDO ("+this.retry+")...");
                // Tenta reiniciar com delay
                setTimeout(function(){ 
                    if(PlayerEngine.hls) PlayerEngine.hls.recoverMediaError();
                    else PlayerEngine.video.load();
                }, 1000);
            },
            stop: function() { 
                if(this.hls) { this.hls.destroy(); this.hls = null; } 
                if(this.video) { this.video.pause(); this.video.removeAttribute('src'); this.video.load(); } 
            }
        };

        var FavManager = {
            key: 'gold_favs_v6', list: [],
            init: function() { var s = localStorage.getItem(this.key); this.list = s ? JSON.parse(s) : []; },
            toggle: function(id) {
                var idx = this.list.indexOf(id); if(idx > -1) this.list.splice(idx, 1); else this.list.push(id);
                localStorage.setItem(this.key, JSON.stringify(this.list)); if(App.idx < App.fullData.length) App.renderList(true);
            },
            isFav: function(id) { return this.list.indexOf(id) > -1; }
        };

        var App = {
            scr: 0, zone: 0, idx: 0, lastCatIdx: 0, creds: {}, fullData: [], globalData: null, isFolder: false, seriesEps: [], playingId: null,

            init: function() {
                FavManager.init();
                if(localStorage.getItem('gold_h')) {
                    document.getElementById('i0').value = localStorage.getItem('gold_h');
                    document.getElementById('i1').value = localStorage.getItem('gold_u');
                    document.getElementById('i2').value = localStorage.getItem('gold_p');
                }
                PlayerEngine.init();
                document.getElementById('player').onended = function() { 
                    if(App.mode==='series' && App.isFolder && App.idx < App.seriesEps.length-1) {
                        App.idx++; App.updateFocus(); App.playStream(App.seriesEps[App.idx]);
                    } else App.exitFull(); 
                };
                setInterval(this.updateClock, 1000); this.updateClock(); this.updateFocus();
            },

            updateClock: function() {
                var now = new Date();
                document.getElementById('clock-time').innerText = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
                document.getElementById('clock-date').innerText = now.toLocaleDateString('pt-BR');
            },
            formatDate: function(ts) { if(!ts) return 'N/A'; return new Date(ts*1000).toLocaleDateString('pt-BR'); },
            req: function(url, cb) {
                var x = new XMLHttpRequest(); x.open("GET", url, true); x.timeout = 25000;
                x.onload = function() { if(x.status===200) { try{cb(JSON.parse(x.responseText));}catch(e){cb(null);} } else cb(null); };
                x.onerror = function(){ cb('ERR_NET'); }; x.send();
            },
            login: function() {
                var h = document.getElementById('i0').value.trim(); var u = document.getElementById('i1').value.trim(); var p = document.getElementById('i2').value.trim();
                if(!h || !u || !p) return;
                if(h.endsWith('/')) h = h.slice(0, -1); if(h.indexOf('http') === -1) h = 'http://' + h;
                document.getElementById('loader').classList.remove('hide');
                this.req(h+"/player_api.php?username="+u+"&password="+p, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d === 'ERR_NET') { document.getElementById('msg-login').innerText = "Erro de Conexão. Verifique CORS ou URL."; return; }
                    if(d && d.user_info && d.user_info.auth==1) {
                        App.creds={h:h,u:u,p:p}; localStorage.setItem('gold_h', h); localStorage.setItem('gold_u', u); localStorage.setItem('gold_p', p); 
                        
                        var i = d.user_info;
                        document.getElementById('display-user').innerText = i.username;
                        document.getElementById('info-created').innerText = App.formatDate(i.created_at);
                        document.getElementById('info-exp').innerText = (i.exp_date && i.exp_date!="null") ? App.formatDate(i.exp_date) : "Ilimitado";
                        document.getElementById('info-conn').innerText = (i.active_cons||0) + " / " + (i.max_connections||1);
                        
                        App.setScr(1);
                    } else document.getElementById('msg-login').innerText="Dados Inválidos";
                });
            },
            logout: function() { localStorage.clear(); location.reload(); },
            setScr: function(n) {
                if(n===1) PlayerEngine.stop();
                document.querySelectorAll('.layer').forEach(function(l){l.classList.add('hide')});
                if(n===0) document.getElementById('login-layer').classList.remove('hide');
                if(n===1) document.getElementById('dash-layer').classList.remove('hide');
                if(n===2) document.getElementById('content-layer').classList.remove('hide');
                this.scr=n; this.zone=0; this.idx=0; this.updateFocus();
            },
            openMode: function(m) {
                PlayerEngine.stop(); this.resetInfo(); this.mode = m; this.setScr(2); this.isFolder = false; this.globalData = null; this.playingId = null;
                document.getElementById('cat-list').innerHTML = ''; document.getElementById('item-list').innerHTML = '';
                document.getElementById('loader').classList.remove('hide'); document.getElementById('search').value = '';
                var act = (m==='live')?'get_live_categories':(m==='movie'?'get_vod_categories':'get_series_categories');
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                    document.getElementById('loader').classList.add('hide');
                    if(d && d!=='ERR_NET') {
                        var h = '<div class="cat-item" id="c0" data-id="fav" onclick="App.catClick(0)">★ FAVORITOS</div>';
                        for(var i=0;i<d.length;i++) h += '<div class="cat-item" id="c'+(i+1)+'" data-id="'+d[i].category_id+'" onclick="App.catClick('+(i+1)+')">'+d[i].category_name+'</div>';
                        document.getElementById('cat-list').innerHTML = h; App.zone=0; App.idx=0; App.updateFocus();
                    }
                });
            },
            resetInfo: function() {
                document.getElementById('meta-title').innerText = "R&C GOLD"; document.getElementById('meta-desc').innerText = "Selecione um canal para assistir.";
                document.getElementById('meta-epg').classList.add('hide'); var v = document.getElementById('player'); v.removeAttribute('src'); v.load();
            },
            catClick: function(i) { this.idx=i; this.zone=0; this.loadContent(i); },
            loadContent: function(catIdx) {
                this.lastCatIdx = catIdx; var el = document.getElementById('c'+catIdx); if(!el) return;
                var cid = el.getAttribute('data-id'); document.querySelectorAll('.cat-item').forEach(function(e){e.classList.remove('active')}); el.classList.add('active');
                document.getElementById('search').value = ''; document.getElementById('loader').classList.remove('hide'); document.getElementById('item-list').innerHTML = '';
                var onData = function(d) {
                    document.getElementById('loader').classList.add('hide'); if(d && d!=='ERR_NET') { App.fullData = d; App.isFolder = false; App.renderList(); }
                };
                if(cid === 'fav') {
                     var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                     this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act, function(d){
                        if(d && d!=='ERR_NET') { App.fullData = d.filter(function(x){ return FavManager.isFav(x.stream_id || x.series_id); }); App.isFolder=false; App.renderList(); }
                        document.getElementById('loader').classList.add('hide');
                     });
                } else {
                    var act = (this.mode==='live')?'get_live_streams':(this.mode==='movie'?'get_vod_streams':'get_series');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+act+"&category_id="+cid, onData);
                }
            },
            renderList: function(keepIdx) {
                var d = this.fullData; var max = d.length > 500 ? 500 : d.length; 
                if(max===0) { document.getElementById('item-list').innerHTML = '<div style="padding:20px;color:#666">Nenhum conteúdo.</div>'; return; }
                var h = '';
                for(var i=0; i<max; i++) {
                    var n = d[i].name || d[i].title; var id = d[i].stream_id || d[i].series_id;
                    var icn = FavManager.isFav(id) ? '<i class="fas fa-star fav-icon" style="float:right;color:var(--gold-main)"></i>' : '';
                    h += '<div class="item" id="row-'+i+'" onclick="App.itemClick('+i+')">'+n+icn+'</div>';
                }
                document.getElementById('item-list').innerHTML = h; this.zone = 2; if(!keepIdx) { this.idx = 0; } this.updateFocus();
            },
            itemClick: function(i) { this.idx=i; this.zone=2; this.clickItem(); },
            clickItem: function() {
                if(this.isFolder) { this.playStream(this.seriesEps[this.idx]); return; }
                var item = this.fullData[this.idx]; if(this.mode !== 'series') { if(item) this.playStream(item); return; }
                if(item) {
                    var midx = this.idx;
                    document.getElementById('loader').classList.remove('hide');
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_series_info&series_id="+item.series_id, function(d){
                        document.getElementById('loader').classList.add('hide');
                        if(d && d.episodes) {
                            var eps = []; for(var k in d.episodes) for(var j=0; j<d.episodes[k].length; j++) eps.push(d.episodes[k][j]);
                            App.seriesEps = eps; App.fullData = eps; App.isFolder = true; App.memIdx = midx; App.renderList();
                            document.getElementById('meta-title').innerText = (item.name || item.title); document.getElementById('meta-desc').innerText = "Selecione o episódio.";
                        }
                    });
                }
            },
            playStream: function(item) {
                var ext = (this.mode==='live')?'ts':(item.container_extension||'mp4');
                var type = (this.mode==='live')?'live':(this.mode==='movie'?'movie':'series');
                var id = item.stream_id || item.id;
                var url = this.creds.h+"/"+type+"/"+this.creds.u+"/"+this.creds.p+"/"+id+"."+ext;
                this.playingId = id; 
                document.getElementById('meta-title').innerText = item.name || item.title; document.getElementById('meta-desc').innerText = "Carregando sinal..."; document.getElementById('meta-epg').classList.add('hide');
                
                if(this.mode === 'live') {
                    this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_short_epg&stream_id="+id, function(d){
                        if(d && d.epg_listings && d.epg_listings.length > 0) {
                            var t = d.epg_listings[0].title; try { if(window.atob && /^[A-Za-z0-9+/=]+$/.test(t)) t=atob(t); }catch(e){}
                            document.getElementById('meta-epg').innerText = t; document.getElementById('meta-epg').classList.remove('hide');
                            document.getElementById('meta-desc').innerText = d.epg_listings[0].description || "";
                        }
                    });
                }
                PlayerEngine.play(url, this.mode==='live');
                document.querySelectorAll('.item').forEach(function(e){e.classList.remove('playing')});
                var r = document.getElementById('row-'+this.idx); if(r) r.classList.add('playing');
            },
            doSearch: function() {
                var t = document.getElementById('search').value.toLowerCase(); if(t.length < 2) return;
                document.getElementById('item-list').innerHTML = '<div style="padding:20px;color:var(--gold-main)">Buscando...</div>';
                var cb = function(d) {
                    if(d && d!=='ERR_NET') { 
                        App.fullData = d.filter(function(x){ return (x.name||x.title||"").toLowerCase().indexOf(t) > -1 }); 
                        App.isFolder = false; App.renderList(); App.zone = 2; App.idx = 0; App.updateFocus();
                    }
                };
                if(App.globalData) cb(App.globalData); else {
                    var act = (App.mode==='live')?'get_live_streams':(App.mode==='movie'?'get_vod_streams':'get_series');
                    App.req(App.creds.h+"/player_api.php?username="+App.creds.u+"&password="+App.creds.p+"&action="+act, function(d){ App.globalData=d; cb(d); });
                }
            },
            toggleFull: function() {
                var b = document.getElementById('vid-box');
                if(b.classList.contains('fs')) { b.classList.remove('fs'); this.syncFocus(); } else { b.classList.add('fs'); App.osd("TELA CHEIA"); }
            },
            osd: function(t) { var o=document.getElementById('osd'); o.innerText=t; o.style.display='block'; setTimeout(function(){o.style.display='none'},2500); },
            syncFocus: function() {
                if(!this.playingId) return;
                for(var i=0; i<this.fullData.length; i++) {
                    var id = this.fullData[i].stream_id || this.fullData[i].series_id || this.fullData[i].id;
                    if(id == this.playingId) { this.idx = i; this.updateFocus(); return; }
                }
            },
            back: function() {
                if(document.getElementById('vid-box').classList.contains('fs')) { this.toggleFull(); return; }
                if(this.zone===3) { this.zone=2; this.syncFocus(); this.updateFocus(); return; }
                if(this.zone===2 && this.isFolder) {
                    this.isFolder = false; 
                    // Recarregar lista original
                    var act = (App.mode==='live')?'get_live_streams':(App.mode==='movie'?'get_vod_streams':'get_series');
                    var cid = document.querySelector('.cat-item.active').getAttribute('data-id');
                    App.loadContent(App.lastCatIdx); // Recarrega categoria simples
                    return; 
                }
                if(this.zone===2) { this.zone=0; this.idx=this.lastCatIdx; this.updateFocus(); return; }
                if(this.zone===1) { this.zone=2; this.idx=0; this.updateFocus(); return; }
                if(this.zone===0) { this.setScr(1); return; }
            },
            updateFocus: function() {
                document.querySelectorAll('.focused').forEach(function(e){e.classList.remove('focused')});
                var el;
                if(this.scr===0) el=document.getElementById('i'+this.idx);
                if(this.scr===1) { if(this.idx==3) el=document.getElementById('m3'); else el=document.getElementById('m'+this.idx); }
                if(this.scr===2) {
                    if(this.zone===0) el=document.getElementById('c'+this.idx);
                    if(this.zone===1) el=document.getElementById('search');
                    if(this.zone===2) el=document.getElementById('row-'+this.idx);
                    if(this.zone===3) el=document.getElementById('vid-box');
                }
                if(el) {
                    el.classList.add('focused'); if(el.tagName==='INPUT') el.focus(); else document.activeElement.blur();
                    el.scrollIntoView({block:'center',behavior:'smooth'}); 
                }
            },
            move: function(d) {
                if(this.scr===0) { if(d===1&&this.idx<3) this.idx++; if(d===0&&this.idx>0) this.idx--; }
                if(this.scr===1) { if(this.idx <= 2) { if(d===3 && this.idx<2) this.idx++; if(d===2 && this.idx>0) this.idx--; if(d===0) { this.idx = 3; } } else if(this.idx === 3) { if(d===1) { this.idx = 1; } } }
                if(this.scr===2) {
                    if(this.zone===3) { if(d===2) { this.zone=2; this.syncFocus(); this.updateFocus(); } return; }
                    if(this.zone===0) { 
                        var max = document.getElementById('cat-list').children.length-1;
                        if(d===1 && this.idx<max) this.idx++; if(d===0 && this.idx>0) this.idx--; if(d===3 && App.fullData.length>0) { this.zone=2; this.idx=0; }
                    }
                    else if(this.zone===2) { 
                        var max = document.getElementById('item-list').children.length-1;
                        if(d===1 && this.idx<max) this.idx++; else if(d===0) { if(this.idx > 0) this.idx--; else this.zone = 1; } else if(d===2) { this.zone=0; this.idx=this.lastCatIdx; } else if(d===3) this.zone=3; 
                    }
                    else if(this.zone===1) { if(d===1) { this.zone=2; this.idx=0; } if(d===2) { this.zone=0; this.idx=this.lastCatIdx; } }
                }
                this.updateFocus();
            },
            enter: function() {
                if(this.scr===0) this.login();
                if(this.scr===1) { if(this.idx === 3) this.logout(); else this.openMode(['live','movie','series'][this.idx]); }
                if(this.scr===2) {
                    if(this.zone===0) this.loadContent(this.idx); if(this.zone===1) this.doSearch(); if(this.zone===2) this.clickItem(); if(this.zone===3) this.toggleFull(); 
                }
            }
        };

        document.addEventListener('keydown', function(e) {
            var k=e.keyCode;
            if(document.activeElement.tagName === 'INPUT') {
                if(App.scr === 0 && k === 13) { e.preventDefault(); App.login(); return; } 
                if(App.scr === 2 && k === 13) { App.doSearch(); return; } 
                if(k === 40) { e.preventDefault(); if(App.scr===2){App.zone=2;App.idx=0;App.updateFocus();} else App.move(1); return; } 
                if(k === 38 && App.scr===0) { e.preventDefault(); App.move(0); return; }
                return; 
            }
            if(k===13 && App.scr===0 && App.idx===3) { e.preventDefault(); App.login(); return; }
            if(document.getElementById('vid-box').classList.contains('fs')) { 
                e.preventDefault(); if(k===13||k===403||k===27||k===461||k===10009) App.toggleFull(); return; 
            }
            if(k===48 || k===96) if(App.scr===2 && App.zone===2) { var it=App.fullData[App.idx]; if(it) FavManager.toggle(it.stream_id||it.series_id); }
            if(k===37) { e.preventDefault(); App.move(2); } if(k===38) { e.preventDefault(); App.move(0); }
            if(k===39) { e.preventDefault(); App.move(3); } if(k===40) { e.preventDefault(); App.move(1); }
            if(k===13) { e.preventDefault(); App.enter(); }
            if(k===8||k===27||k===461||k===10009) { e.preventDefault(); if(App.scr>0) App.back(); }
        });
    </script>
</body>
</html>
