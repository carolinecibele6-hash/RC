<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R&C VIP PLAYER</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- TEMA VIP PERFORMANCE (Visual Warez/Neon) --- */
        :root { 
            --bg: #050505; 
            --panel: #111111;
            --primary: #00ff6a; /* Verde Neon estilo Warez */
            --primary-dim: #004d20;
            --text: #ffffff;
            --text-gray: #888888;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); 
            color: var(--text);
            font-family: 'Inter', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
            /* Gradiente leve e barato para processar */
            background: linear-gradient(180deg, #0a0a0a 0%, #000000 100%);
        }

        .hide { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: var(--bg); }

        /* ESTADO DE FOCO OTIMIZADO (Borda Sólida = +FPS) */
        .focused {
            border: 3px solid var(--primary) !important;
            background: var(--primary-dim) !important;
            color: #fff !important;
            transform: scale(1.02); /* Scale leve usa GPU */
            box-shadow: none !important; /* Sombra removida para performance */
            z-index: 50;
        }
        
        .focused i { color: var(--primary) !important; }
        .focused input { background: #000 !important; color: #fff !important; }

        /* LOGIN */
        .login-box { 
            width: 400px; max-width: 90%; padding: 40px; 
            background: var(--panel); border: 1px solid #222; 
            border-radius: 8px; text-align: center; 
        }
        .logo-txt { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 20px; }
        .logo-txt span { color: var(--primary); }
        .inp { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; text-align: center; border-radius: 4px; font-size: 16px; }
        .btn { width: 100%; padding: 14px; margin-top: 20px; background: var(--primary); color: #000; border: none; font-weight: 900; border-radius: 4px; font-size: 16px; text-transform: uppercase; }
        .btn.focused { background: #fff !important; color: #000 !important; border: 3px solid var(--primary) !important; }

        /* DASHBOARD (3 CARDS GRANDES) */
        #dash-layer { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .top-info { position: absolute; top: 30px; left: 40px; }
        .clock { position: absolute; top: 30px; right: 40px; text-align: right; font-weight: 700; color: var(--primary); font-size: 24px; }
        .exp-date { font-size: 14px; color: #666; margin-top: 5px; }

        .dash-grid { display: flex; gap: 30px; }
        .smart-card { 
            width: 220px; height: 260px;
            background: var(--panel);
            border: 2px solid #222;
            border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.15s;
        }
        .smart-card i { font-size: 60px; margin-bottom: 20px; color: #444; }
        .smart-card span { font-size: 18px; font-weight: 700; color: #fff; }
        
        /* CARD FOCADO */
        .smart-card.focused { background: #1a1a1a !important; border-color: var(--primary) !important; }
        .smart-card.focused i { color: var(--primary) !important; }

        /* CONTEÚDO */
        #content-layer { display: flex; height: 100vh; }
        
        /* COLUNA CATEGORIAS */
        .col-cat { width: 280px; background: #080808; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .cat-head { padding: 20px; font-weight: 900; color: var(--primary); font-size: 20px; text-align: center; border-bottom: 1px solid #222; }
        .cat-list { flex: 1; overflow-y: auto; padding-top: 10px; }
        .cat-item { padding: 12px 20px; color: #888; font-size: 14px; font-weight: 600; border-left: 4px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-item.active { background: #111; color: #fff; border-left-color: var(--primary); }
        .cat-item.focused { border-left-color: #fff !important; }

        /* COLUNA LISTA */
        .col-list { width: 350px; background: #111; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .search-box { padding: 15px; border-bottom: 1px solid #222; }
        .inp-search { width: 100%; background: #000; border: 1px solid #333; padding: 10px; color: #fff; text-align: center; border-radius: 4px; text-transform: uppercase; }
        .item-list { flex: 1; overflow-y: auto; }
        .item { padding: 12px 20px; border-bottom: 1px solid #1a1a1a; color: #bbb; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item.playing { color: var(--primary); font-weight: bold; background: #0f1f15; }
        
        /* PLAYER AREA */
        .col-play { flex: 1; background: #000; display: flex; flex-direction: column; position: relative; }
        .vid-wrapper { width: 100%; height: 50%; background: #000; position: relative; border-bottom: 2px solid #222; }
        video { width: 100%; height: 100%; background: #000; }
        
        /* METADADOS */
        .meta { padding: 30px; flex: 1; background: #0a0a0a; overflow: hidden; }
        .meta-title { font-size: 26px; font-weight: 800; color: #fff; margin-bottom: 10px; }
        .meta-sub { font-size: 14px; color: var(--primary); margin-bottom: 15px; font-weight: bold; }
        .meta-desc { color: #666; font-size: 14px; line-height: 1.5; max-height: 100px; overflow: hidden; }
        
        /* TELA CHEIA */
        .fs-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; border: none; }
        
        /* OSD DE STATUS */
        #osd { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: var(--primary); padding: 8px 15px; border: 1px solid var(--primary); border-radius: 4px; font-weight: bold; font-size: 14px; display: none; z-index: 1000; }

        /* SCROLLBAR OTIMIZADO */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        
        #loader { background: rgba(0,0,0,0.95); z-index: 20000; flex-direction: column; color: var(--primary); }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="hide flex-center">
        <i class="fas fa-circle-notch fa-spin" style="font-size:40px; margin-bottom:20px"></i>
        <div style="font-weight:900; letter-spacing:1px">CARREGANDO...</div>
    </div>

    <div id="login-layer" class="layer flex-center">
        <div class="login-box">
            <div class="logo-txt">R&C <span>VIP</span></div>
            <input type="text" id="i0" class="inp focusable" placeholder="URL DNS (http://...)" autocomplete="off">
            <input type="text" id="i1" class="inp focusable" placeholder="USUÁRIO" autocomplete="off">
            <input type="password" id="i2" class="inp focusable" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn focusable" onclick="App.login()">ENTRAR</button>
            <div id="msg-login" style="color:#ff4444; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div id="dash-layer" class="layer hide">
        <div class="top-info">
            <div class="logo-txt" style="font-size:24px; margin:0">R&C <span>VIP</span></div>
            <div id="info-exp" class="exp-date">Vencimento: ...</div>
        </div>
        <div class="clock" id="clock">12:00</div>

        <div class="dash-grid">
            <div id="m0" class="smart-card focusable" onclick="App.openMode('live')">
                <i class="fas fa-tv"></i><span>TV AO VIVO</span>
            </div>
            <div id="m1" class="smart-card focusable" onclick="App.openMode('movie')">
                <i class="fas fa-film"></i><span>FILMES</span>
            </div>
            <div id="m2" class="smart-card focusable" onclick="App.openMode('series')">
                <i class="fas fa-layer-group"></i><span>SÉRIES</span>
            </div>
            <div id="m3" class="smart-card focusable" onclick="App.logout()">
                <i class="fas fa-power-off" style="color:#ff4444"></i><span>SAIR</span>
            </div>
        </div>
    </div>

    <div id="content-layer" class="layer hide">
        <div class="col-cat">
            <div class="cat-head">CATEGORIAS</div>
            <div id="cat-list" class="cat-list"></div>
        </div>
        <div class="col-list">
            <div class="search-box">
                <input type="text" id="search" class="inp-search focusable" placeholder="BUSCAR..." autocomplete="off">
            </div>
            <div id="item-list" class="item-list"></div>
        </div>
        <div class="col-play">
            <div id="vid-wrapper" class="vid-wrapper focusable">
                <video id="player" playsinline webkit-playsinline></video>
                <div id="osd">BUFFERING...</div>
            </div>
            <div class="meta">
                <div id="meta-title" class="meta-title">Selecione um canal</div>
                <div id="meta-epg" class="meta-sub"></div>
                <div id="meta-desc" class="meta-desc">Use as setas para navegar. OK para selecionar.</div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO ANTI-TRAVAMENTO PHILCO
        // Ajustado para baixo consumo de memória
        var HlsConfig = {
            enableWorker: true,
            maxBufferLength: 10,       // Original era 30. 10 é seguro para pouca RAM.
            maxMaxBufferLength: 20,    // Teto máximo reduzido.
            maxBufferHole: 0.5,
            backBufferLength: 0,       // Não guardar buffer antigo (libera RAM).
            capLevelToPlayerSize: true,// Economiza GPU.
            startLevel: -1,
            manifestLoadingTimeOut: 15000,
        };

        var Player = {
            hls: null, 
            el: null, 
            url: null,
            init: function() {
                this.el = document.getElementById('player');
                this.el.onerror = () => App.osd("Erro de Reprodução");
            },
            play: function(url, isLive) {
                this.destroy();
                this.url = url;
                
                // Converte .ts para .m3u8 se necessário (mais estável)
                if(isLive && url.indexOf('.m3u8') === -1 && url.indexOf('.ts') > -1) {
                    url = url.replace('.ts', '.m3u8');
                }

                if(Hls.isSupported()) {
                    this.hls = new Hls(HlsConfig);
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.el);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        this.el.play().catch(e=>console.log(e));
                    });
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        if(data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    this.hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    this.hls.recoverMediaError();
                                    break;
                                default:
                                    this.destroy();
                                    break;
                            }
                        }
                    });
                } else if (this.el.canPlayType('application/vnd.apple.mpegurl')) {
                    // Fallback nativo (Samsung/LG antigo, algumas Philco usam isso)
                    this.el.src = url;
                    this.el.play();
                }
            },
            destroy: function() {
                if(this.hls) { this.hls.destroy(); this.hls = null; }
                this.el.pause();
                this.el.removeAttribute('src'); // Limpeza crítica de memória
                this.el.load();
            },
            toggleFull: function() {
                var w = document.getElementById('vid-wrapper');
                if(w.classList.contains('fs-mode')) {
                    w.classList.remove('fs-mode');
                    App.osd("MODO JANELA");
                } else {
                    w.classList.add('fs-mode');
                    App.osd("TELA CHEIA");
                }
            }
        };

        var App = {
            scr: 0, // 0:Login, 1:Dash, 2:Content
            zone: 0, // Zonas de foco
            idx: 0,
            creds: {h:'', u:'', p:''},
            data: [],
            fullData: [], // Backup para busca
            
            init: function() {
                if(localStorage.getItem('vp_h')) {
                    document.getElementById('i0').value = localStorage.getItem('vp_h');
                    document.getElementById('i1').value = localStorage.getItem('vp_u');
                    document.getElementById('i2').value = localStorage.getItem('vp_p');
                }
                Player.init();
                setInterval(() => {
                    var d = new Date();
                    document.getElementById('clock').innerText = d.getHours() + ':' + (d.getMinutes()<10?'0':'') + d.getMinutes();
                }, 1000);
                this.updateFocus();
            },

            req: function(url, cb) {
                var x = new XMLHttpRequest();
                x.open("GET", url, true);
                x.timeout = 15000; // Timeout menor para não travar UI
                x.onload = function() { 
                    if(x.status===200) { try{cb(JSON.parse(x.responseText))}catch(e){cb(null)} } 
                    else cb(null); 
                };
                x.onerror = function() { cb(null); };
                x.send();
            },

            login: function() {
                var h = document.getElementById('i0').value.trim();
                var u = document.getElementById('i1').value.trim();
                var p = document.getElementById('i2').value.trim();
                if(!h.startsWith('http')) h = 'http://' + h;
                
                this.loading(true);
                this.req(h+"/player_api.php?username="+u+"&password="+p, (d) => {
                    this.loading(false);
                    if(d && d.user_info && d.user_info.auth==1) {
                        this.creds = {h:h, u:u, p:p};
                        localStorage.setItem('vp_h', h); localStorage.setItem('vp_u', u); localStorage.setItem('vp_p', p);
                        
                        var exp = d.user_info.exp_date ? new Date(d.user_info.exp_date*1000).toLocaleDateString("pt-BR") : "Ilimitado";
                        document.getElementById('info-exp').innerText = "Vencimento: " + exp;
                        
                        this.setScr(1);
                    } else {
                        document.getElementById('msg-login').innerText = "Erro: Verifique os dados!";
                    }
                });
            },
            logout: function() { localStorage.clear(); location.reload(); },

            setScr: function(n) {
                document.querySelectorAll('.layer').forEach(e => e.classList.add('hide'));
                if(n===0) document.getElementById('login-layer').classList.remove('hide');
                if(n===1) {
                    Player.destroy();
                    document.getElementById('dash-layer').classList.remove('hide');
                }
                if(n===2) document.getElementById('content-layer').classList.remove('hide');
                this.scr = n; this.zone = 0; this.idx = 0; this.updateFocus();
            },

            openMode: function(mode) {
                this.mode = mode;
                this.setScr(2);
                this.loading(true);
                
                var action = (mode==='live') ? 'get_live_categories' : (mode==='movie' ? 'get_vod_categories' : 'get_series_categories');
                
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+action, (d) => {
                    this.loading(false);
                    if(d) {
                        var h = '';
                        // Limitar categorias se tiver muitas para não travar renderização
                        d.forEach((c, i) => {
                            h += `<div class="cat-item" id="c${i}" data-id="${c.category_id}" onclick="App.clickCat(${i})">${c.category_name}</div>`;
                        });
                        document.getElementById('cat-list').innerHTML = h;
                        this.catData = d;
                        this.zone = 0; this.idx = 0; this.updateFocus();
                    }
                });
            },

            clickCat: function(i) {
                this.idx = i; this.zone = 0;
                var cid = this.catData[i].category_id;
                
                // UI update
                document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active'));
                document.getElementById('c'+i).classList.add('active');

                this.loading(true);
                var action = (this.mode==='live') ? 'get_live_streams' : (this.mode==='movie' ? 'get_vod_streams' : 'get_series');
                
                this.req(this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action="+action+"&category_id="+cid, (d) => {
                    this.loading(false);
                    if(d) {
                        this.fullData = d;
                        this.renderList(d);
                    }
                });
            },

            renderList: function(list) {
                this.data = list;
                var h = '';
                // OTIMIZAÇÃO: Renderizar no máximo 100 itens por vez para não travar Philco
                var max = list.length > 100 ? 100 : list.length;
                
                for(var i=0; i<max; i++) {
                    var name = list[i].name || list[i].title;
                    h += `<div class="item" id="r${i}" onclick="App.playItem(${i})">${name}</div>`;
                }
                document.getElementById('item-list').innerHTML = h;
                this.zone = 2; this.idx = 0; this.updateFocus();
            },

            playItem: function(i) {
                var item = this.data[i];
                var id = item.stream_id || item.series_id;
                var ext = (this.mode==='live') ? 'ts' : (item.container_extension || 'mp4');
                
                document.getElementById('meta-title').innerText = item.name || item.title;
                document.querySelectorAll('.item').forEach(e=>e.classList.remove('playing'));
                document.getElementById('r'+i).classList.add('playing');

                if(this.mode === 'series') {
                    // Lógica simplificada para séries (Play direto não implementado no demo simples)
                    App.osd("Séries: Selecione episódios (Simplificado)");
                    return; 
                }

                var url = `${this.creds.h}/${this.mode}/${this.creds.u}/${this.creds.p}/${id}.${ext}`;
                Player.play(url, this.mode==='live');
            },

            doSearch: function() {
                var q = document.getElementById('search').value.toLowerCase();
                if(q.length < 2) return;
                var res = this.fullData.filter(i => (i.name || i.title).toLowerCase().includes(q));
                this.renderList(res);
            },

            // Navegação e Controle
            move: function(d) {
                // Lógica de Grid Simplificada
                if(this.scr === 1) { // Dash
                    if(d===1 && this.idx<3) this.idx++; // Dir
                    if(d===3 && this.idx>0) this.idx--; // Esq
                }
                else if(this.scr === 2) { // Content
                    if(this.zone === 0) { // Categorias
                        var max = document.getElementById('cat-list').children.length - 1;
                        if(d===2 && this.idx<max) this.idx++; // Baixo
                        if(d===0 && this.idx>0) this.idx--; // Cima
                        if(d===1) { this.zone=2; this.idx=0; } // Vai pra lista
                    }
                    else if(this.zone === 2) { // Lista
                        var max = document.getElementById('item-list').children.length - 1;
                        if(d===2 && this.idx<max) this.idx++;
                        if(d===0) { 
                            if(this.idx>0) this.idx--; 
                            else { this.zone=1; } // Vai pra busca
                        }
                        if(d===3) { this.zone=0; this.idx=0; } // Volta cat
                        if(d===1) { this.zone=3; } // Vai pro player
                    }
                    else if(this.zone === 1) { // Busca
                         if(d===2) { this.zone=2; this.idx=0; }
                         if(d===3) { this.zone=0; this.idx=0; }
                    }
                    else if(this.zone === 3) { // Player
                        if(d===3) { this.zone=2; this.idx=0; } // Volta lista
                    }
                }
                this.updateFocus();
            },

            enter: function() {
                if(this.scr===0) this.login();
                else if(this.scr===1) {
                    if(this.idx===3) this.logout();
                    else this.openMode(['live','movie','series'][this.idx]);
                }
                else if(this.scr===2) {
                    if(this.zone===0) this.clickCat(this.idx);
                    else if(this.zone===2) this.playItem(this.idx);
                    else if(this.zone===1) this.doSearch();
                    else if(this.zone===3) Player.toggleFull();
                }
            },

            back: function() {
                if(document.getElementById('vid-wrapper').classList.contains('fs-mode')) {
                    Player.toggleFull(); return;
                }
                if(this.scr===2) {
                    if(this.zone===3) { this.zone=2; this.updateFocus(); return; }
                    this.setScr(1);
                }
            },

            updateFocus: function() {
                document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused'));
                var el;
                if(this.scr===0) el = document.getElementById('i'+this.idx);
                if(this.scr===1) el = document.getElementById('m'+this.idx);
                if(this.scr===2) {
                    if(this.zone===0) el = document.getElementById('c'+this.idx);
                    if(this.zone===1) el = document.getElementById('search');
                    if(this.zone===2) el = document.getElementById('r'+this.idx);
                    if(this.zone===3) el = document.getElementById('vid-wrapper');
                }
                if(el) {
                    el.classList.add('focused');
                    el.scrollIntoView({block: 'center', behavior: 'auto'}); // 'auto' é mais leve que 'smooth'
                    if(el.tagName==='INPUT') el.focus(); else document.activeElement.blur();
                }
            },

            osd: function(msg) {
                var o = document.getElementById('osd');
                o.innerText = msg; o.style.display = 'block';
                setTimeout(() => o.style.display='none', 3000);
            },
            
            loading: function(show) {
                if(show) document.getElementById('loader').classList.remove('hide');
                else document.getElementById('loader').classList.add('hide');
            }
        };

        // CONTROLES DE TECLADO / REMOTO
        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            
            // Mapeamento Teclas TV
            if(k===37) App.move(3); // Esq
            if(k===38) App.move(0); // Cima
            if(k===39) App.move(1); // Dir
            if(k===40) App.move(2); // Baixo
            if(k===13) App.enter(); // Enter
            if(k===8 || k===27 || k===461 || k===10009) App.back(); // Voltar

            // Inputs
            if(document.activeElement.tagName === 'INPUT') {
                if(k===40) { e.preventDefault(); if(App.scr===2) App.move(2); else App.idx++; App.updateFocus(); }
                if(k===38 && App.scr===0) { e.preventDefault(); App.idx--; App.updateFocus(); }
                if(k===13) { App.enter(); }
                return;
            }
            e.preventDefault(); // Previne scroll da página
        });
    </script>
</body>
</html>
